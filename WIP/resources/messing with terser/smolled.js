var printStack=!0,clickDebug=!0,showDev=!0,showFPS=!0;clickDebug=!1,showDev=!1,showFPS=!1;var backupObject,bgGrid,widthOnTwo,heightOnTwo,cells,c,shareLinkString,pres,xPos,yPos,xStart,yStart,xOff,yOff,doMouseDrag,mobileHType,mainDiv,B_UNSET=0,B_TRUE=1,B_FALSE=2,RM_NORMAL=0,RM_CREATE=1,RM_PRESENT=2,M_IDLE=0,M_MOVE=1,M_RESIZE=2,M_DELETE=3,M_SELECTED=4,M_EXPAND_OR_COLLAPSE=5,M_START=6,M_NEW=7,M_COPY=8,M_MUTATE=9,V_NUMBER=0,V_STRING=1,V_BOOL=2,TST_OFF=0,TST_LOAD=1,TST_TIDY=2,TST_RUN=3,TST_PAUSE=4,T_START=1,T_STOP=105,T_COMMENT=3,T_BLOCK=23,T_LEN=6,T_GET=8,T_RUN=53,T_SET=10,T_VAR=45,T_INPUT=47,T_CONST=46,T_IF=30,T_WHILE=7,T_EQUAL=48,T_LESS=9,T_GREATER=38,T_ADD=11,T_SUBTRACT=52,T_MULT=13,T_DIV=14,T_MOD=32,T_AVERAGE=33,T_SQRT=34,T_HYPOT=35,T_GOTO=16,T_NOT=28,T_COS=24,T_SIN=26,T_CONDITION=103,T_RANGE=150,T_ELSE=102,T_DO=101,T_OUTLET=104,T_ASSIGN=42,T_CONSOLE=2,T_PRINT=27,T_TURTLE=0,T_INLET=201,T_ROUND=4,T_PUSH=41,T_DELETE=44,T_FOR=51,T_INDEX=222,T_REF=223,T_LAYOUT_BLOCK=666,zoomMode=!1,mobileDeviceDetected=!1,selectChanged=!0,fontSizeString="12px",doJLOG=!1,doJLOGCountDown=0,myDivs={},allColors={},showBlockMenu=!1,showDemoMenu=!1,showUtils=!1,shareLinkGenerated=!1,slowMode=!1,fastMode=!1,speedMode=0,flash=!0,gridSize=20,demos=[],mobileHAddon=!1,tidyFlag=0,expandMenu=!0,submenu=0,currentTestIndex=0,testPacer=0,testPaceSettings=[0,0,0,500,500],testTimer=TST_OFF,testLoop=!1,tutorial=!1,tutorialstring="",hideMenu=!1,disableDrag=!1;let logCounter=0;var speedButton,flashButton,redrawCounter=0,notIdle=!0,noClickZone=[0,0,0,0],clearCellFlag=0,showGUI=!0,presentationMode=!1,presCreationMode=!1,autoStart=!1,presentationDivs={},runMode=RM_NORMAL,turtleVars=["turtleX","turtleY","turtleDraw"],everyone=[T_COMMENT,T_CONST,T_BLOCK,T_VAR,T_INPUT,T_IF,T_WHILE,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_GOTO,T_NOT,T_CONDITION,T_ELSE,T_DO,T_OUTLET,T_ASSIGN,T_PRINT,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_LEN,T_GET,T_SET,T_START,T_CONSOLE,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],userBlocks=[T_BLOCK,T_GOTO,T_INPUT,T_VAR,T_CONST,T_ASSIGN,T_IF,T_WHILE,T_NOT,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_PRINT,T_COMMENT,T_COS,T_SIN,T_TURTLE,T_LEN,T_GET,T_SET,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],notStartOrConsole=[T_COMMENT,T_CONST,T_VAR,T_IF,T_WHILE,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_GOTO,T_NOT,T_CONDITION,T_ELSE,T_DO,T_OUTLET,T_ASSIGN,T_PRINT,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_LEN,T_GET,T_SET,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],notStartOrConsoleOrSpecial=[T_COMMENT,T_CONST,T_VAR,T_IF,T_WHILE,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_GOTO,T_NOT,T_ASSIGN,T_PRINT,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_LEN,T_GET,T_SET,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],numberyOnes=[T_OUTLET,T_COMMENT,T_CONST,T_VAR,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_COS,T_SIN,T_LEN,T_GET,T_ROUND],boolyOnes=[T_COMMENT,T_NOT,T_EQUAL,T_GREATER,T_LESS],conditionallyOnes=boolyOnes.concat(numberyOnes.slice(1)),presComponents=[T_INPUT,T_CONST],mathFunctions=[T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_ROUND],boolFunctions=[T_NOT,T_EQUAL,T_GREATER,T_LESS],utilities=[T_COMMENT,T_PRINT,T_TURTLE],conditionals=[T_IF,T_WHILE,T_FOR],containers=[T_BLOCK,T_INPUT,T_CONST],handles=[T_GOTO,T_VAR,T_ASSIGN],arrayTools=[T_LEN,T_GET,T_SET,T_PUSH,T_DELETE,T_RUN],blockMenuDict={};blockMenuDict["data containers"]=containers,blockMenuDict["data references"]=handles,blockMenuDict["array tools"]=arrayTools,blockMenuDict.math=mathFunctions,blockMenuDict.comparisons=boolFunctions,blockMenuDict.conditionals=conditionals,blockMenuDict.utilities=utilities;var blockConfig={};blockConfig[T_BLOCK]={},blockConfig[T_GOTO]={},blockConfig[T_VAR]={},blockConfig[T_INPUT]={},blockConfig[T_IF]={},blockConfig[T_WHILE]={},blockConfig[T_EQUAL]={},blockConfig[T_LESS]={},blockConfig[T_GREATER]={},blockConfig[T_ADD]={},blockConfig[T_HYPOT]={},blockConfig[T_AVERAGE]={},blockConfig[T_SQRT]={},blockConfig[T_SUBTRACT]={},blockConfig[T_MULT]={},blockConfig[T_DIV]={},blockConfig[T_MOD]={},blockConfig[T_NOT]={},blockConfig[T_CONDITION]={},blockConfig[T_RANGE]={},blockConfig[T_ELSE]={},blockConfig[T_DO]={},blockConfig[T_OUTLET]={},blockConfig[T_START]={},blockConfig[T_STOP]={},blockConfig[T_ASSIGN]={},blockConfig[T_CONSOLE]={},blockConfig[T_PRINT]={},blockConfig[T_COMMENT]={},blockConfig[T_CONST]={},blockConfig[T_TURTLE]={},blockConfig[T_INLET]={},blockConfig[T_SIN]={},blockConfig[T_COS]={},blockConfig[T_LEN]={},blockConfig[T_GET]={},blockConfig[T_RUN]={},blockConfig[T_SET]={},blockConfig[T_ROUND]={},blockConfig[T_PUSH]={},blockConfig[T_DELETE]={},blockConfig[T_FOR]={},blockConfig[T_INDEX]={},blockConfig[T_REF]={},blockConfig[T_LAYOUT_BLOCK]={},blockConfig[T_BLOCK]["block label"]="block",blockConfig[T_GOTO]["block label"]="block",blockConfig[T_VAR]["block label"]="variable",blockConfig[T_INPUT]["block label"]="variable",blockConfig[T_IF]["block label"]="if",blockConfig[T_WHILE]["block label"]="while",blockConfig[T_EQUAL]["block label"]="equal",blockConfig[T_LESS]["block label"]="less",blockConfig[T_GREATER]["block label"]="greater",blockConfig[T_ADD]["block label"]="add",blockConfig[T_AVERAGE]["block label"]="average",blockConfig[T_SQRT]["block label"]="sqrt",blockConfig[T_HYPOT]["block label"]="hypot",blockConfig[T_SUBTRACT]["block label"]="subtract",blockConfig[T_MULT]["block label"]="multiply",blockConfig[T_DIV]["block label"]="divide",blockConfig[T_MOD]["block label"]="modulus",blockConfig[T_NOT]["block label"]="not",blockConfig[T_CONDITION]["block label"]="condition",blockConfig[T_RANGE]["block label"]="repeats w/ count",blockConfig[T_ELSE]["block label"]="else",blockConfig[T_DO]["block label"]="do",blockConfig[T_OUTLET]["block label"]="out",blockConfig[T_START]["block label"]="start",blockConfig[T_STOP]["block label"]="stop",blockConfig[T_ASSIGN]["block label"]="assign",blockConfig[T_CONSOLE]["block label"]="console",blockConfig[T_PRINT]["block label"]="print",blockConfig[T_COMMENT]["block label"]="//",blockConfig[T_CONST]["block label"]="constant",blockConfig[T_TURTLE]["block label"]="turtle 200x150",blockConfig[T_INLET]["block label"]="inlet",blockConfig[T_SIN]["block label"]="sin",blockConfig[T_COS]["block label"]="cos",blockConfig[T_LEN]["block label"]="length",blockConfig[T_GET]["block label"]="get",blockConfig[T_RUN]["block label"]="run",blockConfig[T_SET]["block label"]="set",blockConfig[T_ROUND]["block label"]="round",blockConfig[T_PUSH]["block label"]="push",blockConfig[T_DELETE]["block label"]="delete",blockConfig[T_FOR]["block label"]="repeat",blockConfig[T_INDEX]["block label"]="index",blockConfig[T_REF]["block label"]="value",blockConfig[T_LAYOUT_BLOCK]["block label"]="layout cell",blockConfig[T_BLOCK]["accept child"]=notStartOrConsoleOrSpecial,blockConfig[T_VAR]["accept child"]=[T_COMMENT],blockConfig[T_INPUT]["accept child"]=[T_COMMENT],blockConfig[T_IF]["accept child"]=[T_CONDITION,T_DO,T_ELSE,T_COMMENT],blockConfig[T_WHILE]["accept child"]=[T_CONDITION,T_DO,T_ELSE,T_COMMENT],blockConfig[T_FOR]["accept child"]=[T_RANGE,T_DO,T_ELSE,T_COMMENT],blockConfig[T_EQUAL]["accept child"]=numberyOnes.slice(1),blockConfig[T_LESS]["accept child"]=numberyOnes.slice(1),blockConfig[T_GREATER]["accept child"]=numberyOnes.slice(1),blockConfig[T_ADD]["accept child"]=numberyOnes,blockConfig[T_AVERAGE]["accept child"]=numberyOnes,blockConfig[T_SIN]["accept child"]=numberyOnes,blockConfig[T_COS]["accept child"]=numberyOnes,blockConfig[T_SQRT]["accept child"]=numberyOnes,blockConfig[T_ROUND]["accept child"]=numberyOnes,blockConfig[T_SUBTRACT]["accept child"]=numberyOnes,blockConfig[T_MULT]["accept child"]=numberyOnes,blockConfig[T_DIV]["accept child"]=numberyOnes,blockConfig[T_HYPOT]["accept child"]=numberyOnes,blockConfig[T_MOD]["accept child"]=numberyOnes,blockConfig[T_GOTO]["accept child"]=[T_COMMENT],blockConfig[T_NOT]["accept child"]=[...conditionallyOnes],blockConfig[T_CONDITION]["accept child"]=conditionallyOnes,blockConfig[T_RANGE]["accept child"]=[T_OUTLET,T_COMMENT,T_CONST,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_COS,T_SIN,T_LEN,T_GET,T_ROUND,T_LEN],blockConfig[T_ELSE]["accept child"]=notStartOrConsole,blockConfig[T_DO]["accept child"]=notStartOrConsole,blockConfig[T_OUTLET]["accept child"]=[T_COMMENT],blockConfig[T_START]["accept child"]=notStartOrConsoleOrSpecial,blockConfig[T_START]["accept child"].push(T_BLOCK),blockConfig[T_STOP]["accept child"]=[],blockConfig[T_ASSIGN]["accept child"]=[T_VAR,T_CONST,T_COMMENT,T_GET],blockConfig[T_CONSOLE]["accept child"]=[],blockConfig[T_PRINT]["accept child"]=[T_VAR,T_INPUT,T_CONST,T_COMMENT,T_GOTO,T_BLOCK,T_GET],blockConfig[T_COMMENT]["accept child"]=[],blockConfig[T_CONST]["accept child"]=[T_COMMENT],blockConfig[T_TURTLE]["accept child"]=[T_INLET],blockConfig[T_INLET]["accept child"]=[],blockConfig[T_LEN]["accept child"]=[],blockConfig[T_GET]["accept child"]=[T_INDEX],blockConfig[T_RUN]["accept child"]=[T_INDEX],blockConfig[T_SET]["accept child"]=[T_INDEX,T_REF],blockConfig[T_PUSH]["accept child"]=[T_REF],blockConfig[T_DELETE]["accept child"]=[T_INDEX],blockConfig[T_INDEX]["accept child"]=numberyOnes.slice(1),blockConfig[T_REF]["accept child"]=numberyOnes.slice(1),blockConfig[T_REF]["accept child"].push(T_GOTO),blockConfig[T_LAYOUT_BLOCK]["accept child"]=presComponents,blockConfig[T_BLOCK]["max children"]=100,blockConfig[T_GOTO]["max children"]=0,blockConfig[T_VAR]["max children"]=0,blockConfig[T_INPUT]["max children"]=0,blockConfig[T_IF]["max children"]=3,blockConfig[T_WHILE]["max children"]=3,blockConfig[T_FOR]["max children"]=3,blockConfig[T_EQUAL]["max children"]=100,blockConfig[T_LESS]["max children"]=100,blockConfig[T_GREATER]["max children"]=100,blockConfig[T_ADD]["max children"]=100,blockConfig[T_AVERAGE]["max children"]=100,blockConfig[T_SQRT]["max children"]=2,blockConfig[T_ROUND]["max children"]=2,blockConfig[T_SIN]["max children"]=2,blockConfig[T_COS]["max children"]=2,blockConfig[T_SUBTRACT]["max children"]=100,blockConfig[T_MULT]["max children"]=100,blockConfig[T_DIV]["max children"]=100,blockConfig[T_MOD]["max children"]=100,blockConfig[T_HYPOT]["max children"]=100,blockConfig[T_NOT]["max children"]=100,blockConfig[T_CONDITION]["max children"]=100,blockConfig[T_RANGE]["max children"]=1,blockConfig[T_ELSE]["max children"]=100,blockConfig[T_DO]["max children"]=100,blockConfig[T_OUTLET]["max children"]=0,blockConfig[T_START]["max children"]=100,blockConfig[T_STOP]["max children"]=100,blockConfig[T_ASSIGN]["max children"]=100,blockConfig[T_CONSOLE]["max children"]=0,blockConfig[T_PRINT]["max children"]=100,blockConfig[T_COMMENT]["max children"]=0,blockConfig[T_CONST]["max children"]=0,blockConfig[T_TURTLE]["max children"]=3,blockConfig[T_INLET]["max children"]=2,blockConfig[T_LEN]["max children"]=1,blockConfig[T_GET]["max children"]=1,blockConfig[T_RUN]["max children"]=1,blockConfig[T_SET]["max children"]=2,blockConfig[T_PUSH]["max children"]=1,blockConfig[T_DELETE]["max children"]=1,blockConfig[T_INDEX]["max children"]=1,blockConfig[T_REF]["max children"]=1,blockConfig[T_LAYOUT_BLOCK]["max children"]=1;var I_NONE=0,I_TEXT=1,I_SELECT=2,I_TEXT_AREA=3,I_CANVAS=0;function selectChangedCallback(){selectChanged=!0,redrawCounter=2}blockConfig[T_BLOCK]["input type"]=I_TEXT,blockConfig[T_GOTO]["input type"]=I_SELECT,blockConfig[T_VAR]["input type"]=I_SELECT,blockConfig[T_INPUT]["input type"]=I_TEXT,blockConfig[T_IF]["input type"]=I_NONE,blockConfig[T_WHILE]["input type"]=I_NONE,blockConfig[T_FOR]["input type"]=I_NONE,blockConfig[T_EQUAL]["input type"]=I_NONE,blockConfig[T_LESS]["input type"]=I_NONE,blockConfig[T_GREATER]["input type"]=I_NONE,blockConfig[T_ADD]["input type"]=I_NONE,blockConfig[T_SIN]["input type"]=I_NONE,blockConfig[T_COS]["input type"]=I_NONE,blockConfig[T_AVERAGE]["input type"]=I_NONE,blockConfig[T_SQRT]["input type"]=I_NONE,blockConfig[T_ROUND]["input type"]=I_NONE,blockConfig[T_SUBTRACT]["input type"]=I_NONE,blockConfig[T_MULT]["input type"]=I_NONE,blockConfig[T_DIV]["input type"]=I_NONE,blockConfig[T_MOD]["input type"]=I_NONE,blockConfig[T_HYPOT]["input type"]=I_NONE,blockConfig[T_NOT]["input type"]=I_NONE,blockConfig[T_CONDITION]["input type"]=I_NONE,blockConfig[T_RANGE]["input type"]=I_SELECT,blockConfig[T_ELSE]["input type"]=I_NONE,blockConfig[T_DO]["input type"]=I_NONE,blockConfig[T_OUTLET]["input type"]=I_SELECT,blockConfig[T_START]["input type"]=I_NONE,blockConfig[T_STOP]["input type"]=I_NONE,blockConfig[T_ASSIGN]["input type"]=I_NONE,blockConfig[T_CONSOLE]["input type"]=I_NONE,blockConfig[T_PRINT]["input type"]=I_NONE,blockConfig[T_COMMENT]["input type"]=I_TEXT_AREA,blockConfig[T_CONST]["input type"]=I_TEXT,blockConfig[T_TURTLE]["input type"]=I_CANVAS,blockConfig[T_INLET]["input type"]=I_NONE,blockConfig[T_LEN]["input type"]=I_SELECT,blockConfig[T_GET]["input type"]=I_SELECT,blockConfig[T_RUN]["input type"]=I_SELECT,blockConfig[T_SET]["input type"]=I_SELECT,blockConfig[T_PUSH]["input type"]=I_SELECT,blockConfig[T_DELETE]["input type"]=I_SELECT,blockConfig[T_INDEX]["input type"]=I_NONE,blockConfig[T_REF]["input type"]=I_NONE,blockConfig[T_LAYOUT_BLOCK]["input type"]=I_TEXT,blockConfig[T_BLOCK].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_GOTO].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_VAR].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_CONST,copy:!0},blockConfig[T_INPUT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_IF].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_WHILE,copy:!0},blockConfig[T_WHILE].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_FOR,copy:!0},blockConfig[T_FOR].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_IF,copy:!0},blockConfig[T_EQUAL].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_LESS,copy:!0},blockConfig[T_LESS].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_GREATER,copy:!0},blockConfig[T_GREATER].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_EQUAL,copy:!0},blockConfig[T_ADD].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_SUBTRACT,copy:!0},blockConfig[T_SUBTRACT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_MULT,copy:!0},blockConfig[T_MULT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_DIV,copy:!0},blockConfig[T_DIV].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_MOD,copy:!0},blockConfig[T_MOD].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_AVERAGE,copy:!0},blockConfig[T_AVERAGE].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_HYPOT,copy:!0},blockConfig[T_SQRT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_HYPOT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_ROUND,copy:!0},blockConfig[T_ROUND].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_ADD,copy:!0},blockConfig[T_SIN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_COS,copy:!0},blockConfig[T_COS].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_SIN,copy:!0},blockConfig[T_NOT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_CONDITION].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_RANGE].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!0},blockConfig[T_ELSE].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_DO].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_OUTLET].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!0},blockConfig[T_START].handles={move:!0,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_STOP].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!1},blockConfig[T_ASSIGN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_CONSOLE].handles={move:!0,resize:!0,delete:!0,expand:!1,mutate:-1,copy:!1},blockConfig[T_PRINT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_COMMENT].handles={move:!0,resize:!0,delete:!0,expand:!1,mutate:-1,copy:!0},blockConfig[T_CONST].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_INPUT,copy:!0},blockConfig[T_TURTLE].handles={move:!0,resize:!1,delete:!0,expand:!0,mutate:-1,copy:!1},blockConfig[T_INLET].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!0},blockConfig[T_LEN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_GET].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_RUN,copy:!0},blockConfig[T_RUN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_DELETE,copy:!0},blockConfig[T_SET].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_PUSH].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_DELETE].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_GET,copy:!0},blockConfig[T_INDEX].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!1},blockConfig[T_REF].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!1},blockConfig[T_LAYOUT_BLOCK].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0};class Cell{constructor(type,x,y,w,h,c,r){jlog("Cell","constructor"),this.children=[],this.childIndicies=[],this.parent=-1,this.dataSH,this.dataSHasType={},this.handleSH="unset",this.type=int(type),this.textLabel=blockConfig[this.type]["block label"],this.type,this.mode=M_IDLE,this.highlight=!1,this.underneath=!1,this.flash=!1,this.startForm=!1,this.showHandleInput=!1,this.inputOptions=[],this.forceHandleSH=!1,this.forceHandleSHFrameOff=-1,this.childYBorder=2*r,this.childXBorder=1.5*r,this.ySpacer=0,type==T_CONSOLE&&(w*=2,h*=5),this.width=w,this.height=h,this.oldHeight=h,this.minWidth=w,this.minHeight=h,this.radius=r,this.x=x,this.y=y,this.deletable=!0,this.copyable=!0,this.resizable=!0,this.mutable=!0,this.expandable=!0,this.startable=!0,this.viewX=x,this.viewY=y,this.deltaX=0,this.deltaY=0,this.hide=!1,this.shrink=!1,this.handleW=1.5*r,this.handleH=1.5*r,this.graphicUpdate=!0,this.specialLayer=null,this.id,this.colors=c,type==T_START&&(this.makeStartButtonOptions(),this.sbHighlight=!1),this.lineNumber=0,this.indexLabeldiv=createDiv(this.textLabel),this.indexLabeldiv.style("font-size",fontSizeString),this.indexLabeldiv.style("color",colorToHTMLRGB(this.colors[4])),this.indexLabeldiv.show(),this.yHeaderEnd=parseInt(this.indexLabeldiv.style("font-size"))+this.childYBorder,this.type==T_START?this.yHeaderEnd+=2*this.handleH:this.yHeaderEnd-=2*this.handleH,this.height+=this.yHeaderEnd,this.startHeight=this.height,this.startWidth=this.width,this.type==T_TURTLE&&(this.canvas=createGraphics(200,150),this.canvas.pixelDensity(1),this.canvas.background(255)),this.buildDivs(),this.resizeConsole(),this.updateAllDivPositions()}get size(){return jlog("Cell","size"),[this.width,this.height]}resetDims(full=!1){1==full&&(this.height=this.startHeight,this.width=this.startWidth),this.minWidth=this.width,this.minHeight=this.height}getDataSH(){jlog("Cell","getDataSH");const d=new Date;switch(this.handleSH){case"random":this.dataSH=random();break;case"year":this.dataSH=d.getFullYear();break;case"month#":this.dataSH=d.getMonth()+1;break;case"monthS":const month=["January","February","March","April","May","June","July","August","September","October","November","December"];this.dataSH=month[d.getMonth()];break;case"day#":this.dataSH=d.getDate();break;case"dayS":const days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];this.dataSH=days[d.getDay()];break;case"hour":this.dataSH=d.getHours();break;case"minute":this.dataSH=d.getMinutes();break;case"second":this.dataSH=d.getSeconds();break;case"millis":this.dataSH=d.getMilliseconds()}return this.dataSH}getDataSHForPrint(){jlog("Cell","getDataSHForPrint");let res=this.getDataSH();return"undefined"==String(res)&&(res=this.textLabel),res}disableDelete(){jlog("Cell","disableDelete"),this.deletable=!1}disableAllButMove(){jlog("Cell","disableAllButMove"),this.deletable=!1,this.copyable=!1,this.resizable=!1,this.mutable=!1,this.expandable=!1,this.startable=!1}updateHandleSH(newHandle){jlog("Cell","updateHandleSH"),this.handleSH=newHandle,this.type==T_LAYOUT_BLOCK&&this.indexLabeldiv.html(this.handleSH),this.type!=T_BLOCK&&this.type!=T_INPUT||(this.indexLabeldiv.html(this.textLabel+" "+newHandle),this.indexLabeldiv.html(this.textLabel+" "+newHandle),this.updateView(this.viewX-this.x,this.viewY-this.y),this.updateAllDivPositions(),this.refresh()),this.type==T_BLOCK&&this.input.value(newHandle),this.type==T_VAR&&(this.input.selected(newHandle),this.indexLabeldiv.html(this.textLabel+" "+newHandle)),this.type==T_GOTO&&(this.input.selected(newHandle),this.indexLabeldiv.html(this.textLabel+" "+newHandle)),blockConfig[this.type]["input type"]==I_SELECT&&this.input.selected(newHandle)}reStyle(){jlog("Cell","reStyle"),this.indexLabeldiv.style("font-size",fontSizeString),this.indexLabeldiv.style("color",colorToHTMLRGB(this.colors[4])),this.indexLabeldiv.show(),this.buildDivs()}resizeConsole(m1=100,m2=75){jlog("Cell","resizeConsole"),this.graphicUpdate=!0,this.type==T_CONSOLE&&(this.minWidth=max(m1,this.minWidth),this.minHeight=max(m2,this.minHeight),this.indexLabeldiv.size(this.width-3*this.childXBorder,this.height-this.childYBorder),this.indexLabeldiv.style("overflow","auto"))}buildDivs(){jlog("Cell","buildDivs"),this.graphicUpdate=!0;this.viewX,this.viewY;if(this.height=this.startHeight,this.width=this.startWidth,this.ySpacer=0,this.input&&this.input.remove(),blockConfig[this.type]["input type"]==I_TEXT&&(this.input=createInput(),this.input.input(selectChangedCallback)),blockConfig[this.type]["input type"]==I_TEXT_AREA&&(this.input=createElement("textarea"),this.input.input(selectChangedCallback)),blockConfig[this.type]["input type"]==I_SELECT&&(this.input=createSelect(),this.input.changed(selectChangedCallback),this.width=max(this.width,this.startWidth)),blockConfig[this.type]["input type"]!=I_NONE){this.input.style("font-size",fontSizeString),1==this.showHandleInput?this.input.style("background-color",colorToHTMLRGB(this.colors[1])):this.type==T_CONST?this.input.style("background-color",colorToHTMLRGB(color(255))):this.input.style("background-color",colorToHTMLRGB(this.colors[2])),this.input.style("border-color",colorToHTMLRGB(this.colors[1])),this.input.style("color",colorToHTMLRGB(this.colors[4])),this.input.style("border",0);let h=this.input.size().height,w=this.width;this.standardInputHeight=h,this.input.size(w,h),this.width=w+3*this.childXBorder,1==mobileDeviceDetected&&(this.width+=this.handleW),this.ySpacer+=this.input.height,this.minWidth=this.width}this.updateAllDivPositions()}updateAllDivPositions(){jlog("Cell","updateAllDivPositions");let xp=this.viewX,yp=this.viewY;this.updateDivPosition(this.indexLabeldiv,xp+2*this.childXBorder,yp),blockConfig[this.type]["input type"]!=I_NONE&&this.updateDivPosition(this.input,xp+this.childXBorder,yp+this.childYBorder+this.yHeaderEnd)}updateDataSH(value,hard=!1){jlog("Cell","updateDataSH"),this.dataSH=value,blockConfig[this.type]["input type"]==I_TEXT&&1==hard&&(this.input.value(value,value),0==showGUI&&(this.input.hide(),this.indexLabeldiv.hide())),blockConfig[this.type]["input type"]==I_SELECT&&1==hard&&(this.input.selected(value),0==showGUI&&(this.input.hide(),this.indexLabeldiv.hide())),this.unpackDataSH()}updateView(xOff,yOff){jlog("Cell","updateView"),-1==this.parent&&(this.viewX=this.x+xOff,this.viewY=this.y+yOff)}draw(canvas=null){jlog("Cell","draw");let x=this.viewX,y=this.viewY;if(this.specialLayer){let sx=x-(this.specialLayer.width-this.width)/2,sy=y-(this.specialLayer.height-this.height)/2;image(this.specialLayer,int(sx),int(sy))}if(!1===this.hide){1==this.flash||!0===this.highlight?fill(this.colors[2]):fill(this.colors[0]),!0===this.underneath&&(blockConfig[this.type]["input type"]!=I_NONE&&this.input.hide(),this.indexLabeldiv.hide()),!1===this.underneath&&(blockConfig[this.type]["input type"]!=I_NONE&&(this.type==T_BLOCK?1==this.showHandleInput?this.input.show():this.input.hide():this.input.show()),this.indexLabeldiv.show(),0==showGUI&&(this.indexLabeldiv.hide(),blockConfig[this.type]["input type"]!=I_NONE&&this.input.hide())),stroke(this.colors[1]),rect(x,y,this.width,this.height,this.radius),1==blockConfig[this.type].handles.move&&(fill(this.colors[1]),rect(x,y,this.handleW,this.handleH)),1==blockConfig[this.type].handles.delete&&1==this.deletable&&1==this.startable&&(fill(this.colors[3]),stroke(this.colors[3]),rect(x+this.width-this.handleW,y,this.handleW,this.handleH),stroke(this.colors[1])),1==blockConfig[this.type].handles.expand&&1==this.expandable&&(fill(this.colors[1]),rect(x+this.width/2-this.handleW,y+this.height-this.handleH,this.handleW,this.handleH)),0==this.shrink&&(1==blockConfig[this.type].handles.resize&&1==this.resizable&&(fill(this.colors[1]),rect(x+this.width-this.handleW,y+this.height-this.handleH,this.handleW,this.handleH)),1==blockConfig[this.type].handles.copy&&1==this.copyable&&(fill(this.colors[1]),rect(x+this.width-this.handleW,y+this.height/2-this.handleH,this.handleW,this.handleH)),-1!=blockConfig[this.type].handles.mutate&&1==this.mutable&&(fill(this.colors[1]),rect(x,y+this.height-this.handleH,this.handleW,this.handleH)));for(let i=0;i<this.children.length;i++)this.children[i].draw();this.type==T_TURTLE&&image(this.canvas,x+this.handleW,y+3*this.yHeaderEnd)}else this.hideDivs();!0===this.shrink&&this.hideDivs(),this.type==T_START&&0==this.shrink&&image(this.sbGraphics[int(this.startForm)][int(this.sbHighlight)],x+this.width/2-1.5*this.handleW,y+this.yHeaderEnd-1.25*this.handleH*2)}toggleStartForm(myBool){jlog("Cell","toggleStartForm"),this.startForm=myBool,1==myBool?(this.textLabel=blockConfig[T_STOP]["block label"],this.indexLabeldiv.html(this.textLabel)):(this.textLabel=blockConfig[T_START]["block label"],this.indexLabeldiv.html(this.textLabel))}makeStartButtonOptions(){jlog("Cell","makeStartButtonOptions"),this.sbGraphics={},this.sbGraphics[0]={},this.sbGraphics[1]={},this.sbGraphics[0][0]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[0][1]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[1][0]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[1][1]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[0][0].stroke(this.colors[1]),this.sbGraphics[0][1].stroke(this.colors[1]),this.sbGraphics[1][0].stroke(this.colors[1]),this.sbGraphics[1][1].stroke(this.colors[1]),this.sbGraphics[0][0].fill(this.colors[0]),this.sbGraphics[0][1].fill(this.colors[2]),this.sbGraphics[1][0].fill(this.colors[0]),this.sbGraphics[1][1].fill(this.colors[2]),this.sbGraphics[0][0].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[0][1].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[1][0].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[1][1].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[0][0].fill(this.colors[2]),this.sbGraphics[0][1].fill(this.colors[0]),this.sbGraphics[1][0].fill(this.colors[2]),this.sbGraphics[1][1].fill(this.colors[0]),this.sbGraphics[0][0].triangle(.5*this.handleW,.5*this.handleH,.5*this.handleW,2.5*this.handleH,2.5*this.handleW,1.5*this.handleH),this.sbGraphics[0][1].triangle(.5*this.handleW,.5*this.handleH,.5*this.handleW,2.5*this.handleH,2.5*this.handleW,1.5*this.handleH),this.sbGraphics[1][0].rect(.5*this.handleW,.5*this.handleH,2*this.handleW,2*this.handleH),this.sbGraphics[1][1].rect(.5*this.handleW,.5*this.handleH,2*this.handleW,2*this.handleH)}updateDivPosition(div,x,y){jlog("Cell","updateDivPosition"),div.position(x,y)}moveC(x,y,xdelta,ydelta){jlog("Cell","moveC"),this.graphicUpdate=!0,this.viewX=x,this.viewY=y,this.x=this.viewX-xdelta,this.y=this.viewY-ydelta,this.refresh(xdelta,ydelta)}refresh(xdelta,ydelta){jlog("Cell","refresh"),this.graphicUpdate=!0;let childX=this.viewX+this.childXBorder,childY=this.viewY+2*this.childYBorder+this.ySpacer+this.yHeaderEnd;0==this.showHandleInput&&this.type==T_BLOCK&&(childY-=this.standardInputHeight),this.type==T_TURTLE&&(childX+=this.canvas.width+this.handleW,childY=this.viewY+3*this.yHeaderEnd),this.updateAllDivPositions();for(let i=0;i<this.children.length;i++)-1!=blockConfig[this.type]["accept child"].indexOf(this.children[i].type)&&(this.children[i].moveC(childX,childY,xdelta,ydelta),childY+=this.childYBorder+this.children[i].height)}resizeC(x,y){jlog("Cell","resize"),this.graphicUpdate=!0;let nw=x-this.viewX,nh=y-this.viewY;nw>2*this.handleW&&(this.width=nw),nh>2*this.handleH&&(this.height=nh),this.type==T_COMMENT?(1==mobileDeviceDetected?this.input.size(this.width-3*this.childXBorder-this.handleW,this.height-4*this.childYBorder):this.input.size(this.width-3*this.childXBorder,this.height-4*this.childYBorder),this.minHeight=this.height,this.minWidth=this.minWidth):this.width=max(this.minWidth,this.width),this.height=max(this.minHeight,this.height),blockConfig[this.type]["input type"]!=I_NONE&&blockConfig[this.type]["input type"]!=I_TEXT_AREA&&this.type!=T_CONSOLE&&(1==mobileDeviceDetected?this.input.size(this.width-3*this.childXBorder-this.handleW,this.standardInputHeight):this.input.size(this.width-3*this.childXBorder,this.standardInputHeight)),this.resizeConsole()}reshape(reshape=!1){if(jlog("Cell","reshape"),this.type==T_LAYOUT_BLOCK)return;this.graphicUpdate=!0;this.viewX,this.viewY;for(let i=0;i<this.children.length;i++)this.children[i].mode==M_IDLE&&this.children[i].reshape();let heightSum=this.yHeaderEnd+this.childYBorder+this.ySpacer;for(let i=0;i<this.children.length;i++)this.children[i].width+2*this.childXBorder>this.width&&(this.width=this.children[i].width+2*this.childXBorder),0==this.children[i].hide&&(heightSum+=this.children[i].height+this.childYBorder);if(heightSum+=2*this.childYBorder,heightSum>this.height&&(this.height=heightSum,this.minHeight=this.height),this.height<this.indexLabeldiv.size().height&&(this.minHeight=this.indexLabeldiv.size().height+2*this.childYBorder),1==reshape&&(this.height=this.minHeight),!0===this.shrink&&(this.width=this.startWidth,this.height=3*this.yHeaderEnd,this.type==T_START?this.height=this.yHeaderEnd:this.height=3*this.yHeaderEnd,this.minHeight=this.height),this.width<this.indexLabeldiv.size().width+3*this.childXBorder&&this.type!=T_CONSOLE&&(this.width=this.indexLabeldiv.size().width+3*this.childXBorder),blockConfig[this.type]["input type"]!=I_NONE){this.input.size().height;1==mobileDeviceDetected?this.input.size(this.width-3*this.childXBorder-this.handleW):this.input.size(this.width-3*this.childXBorder)}this.refresh(0,0),this.type==T_TURTLE&&(this.height=this.canvas.height+this.yHeaderEnd+4*this.handleH,this.width=this.canvas.width+2*this.handleW,this.children[0]&&this.children[0].mode!=M_DELETE&&(this.width+=this.children[2].width+this.handleW))}markForDeletion(){jlog("Cell","markForDeletion");for(let i=0;i<this.children.length;i++)this.children[i].markForDeletion();this.mode=M_DELETE}cleanForDeletionSafe(){jlog("Cell","cleanForDeletionSafe");let par=-1;return this.mode==M_DELETE&&(this.indexLabeldiv.remove(),par=this.parent,this.removeParent(),blockConfig[this.type]["input type"]!=I_NONE&&(this.input.remove(),this.input.remove())),par}checkButtons(x,y){jlog("Cell","checkButtons");let xp=this.viewX,yp=this.viewY,breaker=!1;if(0==this.hide){let fudge=2;if(1!=zoomMode&&this.mode!=M_NEW||(fudge=this.handleW),1==blockConfig[this.type].handles.move&&x>xp-fudge&&x<xp+this.handleW+fudge&&y>yp-fudge&&y<yp+this.handleH+fudge&&(console.log("move button pressed"),this.mode=M_MOVE,breaker=!0),1==blockConfig[this.type].handles.delete&&x>xp+this.width-this.handleW-fudge&&x<xp+this.width+fudge&&y>yp-fudge&&y<yp+this.handleH+fudge&&(console.log("delete button pressed"),this.type==T_CONSOLE?(this.indexLabeldiv.html(this.textLabel),this.lineNumber=0):(1==this.deletable&&(this.mode=M_DELETE),breaker=!0)),1==blockConfig[this.type].handles.expand&&x>xp+this.width/2-this.handleW&&x<xp+this.width/2&&y>yp+this.height-this.handleH&&y<yp+this.height&&(console.log("expand || collapse button pressed"),1==this.mutable&&(this.mode=M_EXPAND_OR_COLLAPSE),breaker=!0),0==this.shrink){if(1==blockConfig[this.type].handles.resize&&x>xp+this.width-this.handleW-fudge&&x<xp+this.width+fudge&&y>yp+this.height-this.handleH-fudge&&y<yp+this.height+fudge&&(console.log("resize button pressed"),1==this.resizable&&(this.mode=M_RESIZE),breaker=!0),1==blockConfig[this.type].handles.copy){let xMin=xp+this.width-this.handleW,yMin=yp+this.height/2-this.handleH,xMax=xMin+this.handleW,yMax=yMin+this.handleH;xMin-fudge<x&&x<xMax+fudge&&yMin-fudge<y&&y<yMax+fudge&&(console.log("copy button pressed"),1==this.copyable&&(this.mode=M_COPY),breaker=!0)}if(-1!=blockConfig[this.type].handles.mutate&&xp-fudge<x&&x<xp+this.handleW+fudge&&yp+this.height-this.handleH-fudge<y&&y<yp+this.height+fudge&&(console.log("mutate button pressed"),1==this.mutable&&(this.mode=M_MUTATE),breaker=!0),this.type==T_START&&this.mode!=M_MOVE&&0==this.shrink){let xMin=xp+this.width/2-1.5*this.handleW,xMax=xMin+3*this.handleW;if(x>xMin&&x<xMax){let yMin=yp+this.yHeaderEnd-1.25*this.handleH*2,yMax=yMin+3*this.handleH;y>yMin&&y<yMax&&(1==this.startable&&(this.mode=M_START),breaker=!0)}}}}return breaker}clearConsole(){jlog("Cell","clearConsole"),this.type==T_CONSOLE&&(this.indexLabeldiv.html(this.textLabel),this.lineNumber=0)}updateSHs(){if(jlog("Cell","updateSHs"),0==this.forceHandleSH&&blockConfig[this.type]["input type"]!=I_NONE&&this.mode!=M_NEW){switch(this.type){case T_BLOCK:this.mode!=M_SELECTED&&this.updateHandleSH(this.input.value());break;case T_GOTO:case T_VAR:case T_GET:case T_RUN:case T_SET:case T_RANGE:case T_PUSH:case T_DELETE:case T_LEN:this.updateHandleSH(this.input.value());break;case T_OUTLET:let tempHandle=this.input.value();this.handleSH!=tempHandle&&(this.unsetData(),this.updateHandleSH(tempHandle));break;case T_INPUT:this.mode!=M_SELECTED&&0==this.showHandleInput&&this.updateDataSH(this.input.value());break;case T_COMMENT:this.dataSH=this.input.value();break;case T_CONST:this.updateDataSH(this.input.value())}this.unpackDataSH()}1==this.forceHandleSH&&(this.updateDataSH(this.handleSH,!0),-1==this.forceHandleSHFrameOff&&(this.forceHandleSHFrameOff=frameCount+5)),-1!=this.forceHandleSHFrameOff&&this.forceHandleSHFrameOff<frameCount&&(this.forceHandleSH=!1,this.forceHandleSHFrameOff=-1)}unpackDataSH(){jlog("Cell","unpackDataSH"),this.dataSHasType.string=this.dataSH,this.dataSHasType.number=parseFloat(this.dataSH),this.dataSHasType.isNumber=!isNaN(this.dataSHasType.number),"false"==this.dataSH?this.dataSHasType.bool=!1:this.dataSHasType.bool=!0,1!=/^\d+\.\d+$/.test(this.dataSH)&&1!=/^\d+$/.test(this.dataSH)||(this.dataSHasType.bool=Boolean(parseInt(this.dataSH)))}updateOptions(options){if(jlog("Cell","updateOptions"),blockConfig[this.type]["input type"]==I_SELECT){for(let i=0;i<this.inputOptions.length;i++)if(-1==options[this.type].indexOf(this.inputOptions[i])){this.inputOptions=[],this.input.remove(),this.buildDivs();break}for(let i=0;i<options[this.type].length;i++)this.input.option(options[this.type][i],options[this.type][i]),this.inputOptions.push(options[this.type][i]);-1!=options[this.type].indexOf(this.handleSH)&&this.input.selected(this.handleSH)}let tempSet=new Set(this.inputOptions);this.inputOptions=Array.from(tempSet)}forcefullyAddChildren(ind,child){jlog("Cell","forcefullyAddChildren"),this.graphicUpdate=!0,this.childIndicies.push(ind),this.children.push(child)}acceptsChild(type){return jlog("Cell","acceptsChild"),-1!=blockConfig[this.type]["accept child"].indexOf(type)}addChild(ind,child,force=!1){return jlog("Cell","addChild"),this.graphicUpdate=!0,(1==force||1==this.acceptsChild(child.type)&&this.children.length<blockConfig[this.type]["max children"])&&-1==this.childIndicies.indexOf(ind)&&(this.children.push(child),this.childIndicies.push(ind)),!0}addParent(ind,parent){jlog("Cell","addParent"),this.parent=ind,this.type==T_START&&(this.parent=-1)}removeParent(){jlog("Cell","removeParent"),this.parent=-1}clearChildren(){jlog("Cell","clearChildren"),this.childIndicies=[],this.children=[],this.minHeight=0,this.reshape(!0)}removeChild(ind){if(jlog("Cell","removeChild"),this.graphicUpdate=!0,this.type!=T_VAR&&this.type!=T_INPUT){let ci=this.childIndicies.indexOf(ind);-1!=ci&&(this.childIndicies.splice(ci,1),this.children.splice(ci,1))}return this.minHeight=0,this.reshape(!0),this.parent}expandOrCollapse(){jlog("Cell","expandOrCollapse"),this.type==T_TURTLE?(this.canvas.clear(),this.canvas.background(255),this.shrink=!1):!0===this.shrink?this.expandBlock():this.shrinkBlock(),this.graphicUpdate=!0,this.mode=M_IDLE}hideDivs(){jlog("Cell","hideDivs"),blockConfig[this.type]["input type"]!=I_NONE&&this.input.hide()}hideBlock(andChildren=!0){jlog("Cell","hideBlock"),this.graphicUpdate=!0;for(let i=0;i<this.children.length;i++)1==andChildren&&this.children[i].hideBlock();this.hide=!0,this.hideDivs(),this.indexLabeldiv.hide()}showDivs(){jlog("Cell","showDivs"),blockConfig[this.type]["input type"]!=I_NONE&&(this.type==T_BLOCK?1==this.showHandleInput?this.input.show():this.input.hide():this.input.show(),0==showGUI&&this.input.hide()),0==showGUI&&this.indexLabeldiv.hide()}showBlock(){jlog("Cell","showBlock"),this.graphicUpdate=!0;for(let i=0;i<this.children.length;i++)this.children[i].showBlock();this.hide=!1,this.showDivs(),this.indexLabeldiv.show()}shrinkBlock(){jlog("Cell","shrinkBlock"),this.graphicUpdate=!0,this.oldHeight=this.height;for(let i=0;i<this.children.length;i++)this.children[i].hideBlock(),this.children[i].shrinkBlock();this.shrink=!0,this.hideDivs()}expandBlock(){jlog("Cell","expandBlock"),this.graphicUpdate=!0;for(let i=0;i<this.children.length;i++)this.children[i].showBlock(),this.children[i].expandBlock();this.shrink=!1,this.showDivs(),this.minHeight=this.oldHeight,this.height=this.oldHeight,this.reshape()}selfDescribe(short=!1){jlog("Cell","selfDescribe"),console.log("TYPE",blockConfig[this.type]["block label"]),console.log("DATA",this.dataSH),console.log("DATAAS",this.dataSHasType),console.log("HANDLE",this.handleSH),console.log("CHILDREN",this.childIndicies),console.log("DIMS",this.width,this.height),console.log("PARENT",this.parent),console.log("XY",this.x,this.y),console.log("VIEW XY",this.viewX,this.viewY),console.log("\n")}unsetData(){jlog("Cell","unsetData"),this.dataSH=undefined}pushX(x){jlog("Cell","pushX"),this.viewX+=x,this.x+=x}inArea(x,y){jlog("Cell","inArea");let xp=this.viewX,yp=this.viewY,breaker=!1;if(!1===this.hide){let fudge=2;1!=zoomMode&&this.mode!=M_NEW||(fudge=this.handleW),x>xp-fudge&&x<xp+this.width+fudge&&y>yp-fudge&&y<yp+this.height+fudge&&(1==clickDebug&&this.selfDescribe(!1),breaker=!0)}return breaker}}class Cells{constructor(c,h,l,i,dt){jlog("Cells","constructor"),this.cells=[],this.dWidth=80,this.dHeight=40,this.dRadius=5,this.activeIndex=-1,this.colors=c,this.highlights=h,this.lowlights=l,this.inverted=i,this.dualtone=dt,this.varNames="abcdefghijklmnopqrstuvwxyz",this.varHandles=["unset"],this.map={},this.run=!1,this.viewXdelta=0,this.viewYdelta=0,this.cellsInView=[],this.oldMouse=!0,this.rebuildMenuFlag=!1,this.redrawFlag=!1,this.parentFlag=0,this.parentWidthRecord=[-1,0],this.partialUpdate=[],this.createMode=!1,this.presBackup,this.layoutArray}get length(){return jlog("Cells","length"),this.cells.length}removeCreateMode(){jlog("Cells","removeCreateMode"),this.quickClear(!0),this.cellsInView=[],this.cells=[],this.createMode=!1}addIDsForCreateMode(){for(let i=0;i<this.length;i++)this.cells[i].id=i}cleanForCreateMode(){jlog("Cells","cleanForCreateMode"),this.createMode=!0;let layoutCount=0;for(let i=0;i<this.length;i++)this.cells[i].type!=T_LAYOUT_BLOCK?(this.cells[i].removeParent(),this.cells[i].clearChildren(),this.cells[i].disableAllButMove()):layoutCount+=1,this.cellsInView.push(i);if(this.mapAndLink(),0==layoutCount)this.newLayoutBlock("A0",windowWidth/3,10);else for(let i=0;i<this.length;i++)this.cells[i].type==T_LAYOUT_BLOCK&&0!=this.cells[i].children.length&&this.cells[i].children[0].addParent(i,this.cells[i])}newLayoutBlock(name,x,y){let c=[color(0,0,0,0),color(0,0,0,255),color(255,255,255,255),color(0,0,0,255),color(0,0,0,255)],pIndex=this.length;this.cellsInView.push(pIndex),this.cells.push(new Cell(T_LAYOUT_BLOCK,x,y,2*this.dWidth,2.8*this.dHeight,c,this.dRadius)),this.cells[pIndex].updateHandleSH(name)}getLayoutBlockNextName(name){let newName="";if("Z"==name[0])newName=getLayoutBlockBelowName(name);else{let value=name[0].charCodeAt(0);newName=String.fromCharCode(value+1)+name.slice(1)}return newName}getLetterAndNumber(name){return{letter:name[0],ascii:name[0].charCodeAt(0),number:parseInt(name.slice(1))}}getLayoutBlockBelowName(name){let startName=this.getLetterAndNumber(name),newNumber=String(startName.number+1),newLetter="A".charCodeAt(0);for(let i=0;i<this.length;i++)this.cells[i].type==T_LAYOUT_BLOCK&&this.getLetterAndNumber(this.cells[i].handleSH).number==newNumber&&(newLetter=this.getLetterAndNumber(this.cells[i].handleSH).ascii+1);return String.fromCharCode(newLetter)+newNumber}getLayoutArray(){let layoutArray=[],rowArray=[],mydiv=[],prev="A-1";for(let i=0;i<this.length;i++)this.cells[i].type==T_LAYOUT_BLOCK&&(mydiv=[],mydiv.push(this.cells[i].input.value()),0!=this.cells[i].children.length&&mydiv.push(this.cells[i].children[0].id),this.cells[i].handleSH==this.getLayoutBlockNextName(prev)||(layoutArray.push(rowArray),rowArray=[]),rowArray.push(mydiv),prev=this.cells[i].handleSH);return layoutArray.push(rowArray),layoutArray=layoutArray.slice(1),layoutArray}tidy(xMin,yMin){jlog("Cells","tidy");let bigBlocks=[];for(let i=0;i<this.length;i++)if(-1==this.cells[i].parent)this.cells[i].type!=T_START&&this.cells[i].type!=T_CONSOLE&&this.cells[i].type!=T_LAYOUT_BLOCK&&(this.cells[i].reshape(!0),bigBlocks.push(this.cells[i]));else{let parType=this.cells[this.cells[i].parent].type,cType=this.cells[i].type;-1==blockConfig[parType]["accept child"].indexOf(cType)&&bigBlocks.push(this.cells[i])}this.cells[1].resizeConsole(),bigBlocks.sort((function(a,b){return a.width*a.height-b.width*b.height})),0==this.createMode&&bigBlocks.unshift(this.cells[0],this.cells[1]);let x=xMin,y=yMin,offset=0,newPos=[];for(let i=0;i<bigBlocks.length;i++)(y+bigBlocks[i].height>windowHeight||i<2&&0==this.createMode)&&(x+=offset+3*bigBlocks[i].childXBorder,y=yMin,offset=0),newPos.push([x,y]),bigBlocks[i].reshape(),bigBlocks[i].width>offset&&(offset=bigBlocks[i].width),y+=bigBlocks[i].height+bigBlocks[i].childYBorder;for(let i=0;i<bigBlocks.length;i++)bigBlocks[i].x=newPos[i][0],bigBlocks[i].y=newPos[i][1],bigBlocks[i].updateAllDivPositions();this.updateView(this.viewX,this.viewY,!1),this.mapAndLink(),this.rebuildMenuFlag=!0}saveCells(smaller=!1){jlog("Cells","saveCells");let snapshot={};this.mapAndLink();for(let i=0;i<this.length;i++)snapshot[i]={},0==smaller&&(snapshot[i].x=int(this.cells[i].x),snapshot[i].y=int(this.cells[i].y),snapshot[i].tL=1==i?blockConfig[T_CONSOLE]["block label"]:this.cells[i].textLabel,snapshot[i].L=this.cells[i].indexLabeldiv.html(),snapshot[i].h=this.cells[i].hide,snapshot[i].s=this.cells[i].shrink),snapshot[i].t=this.cells[i].type,snapshot[i].d=this.cells[i].dataSH,snapshot[i].i=this.cells[i].handleSH,snapshot[i].p=this.cells[i].parent,0!=this.cells[i].childIndicies.length&&(snapshot[i].c=this.cells[i].childIndicies);return snapshot}addCellWithInfo(info){jlog("Cells","addCellWithInfo");let type=info.t;type>this.colors.length&&(type=this.cells[info.p].type);let c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]];type==T_START&&(c=[this.colors[type],this.highlights[type],this.colors[49],this.inverted[type],this.dualtone[type]]);let newCell=this.length;this.cells.push(new Cell(info.t,info.x,info.y,this.dWidth,this.dHeight,c,this.dRadius)),this.cells[newCell].hide=info.h,this.cells[newCell].shrink=info.s,this.cells[newCell].updateDataSH(info.d),this.cells[newCell].updateHandleSH(info.i),this.varHandles.push(info.i),this.cells[newCell].parent=info.p,info.t!=T_OUTLET&&info.t!=T_VAR&&info.t!=T_INPUT&&info.t!=T_INLET||(this.cells[newCell].textLabel=info.tL,this.cells[newCell].indexLabeldiv.html(info.L),this.cells[newCell].updateHandleSH(info.i),this.cells[newCell].updateDataSH(info.d)),blockConfig[this.cells[newCell].type]["input type"]==I_SELECT&&(this.cells[newCell].input.option(info.i),this.cells[newCell].input.selected(info.i)),blockConfig[this.cells[newCell].type]["input type"]!=I_TEXT&&blockConfig[this.cells[newCell].type]["input type"]!=I_TEXT_AREA||(this.cells[newCell].type==T_BLOCK?this.cells[newCell].input.value(info.i):this.cells[newCell].input.value(info.d)),this.cells[newCell].refresh(this.viewXdelta,this.viewYdelta),1!=this.cells[newCell].hide&&0!=showGUI||this.cells[newCell].hideBlock(),this.cells[newCell].updateAllDivPositions(),this.rebuildMenuFlag=!0}nudgeX(x){jlog("Cells","nudgeX");let nudgeVal=0;for(let i=0;i<this.length;i++)this.cells[i].x<x&&(nudgeVal=max(nudgeVal,x-this.cells[i].x));for(let i=0;i<this.length;i++)this.cells[i].moveC(this.cells[i].x+nudgeVal,this.cells[i].y,this.viewXdelta,this.viewYdelta)}putInAddyBar(smaller=!1){jlog("Cells","putInAddyBar");let myURL=getURL();-1!=myURL.indexOf("#")&&(myURL=myURL.slice(0,myURL.indexOf("#")));let myJSONString=JSON.stringify(this.saveCells(smaller));return 1==this.createMode&&(this.presBackup.layout=this.getLayoutArray(),myJSONString=JSON.stringify(this.presBackup)),myURL+"#"+encodeURIComponent(myJSONString)}makeFromAddyBar(myString=getURL()){if(jlog("Cells","makeFromAddyBar"),-1==myString.indexOf("#"))return!1;try{let myURI=myString.slice(myString.indexOf("#")+1);"#"==myURI[0]&&(myURI=myURI.slice(1));let myJSONString=decodeURIComponent(myURI),myLoaderMap=JSON.parse(myJSONString),layoutIndex=Object.keys(myLoaderMap).indexOf("layout");for(key in-1!=layoutIndex&&(cells.layoutArray=myLoaderMap.layout),Object.keys(myLoaderMap))key!=layoutIndex&&this.addCellWithInfo(myLoaderMap[key]);for(key in Object.keys(myLoaderMap))key!=layoutIndex&&this.linkChildren(key,myLoaderMap[key]);if(1==showGUI)for(let i=0;i<this.length;i++)this.cells[i].reshape(!0);else for(let i=0;i<this.length;i++)this.cells[i].hideBlock()}catch(e){return console.log("failed to load",e),!1}return!0}linkChildren(ind,info){jlog("Cells","linkChildren");let id=parseInt(ind);info.c||(info.c=[]);for(let i=0;i<info.c.length;i++)this.cells[id].forcefullyAddChildren(info.c[i],this.cells[info.c[i]],!0)}pushChild(type,myBlockIndex,myBlock,childData){jlog("Cells","pushChild");let c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],child=new Cell(type,myBlock.viewX,myBlock.viewY,this.dWidth,this.dHeight,c,this.dRadius);return child.updateDataSH(childData),child.input.value(childData,childData),myBlock.addChild(this.length,child),child.addParent(myBlockIndex,myBlock),this.cells.push(child),this.rebuildMenuFlag=!0,myBlock.reshape(),child}replaceWithType(type,parent,oldBlock,targetIndex,source){jlog("Cells","replaceWithType");let c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],child=new Cell(type,oldBlock.viewX,oldBlock.viewY,this.dWidth,this.dHeight,c,this.dRadius);child.parent=oldBlock.parent;let indexInParent=parent.childIndicies.indexOf(targetIndex);return parent.children[indexInParent]=child,oldBlock.mode=M_DELETE,oldBlock.cleanForDeletionSafe(),oldBlock.mode=M_IDLE,this.cells[targetIndex]=child,this.mapAndLink(),this.cells[targetIndex].updateDataSH(source.dataSH,!0),this.cells[targetIndex].updateHandleSH(source.handleSH),child}addCell(type,startX,y=17){jlog("Cells","addCell"),this.rebuildMenuFlag=!0,this.mapAndLink();let x=startX,c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]];type==T_START&&(c=[this.colors[type],this.highlights[type],this.colors[49],this.inverted[type],this.dualtone[type]]),this.cells.push(new Cell(type,x,y,this.dWidth,this.dHeight,c,this.dRadius));let pIndex=this.length-1;if(type==T_PRINT&&(c=[this.colors[T_VAR],this.highlights[T_VAR],this.lowlights[T_VAR],this.inverted[T_VAR],this.dualtone[T_VAR]],this.cells.push(new Cell(T_VAR,x,y,this.dWidth,this.dHeight,c,this.dRadius)),this.cells[pIndex].addChild(pIndex+1,this.cells[pIndex+1]),this.cells[pIndex+1].addParent(pIndex,this.cells[pIndex]),this.cells[pIndex+1].input.option("unset","unset"),this.cells[pIndex+1].input.selected("unset")),type==T_INPUT){let tempID=this.getID(4);this.cells[pIndex].updateHandleSH(tempID),this.varHandles.push(tempID)}if(type==T_IF||type==T_WHILE||type==T_FOR){let counter=2;type==T_FOR?(this.cells.push(new Cell(T_RANGE,x,y,this.dWidth,this.dHeight,[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],this.dRadius)),this.cells[pIndex+1].updateHandleSH("unset")):this.cells.push(new Cell(T_CONDITION,x,y,this.dWidth,this.dHeight,[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],this.dRadius)),this.cells.push(new Cell(T_DO,x,y,this.dWidth,this.dHeight,[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],this.dRadius));for(let i=1;i<=counter;i++)this.cells[pIndex].addChild(pIndex+i,this.cells[pIndex+i],!0),this.cells[pIndex+i].addParent(pIndex,this.cells[pIndex],!0);this.cells[pIndex].refresh(this.viewXdelta,this.viewYdelta)}if(-1!=blockConfig[type]["accept child"].indexOf(T_INDEX)){this.cells.push(new Cell(T_INDEX,x,y,this.dWidth,this.dHeight,[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],this.dRadius));let cIndex=this.length-1;this.cells[pIndex].addChild(cIndex,this.cells[cIndex]),this.cells[cIndex].addParent(pIndex,this.cells[pIndex])}if(-1!=blockConfig[type]["accept child"].indexOf(T_REF)){this.cells.push(new Cell(T_REF,x,y,this.dWidth,this.dHeight,[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],this.dRadius));let cIndex=this.length-1;this.cells[pIndex].addChild(cIndex,this.cells[cIndex]),this.cells[cIndex].addParent(pIndex,this.cells[pIndex])}if(-1!=blockConfig[type]["accept child"].indexOf(T_OUTLET)&&(this.cells.push(new Cell(T_OUTLET,x,y,this.dWidth,this.dHeight,[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]],this.dRadius)),this.cells[pIndex].addChild(pIndex+1,this.cells[pIndex+1]),this.cells[pIndex+1].addParent(pIndex,this.cells[pIndex]),this.cells[pIndex+1].handleSH="unset",this.cells[pIndex+1].indexLabeldiv.html(this.cells[pIndex+1].textLabel),this.cells[pIndex+1].updateDataSH("unset"),this.cells[pIndex+1].input.option("unset","unset"),this.cells[pIndex+1].input.selected("unset"),-1==this.varHandles.indexOf("unset")&&this.varHandles.push("unset")),type==T_BLOCK){let tempID=this.getID(2);this.cells[pIndex].updateHandleSH(tempID),this.cells[pIndex].input.value(tempID,tempID)}if(this.cells[pIndex].reshape(),type!=T_START&&type!=T_CONSOLE&&(this.cells[pIndex].mode=M_NEW,this.activeIndex=pIndex),type==T_TURTLE){let index=this.length;for(let i=0;i<turtleVars.length;i++)this.cells.push(new Cell(T_INLET,x,y,this.dWidth,this.dHeight,c,this.dRadius)),this.cells[index+i].updateHandleSH(turtleVars[i]),this.cells[index+i].updateDataSH(0),this.cells[pIndex].addChild(index+i,this.cells[index+i]),this.cells[index+i].addParent(pIndex,this.cells[pIndex])}for(let i=pIndex;i<this.length;i++)this.cellsInView.push(i);0==showGUI&&this.cells[pIndex].hideBlock()}quickClear(brutal=!1){jlog("Cells","quickClear");let start=0;1==brutal&&(start=0);for(let i=start;i<this.length;i++)this.cells[i].indexLabeldiv.remove(),this.cells[i].input&&this.cells[i].input.remove();0==brutal&&(this.cells[0].children=[],this.cells[0].resetDims(!0),this.cells[0].childIndicies=[],this.cells[1].reshape(!0),this.cells.splice(2))}getID(count){jlog("Cells","getID");let tempID="";for(let i=0;i<count;i++)tempID+=this.varNames[floor(random(0,this.varNames.length))];return-1!=this.varHandles.indexOf(tempID)&&(tempID=this.getID()),tempID}checkSelected(x,y){jlog("Cells","checkSelected");let inArea=!1;if(-1!=this.activeIndex&&this.cells[this.activeIndex].mode==M_NEW)return this.cells[this.activeIndex].mode=M_MOVE,!0;for(let j=0;j<this.cellsInView.length;j++){let i=this.cellsInView[j];if(!0===this.cells[i].inArea(x,y)){if(inArea=!0,this.cells[i].mode=M_SELECTED,!0===this.cells[i].checkButtons(x,y)){this.activeIndex=i;break}}else this.cells[i].mode=M_IDLE,this.activeIndex=-1}return inArea}pprint(myStr){jlog("Cells","pprint");for(let i=0;i<this.cells.length;i++)String(i)+"\t";for(let i=0;i<this.cells.length;i++)String(this.cells[i].mode)+"\t";for(let i=0;i<this.cells.length;i++)String(this.cells[i].childIndicies.length)+"\t";for(let i=0;i<this.cells.length;i++)if(this.cells[i].childIndicies.length>0){"Cell "+String(i)+"\t\t\t";for(let j=0;j<this.cells[i].childIndicies.length;j++)String(this.cells[i].childIndicies[j])+"\t";"\n"}}startStop(x,y,mdown){jlog("Cells","startStop"),this.run=!this.run,this.cells[this.activeIndex].mode=M_IDLE,this.cells[this.activeIndex].toggleStartForm(this.run)}stop(){jlog("Cells","stop"),this.run=!1,this.cells[0].toggleStartForm(!1)}doDelete(x,y,mdown){jlog("Cells","doDelete"),this.rebuildMenuFlag=!0;let gotoVarHandleCatcher=[],rebuildFlag=!1,delHandle=[];if(1==this.length)this.cells[0].cleanForDeletionSafe(),this.cells=[];else{this.cells[this.activeIndex].markForDeletion();let map=[];for(let i=0;i<this.length;i++){if(this.cells[i].mode!=M_DELETE)map.push(i);else{this.cells[i].handleSH&&(rebuildFlag=!0,this.cells[i].type!=T_INPUT&&this.cells[i].type!=T_BLOCK&&gotoVarHandleCatcher.push(this.cells[i].handleSH),"unset"!=this.cells[i].handleSH&&(delHandle.push(this.cells[i].handleSH),this.varHandles.splice(this.varHandles.indexOf(this.cells[i].handleSH),1)));let tdv=this.cellsInView.indexOf(i);-1!=tdv&&(this.cellsInView.splice(tdv,1),this.parentFlag+=1)}let parent=this.cells[i].cleanForDeletionSafe();if(-1!=parent&&this.cells[parent]){let pParent=this.cells[parent].removeChild(i);for(;-1!=pParent;)this.cells[pParent]&&(this.cells[pParent].minHeight=0,this.cells[pParent].reshape(!0),pParent=this.cells[pParent].parent)}}for(let i=0;i<this.length;i++)for(let j=0;j<this.cells[i].childIndicies.length;j++){let oldCI=this.cells[i].childIndicies[j],oldPI=i,newCI=map.indexOf(oldCI),newPI=map.indexOf(oldPI);this.cells[oldCI].parent=newPI,this.cells[i].childIndicies[j]=newCI}let newCells=[];for(let i=0;i<map.length;i++)newCells.push(this.cells[map[i]]);this.cells=newCells}if(this.activeIndex=-1,!0===rebuildFlag){for(let i=0;i<this.length;i++)blockConfig[this.cells[i].type]["input type"]==I_SELECT&&(this.cells[i].input.remove(),this.cells[i].buildDivs());for(let i=0;i<this.length;i++)blockConfig[this.cells[i].type]["input type"]==I_SELECT&&(-1!=delHandle.indexOf(this.cells[i].handleSH)&&-1==gotoVarHandleCatcher.indexOf(this.cells[i].handleSH)?this.cells[i].input.option("unset"):(this.cells[i].input.option(this.cells[i].handleSH),this.cells[i].input.selected(this.cells[i].handleSH)))}}doCopy(programatic=!1,parent=-1){jlog("Cells","doCopy");let type=this.cells[this.activeIndex].type,x=this.cells[this.activeIndex].x,y=this.cells[this.activeIndex].y,c=this.cells[this.activeIndex].colors,handle=this.cells[this.activeIndex].handleSH,val=this.cells[this.activeIndex].dataSH,opts=this.cells[this.activeIndex].inputOptions;this.cells[this.activeIndex].mode=M_IDLE;const oldAI=this.activeIndex;this.activeIndex=this.length;let iCanHasChild=!0;type==T_BLOCK&&(iCanHasChild=!1,type=T_GOTO,c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]]),type!=T_INPUT&&type!=T_RANGE||(iCanHasChild=!1,type=T_VAR,c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]]),0==programatic&&type==T_OUTLET&&(iCanHasChild=!1,type=T_VAR,c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]]),type==T_INLET&&(iCanHasChild=!1,type=T_VAR),this.cells.push(new Cell(type,x,y,this.dWidth,this.dHeight,c,this.dRadius));let newAI=this.activeIndex;if(this.cells[this.activeIndex].mode=M_NEW,this.cells[this.activeIndex].handleSH=handle,this.cells[this.activeIndex].dataSH=val,-1!=parent&&(this.cells[this.activeIndex].parent=parent),blockConfig[type]["input type"]==I_SELECT){for(let i=0;i<opts.length;i++)this.cells[this.activeIndex].inputOptions.push(opts[i]);this.cells[newAI].input.selected(this.cells[newAI].handleSH)}if(blockConfig[type]["input type"]==I_TEXT&&this.cells[this.activeIndex].input.value(val,val),1==iCanHasChild){const childrenStart=this.length;for(let i=0;i<this.cells[oldAI].childIndicies.length;i++)this.activeIndex=this.cells[oldAI].childIndicies[i],this.doCopy(!0,newAI);this.activeIndex=newAI;for(let i=childrenStart;i<this.length;i++){this.cells[i].mode=M_IDLE;let parentIndex=this.cells[i].parent;this.cells[parentIndex].addChild(i,this.cells[i]),this.cells[i].addParent(parentIndex,this.cells[parentIndex])}if(this.cells[this.activeIndex].mode=M_NEW,1==programatic)for(let i=this.length-1;i!=newAI;i--)this.cells[i].minHeight=0,this.cells[i].reshape(!0);this.mapAndLink()}}doMove(x,y,mdown){jlog("Cells","doMove"),this.cells[this.activeIndex].moveC(x,y,this.viewXdelta,this.viewYdelta),-1!=this.cells[this.activeIndex].parent&&(this.cells[this.cells[this.activeIndex].parent].removeChild(this.activeIndex),this.cells[this.activeIndex].removeParent())}doParentDrop(x,y,mdown){jlog("Cells","doParentDrop");let pParentIndexes=[];if(this.cells[this.activeIndex].type!=T_START)for(let j=0;j<this.cellsInView.length;j++){let i=this.cellsInView[j];!0===this.cells[i].inArea(x,y)&&i!=this.activeIndex?this.cells[i].underneath=mdown||this.cells[this.activeIndex].mode==M_NEW:this.cells[i].underneath=!1,!0===this.cells[i].inArea(x,y)&&i!=this.activeIndex?this.cells[i].acceptsChild(this.cells[this.activeIndex].type)&&(this.cells[i].highlight=mdown||this.cells[this.activeIndex].mode==M_NEW,pParentIndexes.push(i)):this.cells[i].highlight=!1}if(!1===mdown&&this.cells[this.activeIndex].mode==M_MOVE){if(0!=pParentIndexes.length){let parentTree=[];for(let i=0;i<pParentIndexes.length;i++){let branch=1;for(parent=this.cells[pParentIndexes[i]].parent;-1!=parent;)branch+=1,this.cells[parent].type==T_GOTO?parent=-1:parent=this.cells[parent].parent;parentTree.push(branch)}let pParentIndex=pParentIndexes[parentTree.indexOf(max(parentTree))];-1!=this.cells[this.activeIndex].parent&&(this.cells[this.cells[this.activeIndex].parent].removeChild(this.activeIndex),this.cells[this.activeIndex].removeParent()),1==this.cells[pParentIndex].addChild(this.activeIndex,this.cells[this.activeIndex])&&(this.parentFlag+=1,this.cells[this.activeIndex].addParent(pParentIndex,this.cells[pParentIndex]),this.cells[pParentIndex].refresh(this.viewXdelta,this.viewYdelta),this.parentWidthRecord=[pParentIndex,this.cells[pParentIndex].width])}this.cells[this.activeIndex].mode=M_IDLE,this.activeIndex=-1}}clean(){jlog("Cells","clean");for(let i=0;i<this.length;i++)-1!=this.cells[i].parent&&console.log(this.cells[this.cells[i].parent].childIndicies.indexOf(i))}mapAndLink(){jlog("Cells","mapAndLink");let map={};map[T_GOTO]=[],map[T_PUSH]=[],map[T_DELETE]=[],map[T_GET]=[],map[T_RUN]=[],map[T_SET]=[],map[T_LEN]=[],map[T_VAR]=[],map[T_OUTLET]=[],map[T_RANGE]=[];let varTable={};for(let i=0;i<this.length;i++){if(this.cells[i].updateSHs(),this.cells[i].type!=T_WHILE&&this.cells[i].type!=T_IF&&this.cells[i].type!=T_FOR&&this.cells[i].type!=T_CONDITION&&this.cells[i].type!=T_RANGE||(this.cells[i].dataSH=B_UNSET),this.cells[i].type==T_CONST){let nothing;this.cells[i].handleSH=nothing}this.cells[i].type==T_INPUT&&(map[T_VAR].push(this.cells[i].handleSH),map[T_OUTLET].push(this.cells[i].handleSH),map[T_PUSH].push(this.cells[i].handleSH),map[T_DELETE].push(this.cells[i].handleSH),map[T_GET].push(this.cells[i].handleSH),map[T_SET].push(this.cells[i].handleSH),map[T_RANGE].push(this.cells[i].handleSH),map[T_LEN].push(this.cells[i].handleSH),0==this.run&&(varTable[this.cells[i].handleSH]=this.cells[i].getDataSH())),this.cells[i].type==T_BLOCK&&(map[T_GOTO].push(this.cells[i].handleSH),map[T_PUSH].push(this.cells[i].handleSH),map[T_DELETE].push(this.cells[i].handleSH),map[T_GET].push(this.cells[i].handleSH),map[T_RUN].push(this.cells[i].handleSH),map[T_SET].push(this.cells[i].handleSH),map[T_LEN].push(this.cells[i].handleSH)),this.cells[i].reshape()}map[T_VAR]=map[T_VAR].concat(["unset","random","year","month#","monthS","day#","dayS","hour","minute","second","millis"]),map[T_OUTLET].push("unset"),map[T_RANGE].push("unset"),map[T_GOTO].push("unset"),map[T_PUSH].push("unset"),map[T_DELETE].push("unset"),map[T_GET].push("unset"),map[T_RUN].push("unset"),map[T_SET].push("unset"),map[T_LEN].push("unset");for(let i=0;i<this.length;i++)0!=this.run&&-1==this.partialUpdate.indexOf(i)||(this.cells[i].updateOptions(map),this.cells[i].type==T_VAR&&(this.cells[i].dataSH=varTable[this.cells[i].handleSH]),this.cells[i].mode==M_DELETE&&this.cells[i].cleanForDeletionSafe())}doMutate(){jlog("Cells","doMutate"),this.rebuildMenuFlag=!0;let ac=this.cells[this.activeIndex];ac.mode=M_IDLE;let type=blockConfig[ac.type].handles.mutate,data=ac.dataSH,handle=ac.handleSH,pInd=ac.parent,parent=this.cells[ac.parent],children=ac.children,childIndicies=ac.childIndicies;ac.indexLabeldiv.remove(),blockConfig[ac.type]["input type"]!=I_NONE&&(ac.input.remove(),ac.input.remove());let inParentIndex=0;-1!=pInd&&(inParentIndex=parent.childIndicies.indexOf(this.activeIndex)),ac.mode=M_IDLE;let c=[this.colors[type],this.highlights[type],this.lowlights[type],this.inverted[type],this.dualtone[type]];this.cells[this.activeIndex]=new Cell(type,ac.x,ac.y,this.dWidth,this.dHeight,c,this.dRadius),this.cells[this.activeIndex].dataSH=data,this.cells[this.activeIndex].handleSH=handle,this.cells[this.activeIndex].children=children,this.cells[this.activeIndex].childIndicies=childIndicies,this.cells[this.activeIndex].parent=pInd,-1!=pInd&&(parent.children[inParentIndex]=this.cells[this.activeIndex]);for(let i=0;i<this.cells[this.activeIndex].children.length;i++)-1!=[T_CONDITION,T_ELSE,T_DO,T_OUTLET,T_INDEX,T_REF].indexOf(this.cells[this.activeIndex].children[i].type)&&(this.cells[this.activeIndex].children[i].colors=c,this.cells[this.activeIndex].children[i].reStyle());if(type==T_SQRT){for(let i=2;i<this.cells[this.activeIndex].children.length;i++)this.cells[this.activeIndex].children[i].hideBlock();this.cells[this.activeIndex].minHeight=0,this.cells[this.activeIndex].reshape()}else for(let i=2;i<this.cells[this.activeIndex].children.length;i++)this.cells[this.activeIndex].children[i].showBlock();if(type==T_INPUT){let tempID=this.getID(4);this.cells[this.activeIndex].updateHandleSH(tempID),this.cells[this.activeIndex].input.value(data,data),this.varHandles.push(tempID)}this.cells[this.activeIndex].mode=M_IDLE,this.cells[this.activeIndex].reshape(this.viewXdelta,this.viewYdelta),-1!=pInd&&parent.reshape(this.viewXdelta,this.viewYdelta)}hideAll(exceptions=[12345675435678366e10]){for(let i=0;i<this.length;i++)-1==exceptions.indexOf(this.cells[i].type)&&this.cells[i].hideBlock(!1)}update(x,y,mdown){if(jlog("Cells","update"),this.parentFlag>0){if(this.reshapeAllInView(),-1!=this.parentWidthRecord[0]){let delta=this.cells[this.parentWidthRecord[0]].width-this.parentWidthRecord[1];for(let i=0;i<this.length;i++)this.cells[i].x>this.cells[this.parentWidthRecord[0]].x&&this.cells[i].pushX(delta);this.reshapeAllInView()}this.parentWidthRecord=[-1,0],this.parentFlag-=1}if(0==this.run){if(-1!=this.activeIndex)if(this.cells[this.activeIndex].mode==M_MUTATE&&this.doMutate(),this.cells[this.activeIndex].mode==M_NEW&&this.doMove(x,y,!0),this.cells[this.activeIndex].mode==M_START&&this.startStop(x,y,mdown),this.cells[this.activeIndex].mode==M_DELETE)this.doDelete(x,y,mdown),this.mapAndLink();else{if(!0===mdown&&this.cells[this.activeIndex].mode==M_MOVE&&this.doMove(x,y,mdown),!0===mdown&&this.cells[this.activeIndex].mode==M_RESIZE&&(this.parentFlag=2,this.cells[this.activeIndex].resizeC(x,y)),!0===mdown&&this.cells[this.activeIndex].mode==M_EXPAND_OR_COLLAPSE)if(this.cells[this.activeIndex].type==T_LAYOUT_BLOCK)this.newLayoutBlock(this.getLayoutBlockBelowName(this.cells[this.activeIndex].handleSH),this.cells[this.activeIndex].x,this.cells[this.activeIndex].y+this.cells[this.activeIndex].height+5),this.cells[this.activeIndex].mode=M_IDLE;else if(this.parentFlag=2,this.cells[this.activeIndex].expandOrCollapse(),1==this.cells[this.activeIndex].shrink){let parent=this.cells[this.activeIndex].parent;for(;-1!=parent;)this.cells[parent].minHeight=0,this.cells[parent].reshape(!0),parent=this.cells[parent].parent}!0===mdown&&this.cells[this.activeIndex].mode==M_COPY&&(this.cells[this.activeIndex].type==T_LAYOUT_BLOCK?(this.newLayoutBlock(this.getLayoutBlockNextName(this.cells[this.activeIndex].handleSH),this.cells[this.activeIndex].x+this.cells[this.activeIndex].width+5,this.cells[this.activeIndex].y),this.cells[this.activeIndex].mode=M_IDLE):this.doCopy()),1==this.redrawFlag&&this.doParentDrop(x,y,mdown)}this.oldMouse==mdown&&1!=selectChanged||(this.mapAndLink(),this.oldMouse=mdown,selectChanged=!1)}else this.cells[0].mode==M_START&&this.startStop(x,y,mdown)}reshapeAllInView(){jlog("Cells","reshapeAllInView");for(let i=0;i<this.cellsInView.length;i++)null!=this.cells[this.cellsInView[i]]&&this.cells[this.cellsInView[i]].reshape(this.viewX,this.viewY,!1)}hideAllDivs(){jlog("Cells","hideAllDivs");for(let i=0;i<this.length;i++)this.cells[i].indexLabeldiv.hide(),this.cells[i].hideDivs()}showAllDivs(){jlog("Cells","showAllDivs");for(let i=0;i<this.length;i++)0==this.cells[i].hide&&(this.cells[i].indexLabeldiv.show(),this.cells[i].showDivs())}updateView(xPos,yPos,doDrag){jlog("Cells","updateView"),this.viewXdelta=xPos,this.viewYdelta=yPos,this.redrawFlag=!1;for(let i=0;i<this.length;i++){if(1==this.cells[i].graphicUpdate&&(this.cells[i].graphicUpdate=!1,this.redrawFlag=!0),-1==this.cells[i].parent)this.cells[i].updateView(this.viewXdelta,this.viewYdelta);else{let parType=this.cells[this.cells[i].parent].type,cType=this.cells[i].type;-1==blockConfig[parType]["accept child"].indexOf(cType)&&this.cells[i].updateView(this.viewXdelta,this.viewYdelta)}1==doDrag&&-1!=this.cellsInView.indexOf(i)&&(this.cells[i].updateAllDivPositions(),this.cells[i].refresh())}}cellInView(cell){jlog("Cells","cellInView");let inview=!1,xMin=-1*cell.width,xMax=windowWidth,yMin=-1*cell.height,yMax=windowHeight;return xMin<cell.viewX&&cell.viewX<xMax&&yMin<cell.viewY&&cell.viewY<yMax&&(inview=!0),inview}draw(canvas=null){jlog("Cells","draw"),this.cellsInView=[];for(let i=0;i<this.length;i++)this.cellInView(this.cells[i]),1==this.cellInView(this.cells[i])&&(this.cells[i].draw(),this.cellsInView.push(i));-1!=this.activeIndex&&this.cells[this.activeIndex].draw()}addCellsForPres(inputCells,start=0){jlog("PresentationHelper","addCells");for(let i=start;i<inputCells.length;i++)this.addCellForPres(inputCells[i])}addCellForPres(cell){jlog("PresentationHelper","addCell"),-1!=presComponents.indexOf(cell.type)&&this.cells.push(cell)}}class Controller{constructor(){jlog("Controller","constructor"),this.script,this.envChanged=!1,this.index=0,this.stackTrace={},this.workingStack=[],this.terminate,this.run=!1,this.activeCell=null,this.running=!1,this.prevIndex=-1,this.varMap={},this.varRecord=[],this.weHaveATurtlePeople=!1,this.turtleIndex=-1,this.tBuffX=[],this.tChangeX=!1,this.tBuffY=[],this.tChangeY=!1,this.stackNotes=[],this.stackSizeRecord=[],this.objectWideFlashFlag=!0,this.tidyFlag=!1}step(flash,fastMode){jlog("Controller","step"),this.objectWideFlashFlag=flash;try{if(this.index<this.script.length){switch(this.activeCell=this.script[this.index],1==flash&&this.stackTrace.length>1&&(this.activeCell.flash=!0,this.script[this.stackTrace[this.stackTrace.length-2]].flash=!1),this.activeCell.type){case T_START:this.t_start(this.activeCell,this.index);break;case T_GOTO:this.t_goto(this.activeCell,this.index);break;case T_BLOCK:0==this.t_block(this.activeCell,this.index)&&this.moveByParent();break;case T_PRINT:this.t_print(this.activeCell,this.index),this.moveByParent();break;case T_ASSIGN:this.t_assign(this.activeCell,this.index),this.moveByParent();break;case T_ADD:case T_SUBTRACT:case T_MULT:case T_DIV:case T_MOD:case T_AVERAGE:case T_SQRT:case T_ROUND:case T_HYPOT:case T_SIN:case T_COS:this.t_math(this.activeCell,this.index),this.moveByParent();break;case T_COMMENT:case T_VAR:case T_CONST:case T_INPUT:this.addToStack(this.index),this.moveByParent();break;case T_EQUAL:case T_LESS:case T_GREATER:this.t_compare(this.activeCell,this.index),this.moveByParent();break;case T_NOT:this.t_not(this.activeCell,this.index),this.moveByParent();break;case T_IF:0==this.t_if(this.activeCell,this.index)&&this.moveByParent();break;case T_WHILE:0==this.t_while(this.activeCell,this.index)&&this.moveByParent();break;case T_FOR:0==this.t_for(this.activeCell,this.index)&&this.moveByParent();break;case T_ELSE:case T_DO:this.index=this.script[this.index].parent;break;case T_LEN:this.t_len(this.activeCell,this.index),this.moveByParent();break;case T_GET:this.t_arrayOp(this.activeCell,this.index),this.moveByParent();break;case T_RUN:let tempInd=this.index;this.t_arrayOp(this.activeCell,this.index),tempInd==this.index&&this.moveByParent();break;case T_SET:case T_PUSH:case T_DELETE:this.t_arrayOp(this.activeCell,this.index),this.moveByParent();break;default:this.script[1].indexLabeldiv.html("<br>Something is missing",!0),this.HCF()}1==this.run&&1==fastMode&&this.step(flash,fastMode)}else{this.run=!1;for(let i=0;i<cells.length;i++)cells.cells[i].flash=!1;if(this.printStack(),1==this.envChanged){this.tidyFlag=!0,this.d_print("<small>Your environment was updated.</small><br>");let button=createButton("reset env");button.addClass("basic"),button.parent(cells.cells[1].indexLabeldiv),button.mousePressed(loadBackup),cells.cells[1].indexLabeldiv.html("<br>",!0),this.script[1].lineNumber+=1,this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber}}}catch(error){this.HCF(),this.script[1].indexLabeldiv.html("\n"+error,!0),console.log(error)}}updateVarMap(key,data){jlog("Controller","updateVarMap"),"turtleX"==key&&(this.tChangeX=!0),"turtleY"==key&&(this.tChangeY=!0);for(let i=0;i<this.varMap[key].length;i++)this.varMap[key][i].updateDataSH(data);this.updateTurtle()}moveByParent(){jlog("Controller","moveByParent"),this.workingStack.length>100&&(this.script[1].indexLabeldiv.html("\n uncomfortably deep stack, time to die",!0),this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber,this.run=!1);let currentI=this.workingStack.pop();if(this.addToStack(currentI,0),this.script[currentI].flash=!1,this.script[currentI].type==T_CONDITION&&this.script[this.script[currentI].parent].type==T_IF&&(currentI=this.workingStack.pop(),this.addToStack(currentI,0)),this.script[currentI].type==T_RANGE&&this.script[this.script[currentI].parent].type==T_FOR){this.script[currentI].dataSHasType.number<this.script[this.script[currentI].parent].dataSHasType.number&&(this.script[this.script[currentI].parent].updateDataSH(B_UNSET),currentI=this.workingStack.pop(),this.addToStack(currentI,0))}if(this.script[currentI].type==T_CONDITION&&this.script[this.script[currentI].parent].type==T_WHILE){let shrinkStack=this.workingStack.indexOf(this.script[currentI].parent);this.workingStack=this.workingStack.slice(0,shrinkStack+1),this.addNote("shrunk working stack"),this.script[currentI].getDataSH()==B_FALSE&&(currentI=this.workingStack.pop(),this.addToStack(currentI,0))}if(this.script[currentI].flash=!1,this.workingStack.length<1)this.index=this.terminate;else{let callerI=this.workingStack[this.workingStack.length-1],callerC=this.script[callerI],curInCaller=callerC.childIndicies.indexOf(currentI);-1==curInCaller||curInCaller==callerC.childIndicies.length-1?(this.addToStack(callerI,0),this.moveByParent()):this.index=callerC.childIndicies[curInCaller+1]}}findBlock(handle){jlog("Controller","findBlock");let block=-1;for(let i=0;i<this.script.length;i++)if((this.script[i].type==T_BLOCK||this.script[i].type==T_INPUT)&&this.script[i].handleSH==handle){block=i;break}return"unset"==handle?-1:block}getValue(child,index){let data;jlog("Controller","getValue");let varType=-1;return-1!=mathFunctions.indexOf(child.type)?(this.t_math(child,index),data=child.children[0].getDataSH(),varType=V_NUMBER):-1!=boolFunctions.indexOf(child.type)&&child.type!=T_NOT?(this.t_compare(child,index),data=child.getDataSH(),varType=V_BOOL):child.type==T_LEN?(this.t_len(child,index),data=child.getDataSH(),varType=V_NUMBER):child.type==T_NOT?(this.t_not(child,index),data=child.getDataSH(),varType=V_BOOL):child.type==T_GET?(this.t_arrayOp(child,index),data=child.getDataSH(),1==/^\d+\.\d+$/.test(data)||1==/^\d+$/.test(data)||1==/^\-+\d+$/.test(data)||1==/^\-+\d+\.+\d+$/.test(data)?varType=V_NUMBER:"true"==data||"false"==data?(varType=V_BOOL,data="true"==data):varType=V_STRING):(data=child.getDataSH(),1==/^\d+\.\d+$/.test(data)||1==/^\d+$/.test(data)||1==/^\-+\d+$/.test(data)||1==/^\-+\d+\.+\d+$/.test(data)?varType=V_NUMBER:"true"==data||"false"==data?(varType=V_BOOL,data="true"==data):varType=V_STRING),{type:varType,data:data}}lookAtChildren(activeCell,index,start=0){jlog("Controller","lookAtChildren");let onlyNums=!0,onlyBools=!0,containsString=!1,vals=[],isNumbers=[];for(let i=start;i<activeCell.children.length;i++)if(activeCell.children[i].type!=T_COMMENT){let result=this.getValue(activeCell.children[i],activeCell.childIndicies[i]);vals.push(result.data),result.type==V_NUMBER?(onlyBools=!1,isNumbers.push(!0)):result.type==V_STRING?(onlyBools=!1,onlyNums=!1,containsString=!0,isNumbers.push(!1)):result.type==V_BOOL&&(onlyNums=!1,isNumbers.push(!1))}let res={};return res.onlyNums=onlyNums,res.vals=vals,res.isNumbers=isNumbers,res.onlyBools=onlyBools,res.containsString=containsString,res}evaluateCondition(onlyBools,onlyNums,vals){jlog("Controller","evaluateCondition");let res=!0,myResult=0;if(1==onlyBools){for(let i=0;i<vals.length;i++)myResult+=int(vals[i]);res=myResult==vals.length}if(1==onlyNums)for(let i=0;i<vals.length;i++)0==vals[i]&&(res=!1);return res}startStop(cells){if(jlog("Controller","startStop"),1==cells.run&&0==this.running){this.run=!0,this.running=!0,this.index=0,cells.mapAndLink(),cells.mapAndLink(),backupObject=JSON.stringify(cells.saveCells()),this.envChanged=!1,this.script=cells.cells,this.terminate=this.script.length+1,this.stackTrace={},this.stackTrace.index=[],this.stackTrace.dir=[],this.stackTrace.label=[],this.stackTrace.handle=[],this.workingStack=[0],this.varRecord=[],this.tBuffX=[],this.tBuffY=[],this.varMap={},this.varMap.outlet=[],this.weHaveATurtlePeople=!1,this.stackNotes=[],this.stackSizeRecord=[];for(let i=0;i<cells.length;i++)0==showGUI&&cells.cells[i].hideBlock(),this.script[i].type!=T_VAR&&this.script[i].type!=T_OUTLET&&this.script[i].type!=T_INPUT||(this.script[i].handleSH in this.varMap||(this.varMap[this.script[i].handleSH]=[]),this.varMap[this.script[i].handleSH].push(this.script[i])),this.script[i].type==T_TURTLE&&(this.weHaveATurtlePeople=!0,this.turtleIndex=i);for(key in this.varMap)-1==cells.varHandles.indexOf(key)&&(cells.varHandles.push(key),this.startStop(cells))}0==cells.run&&(1==this.run&&this.printStack(),this.run=!1,this.running=!1),0==this.run&&(cells.stop(),this.running=!1)}update(cells,flash,fastMode){this.startStop(cells),1==this.run&&this.step(flash,fastMode)}HCF(){jlog("Controller","HCF"),this.index=this.terminate,this.run=!1}printStack(){jlog("Controller","printStack"),0==showGUI&&cells.hideAllDivs();let readableStack={};for(let i=0;i<this.stackTrace.index.length;i++)readableStack[i]={},readableStack[i]["stack depth"]=this.stackSizeRecord[i],readableStack[i]["block index"]=this.stackTrace.index[i],readableStack[i].name=this.stackTrace.label[i],readableStack[i].handle=this.stackTrace.handle[i],readableStack[i]["data state"]=this.varRecord[i],readableStack[i].dir=1==this.stackTrace.dir[i]?"in":"out",readableStack[i]["stack notes"]="";for(let i=0;i<this.stackNotes.length;i++){let note=this.stackNotes[i];readableStack[note[0]]["stack notes"]=note[1]}1==printStack&&console.table(readableStack)}addNote(myString){jlog("Controller","addNote"),this.stackNotes.push([this.stackTrace.index.length-1,myString])}addToStack(index,dir=1){jlog("Controller","addToStack"),this.stackSizeRecord.push(this.workingStack.length),this.stackTrace.index.push(index),this.stackTrace.dir.push(dir),this.stackTrace.label.push(this.script[index].textLabel),this.stackTrace.handle.push(this.script[index].handleSH),1==dir&&(this.workingStack.push(index),this.script[index].flash=this.objectWideFlashFlag);let varRecAtom="";for(key in this.varMap)this.varMap[key].length>0?varRecAtom+=String(key)+": "+this.varMap[key][0].getDataSH()+" | ":varRecAtom+=String(key)+" ";this.varRecord.push(varRecAtom)}updateTurtle(){if(jlog("Controller","updateTurtle"),1==this.weHaveATurtlePeople&&(1==this.tChangeX&&(this.tBuffX.push(parseFloat(this.varMap.turtleX[0].getDataSH())),this.tChangeX=!1),1==this.tChangeY&&(this.tBuffY.push(parseFloat(this.varMap.turtleY[0].getDataSH())),this.tChangeY=!1),1==this.varMap.turtleDraw[0].dataSHasType.bool)){for(this.updateVarMap("turtleDraw",0);this.tBuffX.length<this.tBuffY.length;)this.tBuffX.push(this.tBuffX[this.tBuffX.length-1]);for(;this.tBuffX.length>this.tBuffY.length;)this.tBuffY.push(this.tBuffY[this.tBuffY.length-1]);for(let i=0;i<this.tBuffX.length-1;i++){let x1=this.tBuffX[i],x2=this.tBuffX[i+1],y1=this.tBuffY[i],y2=this.tBuffY[i+1];this.script[this.turtleIndex].canvas.line(x1,y1,x2,y2)}this.tBuffX=[],this.tBuffY=[]}}t_start(activeCell,index){jlog("Controller","t_start"),this.addToStack(index),0==activeCell.children.length?(this.run=!1,this.index=this.terminate):this.index=activeCell.childIndicies[0]}t_goto(activeCell,index){jlog("Controller","t_goto"),this.addToStack(index);let next=activeCell.handleSH;this.index=this.terminate;for(let i=0;i<this.script.length;i++)next==this.script[i].handleSH&&this.script[i].type==T_BLOCK&&(this.index=i)}t_block(activeCell,index){jlog("Controller","t_block"),this.addToStack(index);let stillIn=!1;return 0!=activeCell.children.length&&(stillIn=!0,this.index=activeCell.childIndicies[0]),stillIn}buildPrintString(activeCell,depth){if(jlog("Controller","buildPrintString"),(depth+=1)>20)return"max depth";let myOutput="";for(let j=0;j<activeCell.children.length;j++){if(activeCell.children[j].type==T_GET)if(this.t_arrayOp(activeCell.children[j],activeCell.childIndicies[j]),-1==String(activeCell.children[j].dataSH).indexOf("object:"))myOutput+=activeCell.children[j].dataSH;else{let myInd=this.unpackGet(activeCell.children[j]);this.script[myInd].type==T_BLOCK||this.script[myInd].type==T_GOTO?(myOutput+="[",myOutput+=this.buildPrintString(this.script[myInd],depth),myOutput+="]"):myOutput+=this.script[myInd].getDataSHForPrint()}else if(activeCell.children[j].type==T_GOTO||activeCell.children[j].type==T_BLOCK){let block=this.findBlock(activeCell.children[j].handleSH);myOutput+="[",myOutput+=-1==block?"unset":this.buildPrintString(this.script[block],depth),myOutput+="]"}else activeCell.children[j].type!=T_COMMENT&&(myOutput+=String(this.script[activeCell.childIndicies[j]].getDataSHForPrint()));j<activeCell.children.length-1&&(myOutput+=", ")}return myOutput}d_print(myString,inplace=!1,flagString=""){if(jlog("Controller","d_print"),this.script||(this.script=cells.cells),1==inplace){let htmlString=this.script[1].indexLabeldiv.html();-1!=htmlString.indexOf(flagString)&&(htmlString=htmlString.slice(0,htmlString.indexOf(flagString))),htmlString+=flagString+myString,this.script[1].indexLabeldiv.html(htmlString)}else this.script[1].indexLabeldiv.html("<br>"+myString+"<br>",!0),this.script[1].lineNumber+=1,this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber}t_print(activeCell,index){jlog("Controller","t_print"),this.addToStack(index);let myOutput=this.script[1].lineNumber+": ";0==this.script[1].lineNumber&&(myOutput="<br>"+this.script[1].lineNumber+": ");let myString=this.buildPrintString(activeCell,0).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");console.log(myString);let stringForConsole=myOutput+myString+"<br>";1==presentationMode?addToPresentation(myString,"console"):(this.script[1].indexLabeldiv.html(stringForConsole,!0),this.script[1].lineNumber+=1,this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber)}t_assign(activeCell,index){if(jlog("Controller","t_assign"),this.addToStack(index),this.lookAtChildren(activeCell,index),activeCell.children.length>1){let data=activeCell.children[0].getDataSH(),cI=activeCell.childIndicies;for(let i=1;i<cI.length;i++){let key=this.script[cI[i]].handleSH;this.updateVarMap(key,data)}}}t_math(activeCell,index){let res;jlog("Controller","t_math"),this.addToStack(index);let survey=this.lookAtChildren(activeCell,index,1),onlyNums=survey.onlyNums,vals=survey.vals;survey.isNumbers;if(onlyNums){res=parseFloat(vals[0]),activeCell.type==T_HYPOT&&(res=res**2);for(let i=1;i<vals.length;i++)switch(activeCell.type){case T_ADD:res+=parseFloat(vals[i]);break;case T_SUBTRACT:res-=parseFloat(vals[i]);break;case T_MULT:res*=parseFloat(vals[i]);break;case T_DIV:res/=parseFloat(vals[i]);break;case T_MOD:res%=parseFloat(vals[i]);break;case T_AVERAGE:res+=parseFloat(vals[i]);break;case T_HYPOT:res+=parseFloat(vals[i])**2}switch(activeCell.type){case T_SQRT:res=sqrt(res);break;case T_SIN:res=sin(res);break;case T_COS:res=cos(res);break;case T_ROUND:res=round(res)}activeCell.type==T_AVERAGE&&(res/=vals.length),activeCell.type==T_HYPOT&&(res=sqrt(res))}let output=activeCell.children[0].handleSH;this.updateVarMap(output,res)}t_compare(activeCell,index){jlog("Controller","t_compare"),this.addToStack(index);let survey=this.lookAtChildren(activeCell,index,0),onlyNums=survey.onlyNums,vals=survey.vals,res=(survey.isNumbers,!0);if(0==vals.length&&(res=!1),1==onlyNums){let prev=vals[0];for(let i=1;i<vals.length;i++){switch(activeCell.type){case T_EQUAL:prev!=vals[i]&&(res=!1);break;case T_GREATER:prev<=vals[i]&&(res=!1);break;case T_LESS:prev>=vals[i]&&(res=!1)}prev=vals[i]}}else{let prev=vals[0];for(let i=1;i<vals.length;i++){switch(activeCell.type){case T_EQUAL:prev!=vals[i]&&(res=!1);break;case T_GREATER:case T_LESS:res=!1}prev=vals[i]}}activeCell.dataSH=res}t_not(activeCell,index){jlog("Controller","t_not"),this.addToStack(index);let survey=this.lookAtChildren(activeCell,index,0),onlyNums=survey.onlyNums,vals=survey.vals,onlyBools=(survey.containsString,survey.isNumbers,survey.onlyBools),res=this.evaluateCondition(onlyBools,onlyNums,vals);res=!res,activeCell.dataSH=res}t_if(activeCell,index){jlog("Controller","t_if"),this.addToStack(index);let conditions=activeCell.children[0];activeCell.dataSH=B_UNSET,this.t_condition(conditions,activeCell.childIndicies[0]);let res=!1;conditions.getDataSH()==B_TRUE&&(res=!0);let yes=activeCell.children[1],stillIn=(activeCell.children[2],!1);return 1==res?(activeCell.dataSH=B_TRUE,this.addToStack(activeCell.childIndicies[1]),0!=yes.children.length&&(this.index=yes.childIndicies[0],stillIn=!0)):activeCell.dataSH=B_FALSE,stillIn}runChildren(childs,indix){jlog("Controller","runChildren");for(let i=0;i<childs.length;i++)switch(childs[i].type){case T_EQUAL:case T_LESS:case T_GREATER:this.t_compare(childs[i],indix[i]);break;case T_NOT:this.t_not(childs[i],indix[i])}}t_condition(activeCell,index){jlog("Controller","t_condition"),this.addToStack(index),activeCell.dataSH=B_UNSET;let survey=this.lookAtChildren(activeCell,index,0),res=this.evaluateCondition(survey.onlyBools,survey.onlyNums,survey.vals);activeCell.dataSH=1==res?B_TRUE:B_FALSE}t_for(activeCell,index){jlog("Controller","t_for"),this.addToStack(index);let stillIn=!1;if(activeCell.children[0].children.length>0){this.addToStack(activeCell.childIndicies[0]),activeCell.children[0].children[0].type==T_LEN&&this.t_len(activeCell.children[0].children[0],activeCell.children[0].childIndicies[0]);let repeats=activeCell.children[0].children[0].dataSHasType.number;activeCell.children[0].updateDataSH(repeats),activeCell.updateDataSH(activeCell.dataSHasType.number+1),activeCell.dataSH<=repeats&&(stillIn=!0),this.updateVarMap(activeCell.children[0].handleSH,activeCell.dataSHasType.number-1)}return 1==stillIn&&activeCell.children[1].children.length>0&&(this.addToStack(activeCell.childIndicies[1]),this.index=activeCell.children[1].childIndicies[0]),stillIn}t_while(activeCell,index){jlog("Controller","t_while"),this.addToStack(index);let conditions=activeCell.children[0];activeCell.dataSH=B_UNSET,this.t_condition(conditions,activeCell.childIndicies[0]);let res=!1;conditions.getDataSH()==B_TRUE&&(res=!0);let yes=activeCell.children[1],stillIn=!1;return 1==res?(activeCell.dataSH=B_TRUE,this.addToStack(activeCell.childIndicies[1]),0!=yes.children.length&&(this.index=yes.childIndicies[0],stillIn=!0)):(activeCell.dataSH=B_FALSE,stillIn=!1),stillIn}t_len(activeCell,index){jlog("Controller","t_len"),this.addToStack(index);let blockIndex=this.findBlock(activeCell.handleSH);-1!=blockIndex&&(activeCell.dataSH=-1,this.script[blockIndex].type==T_INPUT?activeCell.updateDataSH(this.script[blockIndex].dataSHasType.string.length):activeCell.updateDataSH(this.script[blockIndex].children.length))}unpackGet(getBlock){if(jlog("Controller","unpackGet"),-1!=getBlock.dataSH.indexOf("object:")){let index=parseInt(getBlock.dataSH.slice("object:".length));return"undefined"==String(this.script[index].handleSH)?index:this.findBlock(this.script[index].handleSH)}return getBlock.dataSH}t_arrayOp(activeCell,index){if(jlog("Controller","t_arrayOp"),this.addToStack(index),0==activeCell.children[0].children.length)return;let blockIndex=this.findBlock(activeCell.handleSH);if(-1==blockIndex||activeCell.children.length<1||"unset"==activeCell.handleSH)return void activeCell.updateDataSH(-1);this.tidyFlag=!0;let blockType=this.script[blockIndex].type,myInd=parseInt(activeCell.children[0].children[0].dataSH);if(activeCell.type==T_GET||activeCell.type==T_RUN)if(this.tidyFlag=!1,blockType==T_INPUT){let target=String(this.script[blockIndex].dataSH),dataval=target[myInd%target.length];activeCell.updateDataSH(dataval)}else{let children=this.script[blockIndex].children,child=children[myInd%children.length];for(;myInd<0;)myInd+=children.length;myInd%=children.length;let childInd=this.script[blockIndex].childIndicies[myInd];if(activeCell.type==T_RUN&&(child.type==T_BLOCK||child.type==T_GOTO))return void(this.index=childInd);this.addToStack(childInd),"undefined"!=String(child.dataSH)?activeCell.updateDataSH(child.dataSH):activeCell.updateDataSH("object:"+this.script[blockIndex].childIndicies[myInd])}else if(activeCell.type==T_PUSH){this.lookAtChildren(activeCell.children[0],activeCell.childIndicies[0],0),this.envChanged=!0;let childData=0;if(activeCell.children[0].children.length>0&&(childData=activeCell.children[0].children[0].getDataSH()),blockType==T_INPUT){this.script[blockIndex].updateDataSH(this.script[blockIndex].dataSHasType.string+String(childData),!0);let output=this.script[blockIndex].handleSH;this.updateVarMap(output,this.script[blockIndex].getDataSH())}else{let type=T_CONST;activeCell.children[0].children[0].type==T_GOTO&&(type=T_GOTO);let newChild=cells.pushChild(type,blockIndex,this.script[blockIndex],childData);type==T_GOTO&&(newChild.updateHandleSH(activeCell.children[0].children[0].handleSH),newChild.forceHandleSH=!0),this.script.push(newChild),this.terminate=this.script.length+1}}else if(activeCell.type==T_SET){this.lookAtChildren(activeCell.children[0],activeCell.childIndicies[0],0),this.lookAtChildren(activeCell.children[1],activeCell.childIndicies[1],0),this.envChanged=!0;let newVal=String(activeCell.children[1].children[0].getDataSH());if(blockType==T_INPUT){newVal=newVal[0];let oldData=this.script[blockIndex].dataSHasType.string;myInd%=oldData.length;let newData=oldData.substring(0,myInd)+newVal+oldData.substring(myInd+1);this.script[blockIndex].updateDataSH(newData,!0);let output=this.script[blockIndex].handleSH;this.updateVarMap(output,this.script[blockIndex].getDataSH())}else{let sourceType=activeCell.children[1].children[0].type;sourceType==T_GET&&(sourceType=T_CONST),myInd%=this.script[blockIndex].children.length;let target=this.script[blockIndex].children[myInd],targetI=this.script[blockIndex].childIndicies[myInd];cells.replaceWithType(sourceType,this.script[blockIndex],target,targetI,activeCell.children[1].children[0]),this.script=cells.cells}}else if(activeCell.type==T_DELETE)if(this.envChanged=!0,blockType==T_INPUT){let data=this.script[blockIndex].dataSHasType.string;myInd%=data.length;let newData=data.slice(0,myInd)+data.slice(myInd+1);this.script[blockIndex].updateDataSH(newData,!0),this.updateVarMap(this.script[blockIndex].handleSH,this.script[blockIndex].getDataSH())}else{if(0==this.script[blockIndex].children.length)return;myInd%=this.script[blockIndex].children.length;let indexToDelete=this.script[blockIndex].childIndicies[myInd];cells.cells[indexToDelete].markForDeletion();let deleted=[];for(let i=0;i<cells.length;i++)cells.cells[i].mode==M_DELETE&&deleted.push(i);cells.activeIndex=indexToDelete,cells.doDelete(),this.script=cells.cells,this.terminate-=deleted.length;for(let j=0;j<deleted.length;j++)for(let i=0;i<this.workingStack.length;i++)this.workingStack[i]>deleted[j]&&(this.workingStack[i]-=1)}}}function newCell(type,x=-1,y=-1){jlog("Main","newCell"),type=int(type);let presAddStart=0;0==mobileDeviceDetected?(presAddStart=cells.length,cells.addCell(type,x,y),pres.addCellsForPres(cells.cells,presAddStart)):1==mobileHAddon?(presAddStart=cells.length,cells.addCell(mobileHType,x,y),pres.addCellsForPres(cells.cells,pas),mobileHAddon=!1):(mobileHType=type,mobileHAddon=!0),myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv()}function setTidyFlag(){jlog("Main","tidy"),tidyFlag=3}function tidy(){if(jlog("Main","tidy"),0==cells.run){if(runMode==RM_NORMAL){let xOffset=2*myDivs.menu.x+myDivs.menu.size().width;cells.tidy(round(xOffset/(gridSize/2))*(gridSize/2),gridSize),1==zoomMode&&cells.update(mouseX,mouseY,mouseIsPressed)}if(runMode==RM_CREATE){let yOffset=2*myDivs.presTools.y+myDivs.presTools.size().height;pres.tidy(myDivs.presTools.x/pixelDensity(),yOffset),1==zoomMode&&pres.update(mouseX,mouseY,mouseIsPressed)}}}function colorSetup(){jlog("Main","colorSetup");let cvals,m,colors=[],icolors=[],dtcolors=[],highlights=[],lowlights=[];for(let i=0;i<c.length;i++)colors.push(color("#"+c[i]));delete c;for(let i=0;i<colors.length;i++)cvals=colors[i].levels[0]+colors[i].levels[1]+colors[i].levels[2],m=(colors[i].maxes.rgb[0]+colors[i].maxes.rgb[1]+colors[i].maxes.rgb[2])/2,icolors.push(color(colors[i].maxes.rgb[0]-colors[i].levels[0],colors[i].maxes.rgb[1]-colors[i].levels[1],colors[i].maxes.rgb[2]-colors[i].levels[2])),cvals>m?(highlights.push(lerpColor(colors[i],color(0),.7)),lowlights.push(lerpColor(colors[i],color(255),.2)),dtcolors.push(color(0))):(highlights.push(lerpColor(colors[i],color(255),.7)),lowlights.push(lerpColor(colors[i],color(0),.2)),dtcolors.push(color(255)));allColors.colors=colors,allColors.icolors=icolors,allColors.dtcolors=dtcolors,allColors.highlights=highlights,allColors.lowlights=lowlights}function saveCells(wip=!1){jlog("Main","saveCells");let map=cells.saveCells();console.log(JSON.stringify(map));let name="demo"+String(demos.length)+".json";1==wip&&(name="wip-demo.json"),save(map,name,!0),setTidyFlag()}function loadBackup(){jlog("Main","loadBackup");let consoleTextLabel=cells.cells[1].indexLabeldiv.html(),lineNumber=cells.cells[1].lineNumber;cells.saveCells();clearCells(),cells.cells[0].indexLabeldiv.remove(),cells.cells[1].indexLabeldiv.remove(),cells.cells=[];let myLoaderMap=JSON.parse(backupObject);for(key in Object.keys(myLoaderMap))cells.addCellWithInfo(myLoaderMap[key]);for(key in Object.keys(myLoaderMap))cells.linkChildren(key,myLoaderMap[key]);for(let i=0;i<this.length;i++)this.cells[i].reshape(!0);cells.cells[1].indexLabeldiv.html(consoleTextLabel),cells.cells[1].lineNumber=lineNumber,cells.cells[1].indexLabeldiv.elt.scrollTop=1e3*cells.cells[1].lineNumber,setTidyFlag()}function shareLink(){jlog("Main","shareLink"),myDivs.shareLink=createDiv(),myDivs.shareLink.style("background-color","DimGray"),myDivs.shareLink.style("padding","10px"),myDivs.shareLink.style("outline","1px solid black");myDivs.shareLink.size(200,null),myDivs.shareLink.style("overflow","auto"),myDivs.shareLink.position(windowWidth/2-100,40),myDivs.shareLink.show(),addButtonToDiv("share project",1,shareProject,myDivs.shareLink,"header"),addButtonToDiv("create presentation",1,createPresentation,myDivs.shareLink,"header"),addButtonToDiv("cancel",1,cancelShare,myDivs.shareLink),noClickZone=[0,windowWidth,0,windowHeight]}function cancelShare(){jlog("Main","cancelShare"),myDivs.shareLink.remove(),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight],doMouseDrag=!1}function createPresentation(){jlog("Main","createPresentation"),backupObject=JSON.stringify(cells.saveCells()),pres.presBackup=cells.saveCells(!0),cells.addIDsForCreateMode(),redrawCounter=2,0==pres.length&&pres.addCellsForPres(cells.cells),cancelShare(),presCreationMode=!0,runMode=RM_CREATE,cells.hideAll(presComponents),myDivs.presTools=createDiv(),myDivs.presTools.style("background-color","DimGray"),myDivs.presTools.style("padding","10px"),myDivs.presTools.style("outline","1px solid black"),myDivs.presTools.size(myDivs.menu.width,null),myDivs.presTools.style("overflow","auto"),myDivs.presTools.position(10,10),myDivs.presTools.show(),hideMenu=!0,myDivs.menu.hide(),addButtonToDiv("share presentation",1,sharePresentation,myDivs.presTools),addButtonToDiv("center",13,imlost,myDivs.presTools),addButtonToDiv("back",1,exitPresentationMode,myDivs.presTools),pres.cleanForCreateMode(),setTidyFlag()}function exitPresentationMode(){hideMenu=!1,presCreationMode=!1,showGUI=!0,pres.removeCreateMode(),loadBackup(),myDivs.menu.show(),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight],myDivs.presTools.remove(),runMode=RM_NORMAL,redrawCounter=4,cells.updateView(xPos,yPos,!0)}function sharePresentation(){let scriptLink=(shareLinkString=pres.putInAddyBar(!0)).replace("#","##");exitPresentationMode(),window.open(scriptLink),doMouseDrag=!1}function shareProject(){jlog("Main","shareProject"),shareLinkString=cells.putInAddyBar(),cancelShare(),window.open(shareLinkString)}function loadCells(myLoaderMap){jlog("Main","loadCells"),imlost(),xOff=0,yOff=0,xPos=0,yPos=0;for(let i=0;i<cells.length;i++)cells.cells[i].mode=M_DELETE,cells.cells[i].cleanForDeletionSafe();for(key in cells.cells[0].indexLabeldiv.remove(),cells.cells[1].indexLabeldiv.remove(),cells=new Cells(allColors.colors,allColors.highlights,allColors.lowlights,allColors.icolors,allColors.dtcolors),mobileSettings(),Object.keys(myLoaderMap))cells.addCellWithInfo(myLoaderMap[key]);for(key in Object.keys(myLoaderMap))cells.linkChildren(key,myLoaderMap[key]);let xOffset=2*myDivs.menu.x+myDivs.menu.size().width;cells.nudgeX(xOffset),setTidyFlag(),myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv(),cells.updateView(xPos,yPos,!0),setTidyFlag(),redrawCounter=4,pres.cells=[],pres.addCellsForPres(cells.cells)}function mobileSettings(){jlog("Main","mobileSettings"),1==zoomMode?(fontSizeString="10px",cells.dWidth=40,cells.dHeight=20,cells.dRadius=4):(cells.dWidth=80,cells.dHeight=40,cells.dRadius=5,fontSizeString="12px")}function showHideBlockMenu(){jlog("Main","showHideBlockMenu"),1==(showBlockMenu=!showBlockMenu)?(myDivs.blocks.main.show(),myDivs.demos.hide(),showDemoMenu=!1,myDivs.utils.hide(),showUtils=!1):(myDivs.blocks.main.hide(),restyleMenuDiv(),0!=submenu&&(myDivs.blocks[submenu].hide(),submenu=0))}function showHideDemoMenu(){jlog("Main","showHideDemoMenu"),1==(showDemoMenu=!showDemoMenu)?(myDivs.blocks.main.hide(),showBlockMenu=!1,myDivs.utils.hide(),showUtils=!1,myDivs.demos.show()):(myDivs.demos.hide(),restyleMenuDiv())}function clearCells(){jlog("Main","clearCells"),controller.d_print("Clearing..."),cells.quickClear(),createMenuDiv()}function toggleSpeedMode(){jlog("Main","toggleSpeedMode"),(speedMode+=1)>2&&(speedMode=0),slowMode=!1,fastMode=!1,2==speedMode&&(slowMode=!0),1==speedMode&&(fastMode=!0),speedButton.html("speed: "+String(speedMode+1))}function toggleFlash(){jlog("Main","toggleFlash"),flash=!flash,flashButton.html("flash: "+String(flash))}function showAll(){jlog("Main","showAll");for(let i=0;i<userBlocks.length;i++)cells.addCell(userBlocks[i],1.5*myDivs.menu.size().width),cells.cells[cells.activeIndex].mode=M_IDLE;setTidyFlag()}function drawGrid(){jlog("Main","drawGrid");for(let x=0;x<windowWidth;x+=bgGrid.width)for(let y=0;y<windowHeight;y+=bgGrid.height)image(bgGrid,x+xPos%20,y+yPos%20)}function mouseDrag(){jlog("Main","mouseDrag"),0==mouseIsPressed&&(doMouseDrag=!1),1==disableDrag&&(doMouseDrag=!1),1==doMouseDrag?(xOff=xStart-mouseX,yOff=yStart-mouseY,xPos-=.1*xOff,yPos-=.1*yOff):(xOff=0,yOff=0)}function imlost(){jlog("Main","imlost"),xPos=0,yPos=0}function togglezoomMode(){jlog("Main","togglezoomMode"),zoomMode=!zoomMode;let consoleTextLabel=cells.cells[1].indexLabeldiv.html(),lineNumber=cells.cells[1].lineNumber;loadCells(cells.saveCells()),cells.cells[1].indexLabeldiv.html(consoleTextLabel),cells.cells[1].lineNumber=lineNumber,cells.cells[1].indexLabeldiv.elt.scrollTop=1e3*cells.cells[1].lineNumber,myDivs.menu.html("");for(let i=0;i<cells.length;i++)cells.cells[i].resetDims();0==zoomMode?myDivs.menu.style("font-size","16px"):myDivs.menu.style("font-size","12px")}function newCellFromButtonClick(button){jlog("Main","newCellFromButtonClick"),type=button.srcElement.value,newCell(type,mouseX,mouseY)}function createAddBlockMenu(list,div){jlog("Main","createAddBlockMenu");for(let i=0;i<list.length;i++)addButtonToDiv("+ "+blockConfig[list[i]]["block label"],list[i],newCellFromButtonClick,div,"colorcoded")}function loadCellsFromButtonClick(button){jlog("Main","loadCellsFromButtonClick"),index=parseInt(button.srcElement.value),loadCells(demos[index])}function showBlocksubmenu(button){jlog("Main","showBlocksubmenu");let oldSM=submenu;submenu=parseInt(button.srcElement.value);for(let i=1;i<=7;i++)myDivs.blocks[i].hide();oldSM==submenu?submenu=0:myDivs.blocks[submenu].show(),restyleMenuDiv()}function addButtonToDiv(name,value,callback,div,cssClass="basic"){jlog("Main","addButtonToDiv");let button=createButton(name,String(value));if(button.addClass("basic"),"colorcoded"==cssClass){let tc=allColors.dtcolors[value].toString("#rrggbb"),c1=allColors.colors[value].toString("#rrggbb");button.style("color",tc),button.style("text-align","left"),button.style("background-image","linear-gradient("+c1+", "+c1+")"),button.style("border-color","DimGray")}else"dev"==cssClass?(button.style("height","18px"),button.style("background-image","linear-gradient(DimGray, DimGray)"),button.style("border-color","DimGray"),button.style("box-shadow","rgba(255,255,255,.6) 0 0px 0 inset"),button.style("color","LightGray")):"header"==cssClass?button.style("background-image","linear-gradient(#b7b8ba ,#a7a9ac)"):"demo"==cssClass?button.style("text-align","left"):"eg"==cssClass?(button.style("text-align","left"),button.style("background-image","linear-gradient(#d7d8da ,#c7c9cc)")):"big"==cssClass&&(button.style("height","100%"),button.style("width","100%"));button.parent(div),0!=callback&&button.mousePressed(callback),"speedID"==cssClass?speedButton=button:"flashID"==cssClass&&(flashButton=button),div.html("<br>",!0)}function blocksMenu(){jlog("Main","blocksMenu"),addButtonToDiv("blocks menu",0,showHideBlockMenu,myDivs.menu,"header"),myDivs.blocks={},myDivs.blocks.main=createDiv();for(let i=1;i<=7;i++)myDivs.blocks[i]=createDiv();createAddBlockMenu(containers,myDivs.blocks[1]),createAddBlockMenu(handles,myDivs.blocks[2]),createAddBlockMenu(arrayTools,myDivs.blocks[7]),createAddBlockMenu(mathFunctions,myDivs.blocks[3]),createAddBlockMenu(boolFunctions,myDivs.blocks[4]),createAddBlockMenu(conditionals,myDivs.blocks[5]),createAddBlockMenu(utilities,myDivs.blocks[6]);for(let i=1;i<=7;i++)myDivs.blocks[i].hide();addButtonToDiv("data containers",1,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[1].parent(myDivs.blocks.main),addButtonToDiv("data references",2,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[2].parent(myDivs.blocks.main),addButtonToDiv("array tools",7,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[7].parent(myDivs.blocks.main),addButtonToDiv("math",3,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[3].parent(myDivs.blocks.main),addButtonToDiv("comparison",4,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[4].parent(myDivs.blocks.main),addButtonToDiv("conditionals",5,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[5].parent(myDivs.blocks.main),addButtonToDiv("utilities",6,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[6].parent(myDivs.blocks.main),addButtonToDiv("show all",6,showAll,myDivs.blocks.main),myDivs.blocks.main.parent(myDivs.menu),0==showBlockMenu?myDivs.blocks.main.hide():0!=submenu&&myDivs.blocks[submenu].show()}function demoMenu(){jlog("Main","demoMenu"),myDivs.menu.html("<br>",!0),addButtonToDiv("demo menu",6,showHideDemoMenu,myDivs.menu,"header"),myDivs.demos=createDiv(),addButtonToDiv("Hello, World!",0,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Turing bit flip",14,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Programmable TM",15,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Sleep Sort",7,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Draw Polygons",8,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("blocks",1,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("assigning",2,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("basic math",3,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("comparisons",4,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("if",5,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("if not",6,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("while and array get",9,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("array/string push",10,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("array/string set",11,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("string delete",12,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("array delete",13,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("test all",13,testAll,myDivs.demos),myDivs.demos.parent(myDivs.menu),0==showDemoMenu?myDivs.demos.hide():myDivs.demos.show()}function showHideUtilMenu(){jlog("Main","showHideUtilMenu"),1==(showUtils=!showUtils)?(myDivs.utils.show(),myDivs.demos.hide(),showDemoMenu=!1,myDivs.blocks.main.hide(),showBlockMenu=!1):(myDivs.utils.hide(),restyleMenuDiv())}function utilitiesMenu(){jlog("Main","utilitiesMenu"),myDivs.menu.html("<br>",!0),addButtonToDiv("tools",13,showHideUtilMenu,myDivs.menu,"header"),myDivs.utils=createDiv(),addButtonToDiv("clear",13,clearCells,myDivs.utils),addButtonToDiv("tidy",13,setTidyFlag,myDivs.utils),addButtonToDiv("speed: "+String(speedMode+1),13,toggleSpeedMode,myDivs.utils,"speedID"),addButtonToDiv("flash: "+String(flash),13,toggleFlash,myDivs.utils,"flashID"),addButtonToDiv("origin",13,imlost,myDivs.utils),addButtonToDiv("share",13,shareLink,myDivs.utils),addButtonToDiv("refactor",13,refactor,myDivs.utils),addButtonToDiv(0==zoomMode?"zoom out":"zoom in",13,togglezoomMode,myDivs.utils),myDivs.utils.parent(myDivs.menu),1==showUtils?myDivs.utils.show():myDivs.utils.hide(),myDivs.menu.html("<br>",!0),addButtonToDiv("about",0,openAbout,myDivs.menu),myDivs.menu.html("<br>",!0),addButtonToDiv("version 0.000..01",13,showDevDiv,myDivs.menu,"dev")}function openAbout(){jlog("Main","openAbout"),window.open("https://b38tn1k.com/code/ux/2022/09/08/blocks-explained/")}function closeRefactorDiv(){jlog("Main","closeRefactorDiv"),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight];let stringed=String(JSON.stringify(cells.saveCells()));for(let i=0;i<myDivs.refactorInputs.length;i++)stringed=stringed.replaceAll(myDivs.refactorPriors[i],myDivs.refactorInputs[i].value());let consoleTextLabel=cells.cells[1].indexLabeldiv.html(),lineNumber=cells.cells[1].lineNumber;cells.saveCells();clearCells(),cells.cells[0].indexLabeldiv.remove(),cells.cells[1].indexLabeldiv.remove(),cells.cells=[];let myLoaderMap=JSON.parse(stringed);for(key in Object.keys(myLoaderMap))cells.addCellWithInfo(myLoaderMap[key]);for(key in Object.keys(myLoaderMap))cells.linkChildren(key,myLoaderMap[key]);for(let i=0;i<this.length;i++)this.cells[i].reshape(!0);cells.cells[1].indexLabeldiv.html(consoleTextLabel),cells.cells[1].lineNumber=lineNumber,cells.cells[1].indexLabeldiv.elt.scrollTop=1e3*cells.cells[1].lineNumber,myDivs.refactor.remove(),myDivs.refactorInputs=[],myDivs.refactorPriors=[]}function refactor(){jlog("Main","refactor"),jlog("Main","refactor"),myDivs.refactor=createDiv(),myDivs.refactor.style("background-color","DimGray"),myDivs.refactor.style("padding","10px"),myDivs.refactor.style("outline","1px solid black");myDivs.refactor.size(200,null),myDivs.refactor.style("overflow","auto"),myDivs.refactor.position(windowWidth/2-100,40),myDivs.refactor.show();let handleSet=new Set;for(let i=0;i<cells.length;i++)cells.cells[i].handleSH&&-1==["turtleY","turtleX","turtleDraw","unset","random","year","month#","monthS","day#","dayS","hour","minute","second","millis"].indexOf(cells.cells[i].handleSH)&&handleSet.add(cells.cells[i].handleSH);myDivs.refactorInputs=[],myDivs.refactorPriors=[];for(const hand of handleSet.keys()){let inp=createInput(hand);inp.parent(myDivs.refactor),myDivs.refactorInputs.push(inp),myDivs.refactorPriors.push(hand)}addButtonToDiv("rename & close",1,closeRefactorDiv,myDivs.refactor,"header"),noClickZone=[0,windowWidth,0,windowHeight]}function restyleMenuDiv(){if(myDivs.menu.style("background-color","DimGray"),myDivs.menu.style("padding","10px"),myDivs.menu.style("outline","1px solid black"),myDivs.menu.size().height>windowHeight-50){let newHeight=windowHeight-50;myDivs.menu.size(null,newHeight)}else myDivs.menu.size(null,null);myDivs.menu.style("overflow","auto"),myDivs.menu.position(10,10)}function createMenuDiv(){if(jlog("Main","createMenuDiv"),myDivs.menu.remove(),1==showGUI){if(myDivs.menu=createDiv(),blocksMenu(),demoMenu(),utilitiesMenu(),0==zoomMode?myDivs.menu.style("font-size","16px"):myDivs.menu.style("font-size","12px"),myDivs.menu.style("background-color","DimGray"),myDivs.menu.style("padding","10px"),myDivs.menu.style("outline","1px solid black"),myDivs.menu.size().height>windowHeight-50){let newHeight=windowHeight-50;myDivs.menu.size(null,newHeight)}else myDivs.menu.size(null,null);myDivs.menu.style("overflow","auto"),myDivs.menu.position(10,10),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight],1==hideMenu?(myDivs.menu.hide(),noClickZone=[-1,-1,-1,-1]):myDivs.menu.show(),showDev=!showDev,showDevDiv()}}function toggleDevOptions(button){switch(jlog("Main","toggleDevOptions"),item=parseInt(button.srcElement.value),item){case 0:showFPS=!showFPS;break;case 1:clickDebug=!clickDebug;break;case 2:printStack=!printStack;break;case 3:doJLOGCountDown=50}}function showDevDiv(){0!=(showDev=!showDev)?(myDivs.devDiv&&myDivs.devDiv.remove(),myDivs.devDiv=createDiv(),myDivs.devDiv.style("font-size","12px"),myDivs.devDiv.style("background-color","DimGray"),myDivs.devDiv.style("padding","10px"),myDivs.devDiv.style("outline","1px solid black"),addButtonToDiv("save json",0,saveCells,myDivs.devDiv),addButtonToDiv("show FPS",0,toggleDevOptions,myDivs.devDiv),addButtonToDiv("click log",1,toggleDevOptions,myDivs.devDiv),addButtonToDiv("print stack",2,toggleDevOptions,myDivs.devDiv),addButtonToDiv("tmi log",3,toggleDevOptions,myDivs.devDiv),addButtonToDiv("free colors",3,whatsLeft,myDivs.devDiv),addButtonToDiv("clean",3,cells.clean,myDivs.devDiv),addButtonToDiv("load wip",demos.length-1,loadCellsFromButtonClick,myDivs.devDiv),myDivs.devDiv.position(windowWidth-(40+myDivs.devDiv.size().width),10)):myDivs.devDiv&&myDivs.devDiv.remove()}function setupScreen(){jlog("Main","setupScreen"),jlog("Main","setupScreen"),pixelDensity(1),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(zoomMode=!0,mobileDeviceDetected=!0),createCanvas(windowWidth,windowHeight),windowWidth/windowHeight<.625&&(zoomMode=!0);let gs2=gridSize**2;bgGrid=createGraphics(gs2,gs2);for(let i=gridSize/2;i<gs2;i+=gridSize)for(let j=gridSize/2;j<gs2;j+=gridSize)bgGrid.point(i,j);widthOnTwo=windowWidth/2,heightOnTwo=windowHeight/2,showDev=!showDev,showDevDiv()}function doLastBit(){jlog("Main","doLastBit");let loaded=!1,demoIndex=-1,myString=getURL();if(-1!=myString.indexOf("#tutorial"))tutorial=!0,tutorialstring=myString.slice(myString.indexOf("#tutorial"),myString.length);else if(-1!=myString.indexOf("#demo")){let demo=myString.split("demo");demoIndex=parseInt(demo[demo.length-1])}else loaded=cells.makeFromAddyBar();loaded=doTutorials(loaded),0==loaded&&(cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),-1!=demoIndex&&demoIndex<demos.length&&loadCells(demos[demoIndex]),setTidyFlag()),cells.length>1&&cells.cells[1].resizeConsole(),myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv(),createPresentationDiv()}function createPresentationDiv(){jlog("Main","createPresentationDiv"),presentationDivs.main=createDiv(),presentationDivs.main.style("font-size","16px"),presentationDivs.main.style("padding","10px"),presentationDivs.main.style("overflow","auto"),presentationDivs.main.position(10,10),1==presentationMode?(presentationDivs.main.show(),console.log(cells.layoutArray)):presentationDivs.main.hide(),presentationDivs.defaultItemsWrapper=createDiv(),presentationDivs.defaultItemsWrapper.style("font-size","16px"),presentationDivs.defaultItemsWrapper.style("border","1px solid black"),presentationDivs.defaultItemsWrapper.size(null,100),presentationDivs.defaultItemsWrapper.parent(presentationDivs.main),presentationDivs.startbutton=createDiv(),presentationDivs.startbutton.style("float","left"),presentationDivs.startbutton.size(100,null),presentationDivs.startbutton.style("padding","10px"),addButtonToDiv("run",3,runFromButton,presentationDivs.startbutton),presentationDivs.startbutton.parent(presentationDivs.defaultItemsWrapper),presentationDivs.console=createDiv("<strong>console:</strong><br>"),presentationDivs.console.size(200,presentationDivs.defaultItemsWrapper.size().height),presentationDivs.console.style("overflow","scroll"),presentationDivs.console.style("background-color","black"),presentationDivs.defaultItemsWrapper.style("border","1px solid black"),presentationDivs.console.parent(presentationDivs.defaultItemsWrapper)}function runFromButton(){cells.run=!cells.run,fastMode=1}function addToPresentation(myString,div){jlog("Main","addToPresentation"),"console"==div&&(presentationDivs[div].html(" > "+myString+"<br>",!0),presentationDivs.console.elt.scrollTop=1e3*presentationDivs.console.html().length)}function doTutorials(loaded){if(jlog("Main","doTutorials"),1==tutorial){let noIframe=!0;try{noIframe=window.self==window.top}catch(e){noIframe=!0}if(1==noIframe){let myDiv=createDiv('<a href="https://b38tn1k.com/code/ux/2022/09/08/blocks-explained/"> back to tutorial </a>');myDiv.style("font-size","16px"),textSize(16),myDiv.position(windowWidth-textWidth(" back to tutorial "),windowHeight-40)}switch(tutorialstring){case"#tutorialBlank":break;case"#tutorialHello":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),loadCells(demos[0]),cells.cells[0].reshape(),cells.cells[0].refresh(),1==zoomMode?(tidyFlag=0,cells.cells[1].x=cells.cells[0].x,cells.cells[1].y=cells.cells[0].y+cells.cells[0].height+2*cells.cells[0].handleH):setTidyFlag(),cells.run=!0,loaded=!0;break;case"#tutorialHandles":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,cells.addCell(T_CONST,1.5*myDivs.menu.size().width),cells.cells[2].mode=M_IDLE,cells.cells[2].x=windowWidth/2-cells.cells[2].width/2,cells.cells[2].y=windowHeight/2-cells.cells[2].height/2,cells.cells[2].specialLayer=createGraphics(3*cells.cells[2].width,3*cells.cells[2].height);let fSize=parseInt(fontSizeString.slice(0,2));cells.cells[2].specialLayer.textSize(fSize);let xc=cells.cells[2].specialLayer.width/2,yc=cells.cells[2].specialLayer.height/2,cw2=cells.cells[2].width/2,ch2=cells.cells[2].height/2,gap=2*fSize,px=int(xc-cw2-gap-cells.cells[2].specialLayer.textWidth("move")),py=int(yc-ch2);cells.cells[2].specialLayer.text("move",px,py),px=int(xc+cw2+gap),py=int(yc-ch2),cells.cells[2].specialLayer.text("delete",px,py),px=int(xc+cw2+gap),py=int(yc),cells.cells[2].specialLayer.text("copy",px,py),px=int(xc+cw2+gap),py=int(yc+ch2+fSize),cells.cells[2].specialLayer.text("resize",px,py),px=int(xc-cw2-gap-cells.cells[2].specialLayer.textWidth("mutate")),py=int(yc+ch2+fSize),cells.cells[2].specialLayer.text("mutate",px,py),px=int(xc),py=int(yc+ch2+gap),cells.cells[2].specialLayer.textAlign(CENTER,CENTER),cells.cells[2].specialLayer.text("expand/collapse",px,py),loaded=!0,hideMenu=!0,disableDrag=!0;break;case"#tutorialMove":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),hideMenu=!0,loaded=!0,disableDrag=!0,cells.addCell(T_COMMENT,.25*windowWidth),cells.addCell(T_BLOCK,.75*windowWidth),cells.addCell(T_CONST,.5*windowWidth),cells.cells[2].mode=M_IDLE,cells.cells[3].mode=M_IDLE,cells.cells[4].mode=M_IDLE,cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,cells.cells[2].x-=cells.cells[2].width/2,cells.cells[3].x-=cells.cells[3].width/2,cells.cells[4].x-=cells.cells[4].width/2,cells.cells[2].input.value("can't drop on me"),cells.cells[3].updateHandleSH("drop on me!"),cells.cells[4].input.value("drag me"),cells.cells[2].disableDelete(),cells.cells[3].disableDelete(),cells.cells[4].disableDelete();break;case"#tutorialMutate":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,hideMenu=!0,loaded=!0,disableDrag=!0,cells.addCell(T_ADD,.5*windowWidth),cells.cells[2].x-=cells.cells[2].width/2,cells.addCell(T_CONST,.5*windowWidth),cells.cells[4].input.value(1),cells.addCell(T_CONST,.5*windowWidth),cells.cells[5].input.value(2),cells.addCell(T_CONST,.5*windowWidth),cells.cells[6].input.value(3),cells.cells[2].addChild(4,cells.cells[4]),cells.cells[2].addChild(5,cells.cells[5]),cells.cells[2].addChild(6,cells.cells[6]),cells.cells[4].addParent(2,cells.cells[2]),cells.cells[5].addParent(2,cells.cells[2]),cells.cells[6].addParent(2,cells.cells[2]);for(let i=0;i<cells.length;i++)cells.cells[i].disableDelete(),cells.cells[i].mode=M_IDLE;break;case"#tutorialCopy":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,hideMenu=!0,loaded=!0,disableDrag=!0,cells.addCell(T_SUBTRACT,.7*windowWidth),cells.cells[2].x-=cells.cells[2].width/2,cells.addCell(T_CONST,.2*windowWidth),cells.cells[4].input.value(1),cells.addCell(T_CONST,.2*windowWidth),cells.cells[5].input.value(2),cells.addCell(T_CONST,.2*windowWidth),cells.cells[6].input.value(3),cells.cells[2].addChild(4,cells.cells[4]),cells.cells[2].addChild(5,cells.cells[5]),cells.cells[2].addChild(6,cells.cells[6]),cells.cells[4].addParent(2,cells.cells[2]),cells.cells[5].addParent(2,cells.cells[2]),cells.cells[6].addParent(2,cells.cells[2]),cells.addCell(T_INPUT,.2*windowWidth),cells.cells[7].updateHandleSH("Reference me!"),cells.cells[7].x-=.5*cells.cells[7].width,cells.addCell(T_CONST,.2*windowWidth),cells.cells[8].input.value("Copy me!"),cells.cells[8].x-=.5*cells.cells[8].width,cells.cells[8].y+=cells.cells[7].height+2*cells.cells[7].handleH,cells.addCell(T_BLOCK,.2*windowWidth),cells.cells[9].updateHandleSH("Reference me!"),cells.cells[9].x-=.5*cells.cells[9].width,cells.cells[9].y+=cells.cells[8].y+cells.cells[8].height+2*cells.cells[8].handleH,cells.addCell(T_CONST,.25*windowWidth),cells.cells[9].addChild(10,cells.cells[10]),cells.cells[10].addParent(9,cells.cells[9]),cells.cells[10].input.value("inside a block");for(let i=0;i<cells.length;i++)cells.cells[i].disableDelete(),cells.cells[i].mode=M_IDLE;break;case"#tutorialData":cells.addCell(T_START,10),cells.addCell(T_CONSOLE,10),hideMenu=!0,loaded=!0,cells.addCell(T_CONST,.5*windowWidth),cells.cells[cells.length-1].input.value("I am useless"),cells.addCell(T_INPUT,.5*windowWidth),cells.cells[cells.length-1].input.value("I am eternal"),cells.mapAndLink(),cells.addCell(T_PRINT,.5*windowWidth),cells.cells[0].addChild(cells.length-2,cells.cells[cells.length-2]);let blockIndex=cells.length;cells.addCell(T_BLOCK,.5*windowWidth),cells.addCell(T_GOTO,.5*windowWidth),cells.addCell(T_CONST,0),cells.addCell(T_CONST,0),cells.mapAndLink(),cells.cells[5].updateHandleSH(cells.cells[3].handleSH),cells.cells[7].updateHandleSH(cells.cells[6].handleSH),cells.cells[blockIndex].addChild(blockIndex+2,cells.cells[blockIndex+2]),cells.cells[blockIndex+2].addParent(blockIndex,cells.cells[blockIndex]),cells.cells[blockIndex].addChild(blockIndex+3,cells.cells[blockIndex+3]),cells.cells[blockIndex+3].addParent(blockIndex,cells.cells[blockIndex]),cells.cells[blockIndex+2].input.value("I'm ok"),cells.cells[blockIndex+3].input.value("me too");let printIndex=cells.length;cells.addCell(T_PRINT,.5*windowWidth),cells.cells[0].addChild(cells.length-2,cells.cells[cells.length-2]),cells.cells[cells.length-2].addChild(blockIndex+1,cells.cells[cells.length-2]),cells.activeIndex=cells.length-1,cells.doDelete(),cells.mapAndLink(),cells.cells[printIndex].addChild(blockIndex+1,cells.cells[blockIndex+1]),cells.cells[blockIndex+1].addParent(printIndex,cells.cells[printIndex]);for(let i=0;i<cells.length;i++)cells.cells[i].disableDelete(),cells.cells[i].mode=M_IDLE;cells.tidy(0,10)}}return loaded}function checkAnOrUpdateTutorial(){if(jlog("Main","checkAnOrUpdateTutorial"),1==tutorial)switch(tutorialstring){case"#tutorialBlank":break;case"#tutorialHello":demoIndex=0;break;case"#tutorialHandles":cells.length<3&&(cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,cells.addCell(T_CONST,.5*windowWidth),cells.cells[2].mode=M_IDLE,cells.cells[2].x-=cells.cells[0].width/2),cells.cells[2].x=max(cells.cells[2].x,0),cells.cells[2].x=min(cells.cells[2].x,windowWidth-20),cells.cells[2].y=max(cells.cells[2].y,0),cells.cells[2].y=min(cells.cells[2].y,windowHeight-5),cells.cells[2].viewX=max(cells.cells[2].viewX,0),cells.cells[2].viewX=min(cells.cells[2].viewX,windowWidth-20),cells.cells[2].viewY=max(cells.cells[2].viewY,0),cells.cells[2].viewY=min(cells.cells[2].viewY,windowHeight-5),cells.cells[2].updateAllDivPositions();break;case"#tutorialMove":for(let j=2;j<5;j++)cells.cells[j].x=max(cells.cells[j].x,0),cells.cells[j].x=min(cells.cells[j].x,windowWidth-20),cells.cells[j].y=max(cells.cells[j].y,0),cells.cells[j].y=min(cells.cells[j].y,windowHeight-5),cells.cells[j].viewX=max(cells.cells[j].viewX,0),cells.cells[j].viewX=min(cells.cells[j].viewX,windowWidth-20),cells.cells[j].viewY=max(cells.cells[j].viewY,0),cells.cells[j].viewY=min(cells.cells[j].viewY,windowHeight-5),cells.cells[j].updateAllDivPositions();break;case"#tutorialMutate":for(let j=2;j<7;j++)cells.cells[j].x=max(cells.cells[j].x,0),cells.cells[j].x=min(cells.cells[j].x,windowWidth-20),cells.cells[j].y=max(cells.cells[j].y,0),cells.cells[j].y=min(cells.cells[j].y,windowHeight-5),cells.cells[j].viewX=max(cells.cells[j].viewX,0),cells.cells[j].viewX=min(cells.cells[j].viewX,windowWidth-20),cells.cells[j].viewY=max(cells.cells[j].viewY,0),cells.cells[j].viewY=min(cells.cells[j].viewY,windowHeight-5),cells.cells[j].updateAllDivPositions();break;case"#tutorialCopy":for(let j=2;j<11;j++)cells.cells[j].x=max(cells.cells[j].x,0),cells.cells[j].x=min(cells.cells[j].x,windowWidth-20),cells.cells[j].y=max(cells.cells[j].y,0),cells.cells[j].y=min(cells.cells[j].y,windowHeight-5),cells.cells[j].viewX=max(cells.cells[j].viewX,0),cells.cells[j].viewX=min(cells.cells[j].viewX,windowWidth-20),cells.cells[j].viewY=max(cells.cells[j].viewY,0),cells.cells[j].viewY=min(cells.cells[j].viewY,windowHeight-5),cells.cells[j].updateAllDivPositions();break;case"#tutorialData":millis()<1e4&&(cells.cells[5].updateHandleSH(cells.cells[3].handleSH),cells.cells[7].updateHandleSH(cells.cells[6].handleSH));for(let j=2;j<cells.length;j++)cells.cells[j].x=max(cells.cells[j].x,0),cells.cells[j].x=min(cells.cells[j].x,windowWidth-20),cells.cells[j].y=max(cells.cells[j].y,0),cells.cells[j].y=min(cells.cells[j].y,windowHeight-5),cells.cells[j].viewX=max(cells.cells[j].viewX,0),cells.cells[j].viewX=min(cells.cells[j].viewX,windowWidth-20),cells.cells[j].viewY=max(cells.cells[j].viewY,0),cells.cells[j].viewY=min(cells.cells[j].viewY,windowHeight-5),cells.cells[j].updateAllDivPositions()}}function testAll(){for(jlog("Main","testAll");1!=speedMode;)toggleSpeedMode();testTimer=TST_LOAD,currentTestIndex=-1,testPacer=millis()}function colorToHTMLRGB(color){return jlog("Main","colorToHTMLRGB"),"rgb("+color._getRed()+", "+color._getGreen()+", "+color._getBlue()+")"}function toggleInput(cID,type){jlog("Main","toggleInput"),console.log("functionality removed to tools/refactor")}function jlog(classname,label){-1==["length","tidy","startStop","stop","toggleStartForm","resizeConsole","updateView","moveC","updateAllDivPositions","updateDivPosition","reshape","refresh"].indexOf(label)&&1==(doJLOG=doJLOGCountDown>0)&&(console.debug("frame: "+frameCount,classname,label),logCounter+=1,doJLOGCountDown-=1,100==logCounter&&console.clear())}function whatsLeft(){jlog("Main","whatsLeft");for(let i=0;i<55;i++)-1==everyone.indexOf(i)&&console.log("FREE:",i)}function deviceTurned(){jlog("Main","deviceTurned"),setupScreen()}function windowResized(){jlog("Main","windowResized"),setupScreen(),cells.updateView(xPos,yPos,doMouseDrag),redrawCounter=2}function inClickableZone(){let res=!0;return mouseX>noClickZone[0]&&mouseX<noClickZone[1]&&mouseY>noClickZone[2]&&mouseY<noClickZone[3]&&(res=!1),res}function mousePressed(){frameRate(100),jlog("Main","mousePressed"),1==mobileDeviceDetected&&1==mobileHAddon?newCell(mobileHType,mouseX,mouseY):(!0===inClickableZone()?runMode==RM_NORMAL?doMouseDrag=!cells.checkSelected(mouseX,mouseY):runMode==RM_CREATE&&(doMouseDrag=!pres.checkSelected(mouseX,mouseY)):doMouseDrag=!1,1==doMouseDrag&&(xStart=mouseX,yStart=mouseY))}function preload(){jlog("Main","preload"),c=loadStrings("assets/nintendo-entertainment-system.hex"),demos.push(loadJSON("assets/helloworld.json")),demos.push(loadJSON("assets/demo1.json")),demos.push(loadJSON("assets/demo2.json")),demos.push(loadJSON("assets/demo3.json")),demos.push(loadJSON("assets/demo4.json")),demos.push(loadJSON("assets/demo5.json")),demos.push(loadJSON("assets/demo6.json")),demos.push(loadJSON("assets/demo7.json")),demos.push(loadJSON("assets/demo8.json")),demos.push(loadJSON("assets/demo9.json")),demos.push(loadJSON("assets/demo10.json")),demos.push(loadJSON("assets/demo11.json")),demos.push(loadJSON("assets/demo12.json")),demos.push(loadJSON("assets/demo13.json")),demos.push(loadJSON("assets/demo14.json")),demos.push(loadJSON("assets/demo15.json")),demos.push(loadJSON("assets/wip-demo.json"))}function setup(){jlog("Main","setup"),-1!=getURL().indexOf("##")&&(showGUI=!1,presentationMode=!0,runMode=RM_PRESENT),pixelDensity(1),mainDiv=document.getElementById("main"),myDivs.devDiv=createDiv(),colorSetup(),setupScreen(),cells=new Cells(allColors.colors,allColors.highlights,allColors.lowlights,allColors.icolors,allColors.dtcolors),pres=new Cells(allColors.colors,allColors.highlights,allColors.lowlights,allColors.icolors,allColors.dtcolors),mobileSettings(),controller=new Controller,myDivs.menu=createDiv(),createMenuDiv(),xOff=0,yOff=0,xPos=0,yPos=0,showDev=!showDev,showDevDiv(),doLastBit(),1==autoStart&&(cells.run=!0,fastMode=1),pres.addCellsForPres(cells.cells),pres.createMode=!0}function draw(){if(notIdle=focused||cells.redrawFlag||cells.run||controller.tidyFlag||testTimer!=TST_OFF||tidyFlag>0||frameCount<100,fpsSetValue=1==notIdle?30:5,0!=redrawCounter&&clear(),runMode==RM_NORMAL){if(1==showFPS&&controller.d_print(frameRate().toFixed(2),!0,"<br>FPS: "),0!=tutorial||0==scrollX&&0==scrollY||(window.scrollTo(0,0),cells.updateView(xPos,yPos,!1),cells.rebuildMenuFlag=!0),1==notIdle&&(mouseDrag(),cells.updateView(xPos,yPos,doMouseDrag)),0!=redrawCounter&&(drawGrid(),cells.draw(),redrawCounter-=1),1!=cells.redrawFlag&&1!=cells.run||(redrawCounter=2),1==notIdle&&cells.update(mouseX,mouseY,mouseIsPressed),0!=redrawCounter&&controller.update(cells,flash,fastMode),1==controller.tidyFlag&&(setTidyFlag(),controller.tidyFlag=!1),1==cells.run&&1==slowMode?frameRate(5):0!=redrawCounter?frameRate(100):frameRate(fpsSetValue),tidyFlag>0&&(tidy(),cells.updateView(xPos,yPos,!0),tidyFlag-=1),1==cells.rebuildMenuFlag&&(myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv(),cells.rebuildMenuFlag=!1),testTimer!=TST_OFF){let readyToStep=millis()-testPacer>testPaceSettings[testTimer];if(0==cells.run&&1==readyToStep)switch(testTimer){case TST_LOAD:(currentTestIndex+=1)==demos.length-1?1==testLoop?currentTestIndex=0:testTimer=TST_OFF:(testPacer=millis(),loadCells(demos[currentTestIndex]),setTidyFlag(),testTimer=TST_TIDY);break;case TST_TIDY:testPacer=millis(),testTimer=TST_RUN;break;case TST_RUN:testPacer=millis(),cells.run=!0,testTimer=TST_PAUSE;break;case TST_PAUSE:testPacer=millis(),testTimer=TST_LOAD}}checkAnOrUpdateTutorial()}else runMode==RM_CREATE?(0!=redrawCounter&&(redrawCounter-=1,drawGrid(),pres.draw()),1==notIdle&&(mouseDrag(),pres.update(mouseX,mouseY,mouseIsPressed),pres.updateView(xPos,yPos,doMouseDrag)),tidyFlag>0&&(tidy(),noClickZone=[10,myDivs.presTools.size().width+10,10,pixelDensity*myDivs.presTools.size().height+10],pres.updateView(xPos,yPos,!0),tidyFlag-=1),1==pres.redrawFlag&&(redrawCounter=2)):runMode==RM_PRESENT&&controller.update(cells,flash,fastMode)}
