let mapHeight,bg,fg,my_sprite,canvas,tc,herd,colors=["#0f0","#ff0","#0ff","#f0f","#fff","#f00","#00f","#0f0"],gameMap=[],mapWidth=200,pixelSize=5,shootNow=!1,mapCanvas=null,obstacle=.55,showtext=!0,spriteWidth=8,spriteHeight=5,playerX=10,playerY=10,bullets=[],frenemies=[],frenemyCount=10,direction=[1,0,0,0],rearCannon=!0,showScores=!1,bulldozer=!1,drawFlag=!1;function setDrawFlag(){drawFlag=!0}function rcol(){return colors[int(random(colors.length))]}function rcolsub(t){return t[int(random(t.length))]}function coin(){return random(1)>.5}function randint(t){return random(t)}function keyPressed(){if("h"==key){for(showScores=!1,tc=rcol();tc==bg||tc==fg;)tc=rcol();showtext=!0}else showtext=!1;if("i"==key&&saveImage(),"b"==key&&(bulldozer=!bulldozer)," "==key&&(shootNow=!0),"c"==key&&(rearCannon=!rearCannon),"l"==key){for(showtext=!1,tc=rcol();tc==bg||tc==fg;)tc=rcol();showScores=!showScores}}function saveImage(){var t=year()+nf(month(),2)+nf(day(),2)+"-"+nf(hour(),2)+nf(minute(),2)+nf(second(),2);save(t+".png")}function newMap(){mapWidth=width/pixelSize,mapHeight=height/pixelSize+2;for(var t=0;t<mapWidth;t++){gameMap[t]=[];for(var e=0;e<mapHeight;e++){let i=noise(.03*t,.03*e);gameMap[t][e]=i}}drawMap(newColor=!0),placePlayer()}function shuffleColors(){for(bg=rcol(),fg=rcol();fg==bg;)fg=rcol()}function drawMap(t=!1){1==t&&shuffleColors(),noStroke(),(mapCanvas=createGraphics(window.innerWidth,window.innerHeight)).background(bg),mapCanvas.fill(fg),mapCanvas.stroke(fg);for(var e=0;e<mapWidth;e++)for(var i=0;i<mapHeight;i++)gameMap[e][i]>obstacle&&mapCanvas.square(e*pixelSize,i*pixelSize,pixelSize);noStroke()}function makeSprite(){my_sprite=null;let t=rcol();for(;t==bg;)t=rcol();my_sprite=genSprite(spriteWidth,spriteHeight,t)}function genSprite(t,e,i){let r=createGraphics((t+2)*pixelSize,2*e*pixelSize);r.background=bg,r.fill(i),r.stroke(i);let h=e,s=t;for(var a=new Array,o=0,n=0;n<h;n++){a[n]=new Array;for(var l=0;l<s;l++)a[n][l]=random(2),a[n][l]=a[n][l]+sin(radians(90*n/h)),a[n][l]=a[n][l]+sin(radians(l/s*180)),a[n][l]>o&&(o=a[n][l])}var d=0,p=0;for(n=0;n<h;n++)for(l=0;l<s;l++)a[n][l]=a[n][l]/o,d+=a[n][l],p++;var c=d/p,m=0,u=0;for(n=0;n<h;n++){for(l=0;l<s;l++)a[n][l]>c&&r.rect(m,u,pixelSize,pixelSize),u+=pixelSize;u=0,m+=pixelSize}var g=int(h)-1;for(n=0;n<h;n++){for(l=0;l<s;l++)a[g-n][l]>c&&r.rect(m,u,pixelSize,pixelSize),u+=pixelSize;u=0,m+=pixelSize}return r}function placePlayer(){for(playerX=int(random(10,mapWidth-10)),playerY=int(random(10,mapHeight-10));gameMap[playerX][playerY]>obstacle+.1;)playerX=int(random(10,mapWidth-10)),playerY=int(random(10,mapHeight-10))}function deviceTurned(){canvas=null,canvas=createCanvas(window.innerWidth,window.innerHeight)}function setup(){for(canvas=createCanvas(window.innerWidth,window.innerHeight),smooth(8),pixelDensity(2),background(rcol()),newMap(),makeSprite(),herd=new Herd(20),frenemies=herd.herd,tc=rcol();tc==bg||tc==fg;)tc=rcol()}function draw(){clear(),frameRate(8);let t=playerX,e=playerY,i=1;keyIsDown(17)&&(i=2),(keyIsDown(UP_ARROW)||keyIsDown(87))&&(playerY-=i,direction=1==rearCannon?[1,0,0,0]:[0,1,0,0]),(keyIsDown(DOWN_ARROW)||keyIsDown(83))&&(playerY+=i,direction=1==rearCannon?[0,1,0,0]:[1,0,0,0]),(keyIsDown(LEFT_ARROW)||keyIsDown(65))&&(playerX-=i,direction=1==rearCannon?[0,0,1,0]:[0,0,0,1]),(keyIsDown(RIGHT_ARROW)||keyIsDown(68))&&(playerX+=i,direction=1==rearCannon?[0,0,0,1]:[0,0,1,0]),keyIsDown(82)&&(my_sprite.remove(),makeSprite());let r=playerX+spriteWidth/2+1,h=playerY+spriteHeight-1;if(gameMap[r][h]>obstacle&&(0==bulldozer?(playerX=t,playerY=e):(gameMap[r][h]=0,gameMap[r+1][h]=0,gameMap[r-1][h]=0,gameMap[r][h+1]=0,gameMap[r][h-1]=0,setDrawFlag())),keyIsDown(16)&&(gameMap[r][h]=1,setDrawFlag()),keyIsDown(32)&&1==shootNow&&(bullets.push(new Bullet(r,h,direction)),shootNow=!1),playerX<0&&(playerX=0),playerX>mapWidth-spriteWidth&&(playerX=mapWidth-spriteWidth),playerY<0&&(playerY=0),playerY>mapHeight-1.5*spriteHeight&&(playerY=mapHeight-1.5*spriteHeight),bullets.length>0){for(var s=0;s<bullets.length;s++)herd.checkShot(bullets[s].x,bullets[s].y,bullets[s].counter),bullets[s].update();let t=[];for(s=0;s<bullets.length;s++)1==bullets[s].alive&&t.push(bullets[s]);bullets=[];for(s=0;s<t.length;s++)bullets[s]=t[s]}if(herd.update(r,h),mapCanvas.remove(),1==drawFlag&&drawMap(),image(mapCanvas,0,0),drawFlag=!1,image(my_sprite,playerX*pixelSize,playerY*pixelSize),herd.draw(),bullets.length>0)for(s=0;s<bullets.length;s++)bullets[s].draw();if(1==showScores&&herd.showLog(),1==bulldozer&&(fill(tc),textSize(20),text("BULLDOZER",width-200,50)),1==showtext){strokeWeight(5),stroke(fg),fill(tc),rect(45,5,1320,300),fill(bg),rect(45,320,350,280),noStroke();let t="[WASD] to move\nHold [LEFT CONTROL] to go faster\n[LEFT SHIFT] to build\n[SPACE] to shoot\n[B] for Bulldozer Mode\n[C] to switch cannon direction\n[R] for a new sprite\n[L] for logging\n[H] to see this again\nPress any key to play",e="YOU ARE THE BIG ONE\nYOU FLOAT IN LUMPY SPACE WITH THE LITTLE ONES\nWHEN A LITTLE ONE DIES,\nTHE TWO OLDEST HAVE A BABY\nSOMETIMES THEY MUTATE";textSize(50),text(e,50,50),fill(tc),textSize(20),text(t,50,350)}}window.onresize=function(){width=window.innerWidth,height=window.innerHeight,mapCanvas.remove(),my_sprite.remove();for(var t=0;t<frenemyCount;t++)frenemies[t].clean();canvas=null,canvas=createCanvas(window.innerWidth,window.innerHeight),newMap(),makeSprite(),placePlayer(),herd=new Herd(20),frenemies=herd.herd};class Frenemy{constructor(){for(this.color=rcol(),this.stuck=0;this.color==bg;)this.color=rcol();for(this.behaviourThresh=.98,this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10)),this.alive=!0;gameMap[this.x][this.y]>obstacle;)this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10));this.counter=0,this.width=5,this.height=3,this.sprite=genSprite(this.width,this.height,this.color),this.xrand=int(random(-2,2)),this.yrand=int(random(-2,2)),this.builder=random(-1,1),this.evader=random(-1,1),this.seeker=random(-1,1),this.purpose=random(2)+1,this.direction=[0,0,0,0],this.bulldozer=!1,this.dozer_count=0}inherit(t,e,i,r,h){this.clean(),this.color=h,this.sprite=genSprite(5,3,this.color),this.builder=t,this.purpose=r}builderBehaviour(){0==this.direction[0]&&0==this.direction[1]&&0==this.direction[2]&&0==this.direction[3]&&(random()>.5?this.direction=[1,0,0,0]:this.direction=[0,1,0,0]),-1*random()>this.builder&&(this.bulldozer=!0,this.dozer_count=2,bullets.push(new Bullet(this.x,this.y,this.direction))),random()<this.builder&&(gameMap[this.x][this.y]=1,setDrawFlag())}clean(){this.sprite.remove(),this.sprite=null}checkShot(t,e){t>this.x&&t<this.x+5&&e>this.y&&e<this.y+6&&(this.alive=!1)}checkTouch(t,e){return t>this.x-spriteWidth&&t<this.x+spriteWidth&&e>this.y-spriteHeight&&e<this.y+spriteHeight&&(this.alive=!1,!0)}randomWalk(){this.counter%int(random(3,5*this.purpose))==0&&(this.dozer_count<=0?this.bulldozer=!1:this.dozer_count--,this.direction=[0,0,0,0],this.xrand=int(random(-2,2)),this.yrand=int(random(-2,2)),this.yrand>0&&(this.direction[0]=1),this.yrand<0&&(this.direction[1]=1),this.xrand>0&&(this.direction[2]=1),this.xrand<0&&(this.direction[3]=1)),this.counter++,this.x+=this.xrand,this.y+=this.yrand}update(){if(this.stuck>=300){for(this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10));gameMap[this.x][this.y]>obstacle+.1;)this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10));this.stuck=0}this.x=int(this.x),this.y=int(this.y);let t=this.x,e=this.y;this.randomWalk(),random()>this.behaviourThresh&&this.builderBehaviour(),this.x<this.width&&(this.x=this.width),this.x>mapWidth-3*this.width&&(this.x=mapWidth-3*this.width),this.y<this.width&&(this.y=this.width),this.y>mapHeight-3*this.width&&(this.y=mapHeight-3*this.width);let i=this.x+this.width,r=this.y+int(this.height/2);(gameMap[i][r]>obstacle||gameMap[this.x][this.y]>obstacle)&&(0==this.bulldozer?(this.stuck++,this.x=t,this.y=e):(gameMap[i][r]=0,gameMap[i+1][r+1]=0,gameMap[i-1][r-1]=0,gameMap[i+1][r-1]=0,gameMap[i-1][r+1]=0,gameMap[i][r+1]=0,gameMap[i][r-1]=0,gameMap[i+1][r]=0,gameMap[i-1][r]=0))}draw(){image(this.sprite,this.x*pixelSize,this.y*pixelSize)}}class Bullet{constructor(t,e,i){for(this.x=t,this.y=e,this.direction=i,this.alive=!0,this.health=5,this.col=rcol(),this.counter=0;this.col==bg;)this.col=rcol()}update(){this.counter++,this.y=this.y+this.direction[0],this.y=this.y-this.direction[1],this.x=this.x+this.direction[2],this.x=this.x-this.direction[3],(this.x<0||this.y<0||this.x>=mapWidth||this.y>=mapHeight)&&(this.alive=!1),0==this.health&&(this.alive=!1),1==this.alive&&gameMap[this.x][this.y]>obstacle&&(gameMap[this.x][this.y]=0,this.health--,0==this.health&&this.x>2&&this.x<mapWidth-2&&this.y>2&&this.y<mapHeight-2&&(gameMap[this.x+1][this.y-1]=0,gameMap[this.x-1][this.y-1]=0,gameMap[this.x-1][this.y+1]=0,gameMap[this.x-1][this.y]=0,gameMap[this.x][this.y-1]=0,gameMap[this.x+1][this.y+1]=0,gameMap[this.x][this.y+1]=0,gameMap[this.x+1][this.y]=0),setDrawFlag())}draw(){fill(this.col),stroke(this.col),square(this.x*pixelSize,this.y*pixelSize,pixelSize)}}class Herd{constructor(t){this.mutation_liklihood=.3,this.count=t,this.herd=[];for(var e=0;e<t;e++)this.herd.push(new Frenemy)}showLog(){noStroke(),fill(color("#666")),rect(0,0,500,22*this.count),rect(0,22*this.count,500,100),fill(color("#fff")),textSize(15);let t="Lump\t\t\tIntent\t\t\t\t\tCreativity\t\tEvader\t\t\t\t\t\tSeeker\t\tDozer\t\t\tAge";text(t,10,20);let e=0;for(var i=0;i<this.count;i++)fill(color(this.herd[i].color)),t=" "+nf(i,2)+"\t\t\t\t\t"+nfp(this.herd[i].purpose,2,2)+"\t\t\t\t\t"+nfp(this.herd[i].builder,2,2)+"\t\t\t\t"+nfp(this.herd[i].evader,2,2)+"\t\t\t\t\t"+nfp(this.herd[i].seeker,2,2)+"\t\t\t"+this.herd[i].bulldozer+"\t\t\t"+this.herd[i].counter,e=20+20*(i+1),text(t,10,e);e+=30,fill(color("#fff")),t="Intent is how confident a little one moves in a direction\nCreativity can also be destructive\nStrong Evaders will move away from the big one as the weak approach\nSeekers will find shelter near structures\nDozer Mode is Dozer Mode",text(t,10,e)}checkShot(t,e,i){if(i>5)for(var r=0;r<this.count;r++)this.herd[r].checkShot(t,e)}update(t,e){for(var i=0;i<this.count;i++){if(0==this.herd[i].alive){this.herd[i].clean(),this.herd[i]=new Frenemy;let t=this.herd[0],e=this.herd[1];for(var r=0;r<this.count;r++)this.herd[r].counter>t.counter?t=this.herd[r]:this.herd[r].counter>e.counter&&(e=this.herd[r]);let h=lerpColor(color(t.color),color(e.color),.5);random()>this.mutation_liklihood&&(h=lerpColor(color(h),color(rcol()),.5)),random()>this.mutation_liklihood&&(t.builder=random(-1,1));let s=(t.purpose+e.purpose)/2;random()>this.mutation_liklihood&&(s=this.purpose=random(2)+1),this.herd[i].inherit(t.builder,0,0,s,h)}this.herd[i].update(),1==this.herd[i].checkTouch(t,e)&&(my_sprite.remove(),makeSprite())}}draw(){for(var t=0;t<this.count;t++)this.herd[t].draw()}}
