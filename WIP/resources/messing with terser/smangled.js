var printStack=!0,clickDebug=!0,showDev=!0,showFPS=!0;clickDebug=!1,showDev=!1,showFPS=!1;var backupObject,bgGrid,widthOnTwo,heightOnTwo,cells,c,shareLinkString,pres,xPos,yPos,xStart,yStart,xOff,yOff,doMouseDrag,mobileHType,mainDiv,B_UNSET=0,B_TRUE=1,B_FALSE=2,RM_NORMAL=0,RM_CREATE=1,RM_PRESENT=2,M_IDLE=0,M_MOVE=1,M_RESIZE=2,M_DELETE=3,M_SELECTED=4,M_EXPAND_OR_COLLAPSE=5,M_START=6,M_NEW=7,M_COPY=8,M_MUTATE=9,V_NUMBER=0,V_STRING=1,V_BOOL=2,TST_OFF=0,TST_LOAD=1,TST_TIDY=2,TST_RUN=3,TST_PAUSE=4,T_START=1,T_STOP=105,T_COMMENT=3,T_BLOCK=23,T_LEN=6,T_GET=8,T_RUN=53,T_SET=10,T_VAR=45,T_INPUT=47,T_CONST=46,T_IF=30,T_WHILE=7,T_EQUAL=48,T_LESS=9,T_GREATER=38,T_ADD=11,T_SUBTRACT=52,T_MULT=13,T_DIV=14,T_MOD=32,T_AVERAGE=33,T_SQRT=34,T_HYPOT=35,T_GOTO=16,T_NOT=28,T_COS=24,T_SIN=26,T_CONDITION=103,T_RANGE=150,T_ELSE=102,T_DO=101,T_OUTLET=104,T_ASSIGN=42,T_CONSOLE=2,T_PRINT=27,T_TURTLE=0,T_INLET=201,T_ROUND=4,T_PUSH=41,T_DELETE=44,T_FOR=51,T_INDEX=222,T_REF=223,T_LAYOUT_BLOCK=666,zoomMode=!1,mobileDeviceDetected=!1,selectChanged=!0,fontSizeString="12px",doJLOG=!1,doJLOGCountDown=0,myDivs={},allColors={},showBlockMenu=!1,showDemoMenu=!1,showUtils=!1,shareLinkGenerated=!1,slowMode=!1,fastMode=!1,speedMode=0,flash=!0,gridSize=20,demos=[],mobileHAddon=!1,tidyFlag=0,expandMenu=!0,submenu=0,currentTestIndex=0,testPacer=0,testPaceSettings=[0,0,0,500,500],testTimer=TST_OFF,testLoop=!1,tutorial=!1,tutorialstring="",hideMenu=!1,disableDrag=!1;let logCounter=0;var speedButton,flashButton,redrawCounter=0,notIdle=!0,noClickZone=[0,0,0,0],clearCellFlag=0,showGUI=!0,presentationMode=!1,presCreationMode=!1,autoStart=!1,presentationDivs={},runMode=RM_NORMAL,turtleVars=["turtleX","turtleY","turtleDraw"],everyone=[T_COMMENT,T_CONST,T_BLOCK,T_VAR,T_INPUT,T_IF,T_WHILE,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_GOTO,T_NOT,T_CONDITION,T_ELSE,T_DO,T_OUTLET,T_ASSIGN,T_PRINT,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_LEN,T_GET,T_SET,T_START,T_CONSOLE,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],userBlocks=[T_BLOCK,T_GOTO,T_INPUT,T_VAR,T_CONST,T_ASSIGN,T_IF,T_WHILE,T_NOT,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_PRINT,T_COMMENT,T_COS,T_SIN,T_TURTLE,T_LEN,T_GET,T_SET,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],notStartOrConsole=[T_COMMENT,T_CONST,T_VAR,T_IF,T_WHILE,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_GOTO,T_NOT,T_CONDITION,T_ELSE,T_DO,T_OUTLET,T_ASSIGN,T_PRINT,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_LEN,T_GET,T_SET,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],notStartOrConsoleOrSpecial=[T_COMMENT,T_CONST,T_VAR,T_IF,T_WHILE,T_EQUAL,T_LESS,T_GREATER,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_GOTO,T_NOT,T_ASSIGN,T_PRINT,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_LEN,T_GET,T_SET,T_ROUND,T_PUSH,T_DELETE,T_FOR,T_RUN],numberyOnes=[T_OUTLET,T_COMMENT,T_CONST,T_VAR,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_COS,T_SIN,T_LEN,T_GET,T_ROUND],boolyOnes=[T_COMMENT,T_NOT,T_EQUAL,T_GREATER,T_LESS],conditionallyOnes=boolyOnes.concat(numberyOnes.slice(1)),presComponents=[T_INPUT,T_CONST],mathFunctions=[T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_SIN,T_COS,T_ROUND],boolFunctions=[T_NOT,T_EQUAL,T_GREATER,T_LESS],utilities=[T_COMMENT,T_PRINT,T_TURTLE],conditionals=[T_IF,T_WHILE,T_FOR],containers=[T_BLOCK,T_INPUT,T_CONST],handles=[T_GOTO,T_VAR,T_ASSIGN],arrayTools=[T_LEN,T_GET,T_SET,T_PUSH,T_DELETE,T_RUN],blockMenuDict={};blockMenuDict["data containers"]=containers,blockMenuDict["data references"]=handles,blockMenuDict["array tools"]=arrayTools,blockMenuDict.math=mathFunctions,blockMenuDict.comparisons=boolFunctions,blockMenuDict.conditionals=conditionals,blockMenuDict.utilities=utilities;var blockConfig={};blockConfig[T_BLOCK]={},blockConfig[T_GOTO]={},blockConfig[T_VAR]={},blockConfig[T_INPUT]={},blockConfig[T_IF]={},blockConfig[T_WHILE]={},blockConfig[T_EQUAL]={},blockConfig[T_LESS]={},blockConfig[T_GREATER]={},blockConfig[T_ADD]={},blockConfig[T_HYPOT]={},blockConfig[T_AVERAGE]={},blockConfig[T_SQRT]={},blockConfig[T_SUBTRACT]={},blockConfig[T_MULT]={},blockConfig[T_DIV]={},blockConfig[T_MOD]={},blockConfig[T_NOT]={},blockConfig[T_CONDITION]={},blockConfig[T_RANGE]={},blockConfig[T_ELSE]={},blockConfig[T_DO]={},blockConfig[T_OUTLET]={},blockConfig[T_START]={},blockConfig[T_STOP]={},blockConfig[T_ASSIGN]={},blockConfig[T_CONSOLE]={},blockConfig[T_PRINT]={},blockConfig[T_COMMENT]={},blockConfig[T_CONST]={},blockConfig[T_TURTLE]={},blockConfig[T_INLET]={},blockConfig[T_SIN]={},blockConfig[T_COS]={},blockConfig[T_LEN]={},blockConfig[T_GET]={},blockConfig[T_RUN]={},blockConfig[T_SET]={},blockConfig[T_ROUND]={},blockConfig[T_PUSH]={},blockConfig[T_DELETE]={},blockConfig[T_FOR]={},blockConfig[T_INDEX]={},blockConfig[T_REF]={},blockConfig[T_LAYOUT_BLOCK]={},blockConfig[T_BLOCK]["block label"]="block",blockConfig[T_GOTO]["block label"]="block",blockConfig[T_VAR]["block label"]="variable",blockConfig[T_INPUT]["block label"]="variable",blockConfig[T_IF]["block label"]="if",blockConfig[T_WHILE]["block label"]="while",blockConfig[T_EQUAL]["block label"]="equal",blockConfig[T_LESS]["block label"]="less",blockConfig[T_GREATER]["block label"]="greater",blockConfig[T_ADD]["block label"]="add",blockConfig[T_AVERAGE]["block label"]="average",blockConfig[T_SQRT]["block label"]="sqrt",blockConfig[T_HYPOT]["block label"]="hypot",blockConfig[T_SUBTRACT]["block label"]="subtract",blockConfig[T_MULT]["block label"]="multiply",blockConfig[T_DIV]["block label"]="divide",blockConfig[T_MOD]["block label"]="modulus",blockConfig[T_NOT]["block label"]="not",blockConfig[T_CONDITION]["block label"]="condition",blockConfig[T_RANGE]["block label"]="repeats w/ count",blockConfig[T_ELSE]["block label"]="else",blockConfig[T_DO]["block label"]="do",blockConfig[T_OUTLET]["block label"]="out",blockConfig[T_START]["block label"]="start",blockConfig[T_STOP]["block label"]="stop",blockConfig[T_ASSIGN]["block label"]="assign",blockConfig[T_CONSOLE]["block label"]="console",blockConfig[T_PRINT]["block label"]="print",blockConfig[T_COMMENT]["block label"]="//",blockConfig[T_CONST]["block label"]="constant",blockConfig[T_TURTLE]["block label"]="turtle 200x150",blockConfig[T_INLET]["block label"]="inlet",blockConfig[T_SIN]["block label"]="sin",blockConfig[T_COS]["block label"]="cos",blockConfig[T_LEN]["block label"]="length",blockConfig[T_GET]["block label"]="get",blockConfig[T_RUN]["block label"]="run",blockConfig[T_SET]["block label"]="set",blockConfig[T_ROUND]["block label"]="round",blockConfig[T_PUSH]["block label"]="push",blockConfig[T_DELETE]["block label"]="delete",blockConfig[T_FOR]["block label"]="repeat",blockConfig[T_INDEX]["block label"]="index",blockConfig[T_REF]["block label"]="value",blockConfig[T_LAYOUT_BLOCK]["block label"]="layout cell",blockConfig[T_BLOCK]["accept child"]=notStartOrConsoleOrSpecial,blockConfig[T_VAR]["accept child"]=[T_COMMENT],blockConfig[T_INPUT]["accept child"]=[T_COMMENT],blockConfig[T_IF]["accept child"]=[T_CONDITION,T_DO,T_ELSE,T_COMMENT],blockConfig[T_WHILE]["accept child"]=[T_CONDITION,T_DO,T_ELSE,T_COMMENT],blockConfig[T_FOR]["accept child"]=[T_RANGE,T_DO,T_ELSE,T_COMMENT],blockConfig[T_EQUAL]["accept child"]=numberyOnes.slice(1),blockConfig[T_LESS]["accept child"]=numberyOnes.slice(1),blockConfig[T_GREATER]["accept child"]=numberyOnes.slice(1),blockConfig[T_ADD]["accept child"]=numberyOnes,blockConfig[T_AVERAGE]["accept child"]=numberyOnes,blockConfig[T_SIN]["accept child"]=numberyOnes,blockConfig[T_COS]["accept child"]=numberyOnes,blockConfig[T_SQRT]["accept child"]=numberyOnes,blockConfig[T_ROUND]["accept child"]=numberyOnes,blockConfig[T_SUBTRACT]["accept child"]=numberyOnes,blockConfig[T_MULT]["accept child"]=numberyOnes,blockConfig[T_DIV]["accept child"]=numberyOnes,blockConfig[T_HYPOT]["accept child"]=numberyOnes,blockConfig[T_MOD]["accept child"]=numberyOnes,blockConfig[T_GOTO]["accept child"]=[T_COMMENT],blockConfig[T_NOT]["accept child"]=[...conditionallyOnes],blockConfig[T_CONDITION]["accept child"]=conditionallyOnes,blockConfig[T_RANGE]["accept child"]=[T_OUTLET,T_COMMENT,T_CONST,T_ADD,T_SUBTRACT,T_MULT,T_DIV,T_MOD,T_AVERAGE,T_SQRT,T_HYPOT,T_COS,T_SIN,T_LEN,T_GET,T_ROUND,T_LEN],blockConfig[T_ELSE]["accept child"]=notStartOrConsole,blockConfig[T_DO]["accept child"]=notStartOrConsole,blockConfig[T_OUTLET]["accept child"]=[T_COMMENT],blockConfig[T_START]["accept child"]=notStartOrConsoleOrSpecial,blockConfig[T_START]["accept child"].push(T_BLOCK),blockConfig[T_STOP]["accept child"]=[],blockConfig[T_ASSIGN]["accept child"]=[T_VAR,T_CONST,T_COMMENT,T_GET],blockConfig[T_CONSOLE]["accept child"]=[],blockConfig[T_PRINT]["accept child"]=[T_VAR,T_INPUT,T_CONST,T_COMMENT,T_GOTO,T_BLOCK,T_GET],blockConfig[T_COMMENT]["accept child"]=[],blockConfig[T_CONST]["accept child"]=[T_COMMENT],blockConfig[T_TURTLE]["accept child"]=[T_INLET],blockConfig[T_INLET]["accept child"]=[],blockConfig[T_LEN]["accept child"]=[],blockConfig[T_GET]["accept child"]=[T_INDEX],blockConfig[T_RUN]["accept child"]=[T_INDEX],blockConfig[T_SET]["accept child"]=[T_INDEX,T_REF],blockConfig[T_PUSH]["accept child"]=[T_REF],blockConfig[T_DELETE]["accept child"]=[T_INDEX],blockConfig[T_INDEX]["accept child"]=numberyOnes.slice(1),blockConfig[T_REF]["accept child"]=numberyOnes.slice(1),blockConfig[T_REF]["accept child"].push(T_GOTO),blockConfig[T_LAYOUT_BLOCK]["accept child"]=presComponents,blockConfig[T_BLOCK]["max children"]=100,blockConfig[T_GOTO]["max children"]=0,blockConfig[T_VAR]["max children"]=0,blockConfig[T_INPUT]["max children"]=0,blockConfig[T_IF]["max children"]=3,blockConfig[T_WHILE]["max children"]=3,blockConfig[T_FOR]["max children"]=3,blockConfig[T_EQUAL]["max children"]=100,blockConfig[T_LESS]["max children"]=100,blockConfig[T_GREATER]["max children"]=100,blockConfig[T_ADD]["max children"]=100,blockConfig[T_AVERAGE]["max children"]=100,blockConfig[T_SQRT]["max children"]=2,blockConfig[T_ROUND]["max children"]=2,blockConfig[T_SIN]["max children"]=2,blockConfig[T_COS]["max children"]=2,blockConfig[T_SUBTRACT]["max children"]=100,blockConfig[T_MULT]["max children"]=100,blockConfig[T_DIV]["max children"]=100,blockConfig[T_MOD]["max children"]=100,blockConfig[T_HYPOT]["max children"]=100,blockConfig[T_NOT]["max children"]=100,blockConfig[T_CONDITION]["max children"]=100,blockConfig[T_RANGE]["max children"]=1,blockConfig[T_ELSE]["max children"]=100,blockConfig[T_DO]["max children"]=100,blockConfig[T_OUTLET]["max children"]=0,blockConfig[T_START]["max children"]=100,blockConfig[T_STOP]["max children"]=100,blockConfig[T_ASSIGN]["max children"]=100,blockConfig[T_CONSOLE]["max children"]=0,blockConfig[T_PRINT]["max children"]=100,blockConfig[T_COMMENT]["max children"]=0,blockConfig[T_CONST]["max children"]=0,blockConfig[T_TURTLE]["max children"]=3,blockConfig[T_INLET]["max children"]=2,blockConfig[T_LEN]["max children"]=1,blockConfig[T_GET]["max children"]=1,blockConfig[T_RUN]["max children"]=1,blockConfig[T_SET]["max children"]=2,blockConfig[T_PUSH]["max children"]=1,blockConfig[T_DELETE]["max children"]=1,blockConfig[T_INDEX]["max children"]=1,blockConfig[T_REF]["max children"]=1,blockConfig[T_LAYOUT_BLOCK]["max children"]=1;var I_NONE=0,I_TEXT=1,I_SELECT=2,I_TEXT_AREA=3,I_CANVAS=0;function selectChangedCallback(){selectChanged=!0,redrawCounter=2}blockConfig[T_BLOCK]["input type"]=I_TEXT,blockConfig[T_GOTO]["input type"]=I_SELECT,blockConfig[T_VAR]["input type"]=I_SELECT,blockConfig[T_INPUT]["input type"]=I_TEXT,blockConfig[T_IF]["input type"]=I_NONE,blockConfig[T_WHILE]["input type"]=I_NONE,blockConfig[T_FOR]["input type"]=I_NONE,blockConfig[T_EQUAL]["input type"]=I_NONE,blockConfig[T_LESS]["input type"]=I_NONE,blockConfig[T_GREATER]["input type"]=I_NONE,blockConfig[T_ADD]["input type"]=I_NONE,blockConfig[T_SIN]["input type"]=I_NONE,blockConfig[T_COS]["input type"]=I_NONE,blockConfig[T_AVERAGE]["input type"]=I_NONE,blockConfig[T_SQRT]["input type"]=I_NONE,blockConfig[T_ROUND]["input type"]=I_NONE,blockConfig[T_SUBTRACT]["input type"]=I_NONE,blockConfig[T_MULT]["input type"]=I_NONE,blockConfig[T_DIV]["input type"]=I_NONE,blockConfig[T_MOD]["input type"]=I_NONE,blockConfig[T_HYPOT]["input type"]=I_NONE,blockConfig[T_NOT]["input type"]=I_NONE,blockConfig[T_CONDITION]["input type"]=I_NONE,blockConfig[T_RANGE]["input type"]=I_SELECT,blockConfig[T_ELSE]["input type"]=I_NONE,blockConfig[T_DO]["input type"]=I_NONE,blockConfig[T_OUTLET]["input type"]=I_SELECT,blockConfig[T_START]["input type"]=I_NONE,blockConfig[T_STOP]["input type"]=I_NONE,blockConfig[T_ASSIGN]["input type"]=I_NONE,blockConfig[T_CONSOLE]["input type"]=I_NONE,blockConfig[T_PRINT]["input type"]=I_NONE,blockConfig[T_COMMENT]["input type"]=I_TEXT_AREA,blockConfig[T_CONST]["input type"]=I_TEXT,blockConfig[T_TURTLE]["input type"]=I_CANVAS,blockConfig[T_INLET]["input type"]=I_NONE,blockConfig[T_LEN]["input type"]=I_SELECT,blockConfig[T_GET]["input type"]=I_SELECT,blockConfig[T_RUN]["input type"]=I_SELECT,blockConfig[T_SET]["input type"]=I_SELECT,blockConfig[T_PUSH]["input type"]=I_SELECT,blockConfig[T_DELETE]["input type"]=I_SELECT,blockConfig[T_INDEX]["input type"]=I_NONE,blockConfig[T_REF]["input type"]=I_NONE,blockConfig[T_LAYOUT_BLOCK]["input type"]=I_TEXT,blockConfig[T_BLOCK].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_GOTO].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_VAR].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_CONST,copy:!0},blockConfig[T_INPUT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_IF].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_WHILE,copy:!0},blockConfig[T_WHILE].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_FOR,copy:!0},blockConfig[T_FOR].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_IF,copy:!0},blockConfig[T_EQUAL].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_LESS,copy:!0},blockConfig[T_LESS].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_GREATER,copy:!0},blockConfig[T_GREATER].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_EQUAL,copy:!0},blockConfig[T_ADD].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_SUBTRACT,copy:!0},blockConfig[T_SUBTRACT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_MULT,copy:!0},blockConfig[T_MULT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_DIV,copy:!0},blockConfig[T_DIV].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_MOD,copy:!0},blockConfig[T_MOD].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_AVERAGE,copy:!0},blockConfig[T_AVERAGE].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_HYPOT,copy:!0},blockConfig[T_SQRT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_HYPOT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_ROUND,copy:!0},blockConfig[T_ROUND].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_ADD,copy:!0},blockConfig[T_SIN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_COS,copy:!0},blockConfig[T_COS].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_SIN,copy:!0},blockConfig[T_NOT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_CONDITION].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_RANGE].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!0},blockConfig[T_ELSE].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_DO].handles={move:!1,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_OUTLET].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!0},blockConfig[T_START].handles={move:!0,resize:!0,delete:!1,expand:!0,mutate:-1,copy:!1},blockConfig[T_STOP].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!1},blockConfig[T_ASSIGN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_CONSOLE].handles={move:!0,resize:!0,delete:!0,expand:!1,mutate:-1,copy:!1},blockConfig[T_PRINT].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_COMMENT].handles={move:!0,resize:!0,delete:!0,expand:!1,mutate:-1,copy:!0},blockConfig[T_CONST].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_INPUT,copy:!0},blockConfig[T_TURTLE].handles={move:!0,resize:!1,delete:!0,expand:!0,mutate:-1,copy:!1},blockConfig[T_INLET].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!0},blockConfig[T_LEN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_GET].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_RUN,copy:!0},blockConfig[T_RUN].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_DELETE,copy:!0},blockConfig[T_SET].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_PUSH].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0},blockConfig[T_DELETE].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:T_GET,copy:!0},blockConfig[T_INDEX].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!1},blockConfig[T_REF].handles={move:!1,resize:!1,delete:!1,expand:!1,mutate:-1,copy:!1},blockConfig[T_LAYOUT_BLOCK].handles={move:!0,resize:!0,delete:!0,expand:!0,mutate:-1,copy:!0};class Cell{constructor(e,t,l,i,s,h,o){jlog("Cell","constructor"),this.children=[],this.childIndicies=[],this.parent=-1,this.dataSH,this.dataSHasType={},this.handleSH="unset",this.type=int(e),this.textLabel=blockConfig[this.type]["block label"],this.type,this.mode=M_IDLE,this.highlight=!1,this.underneath=!1,this.flash=!1,this.startForm=!1,this.showHandleInput=!1,this.inputOptions=[],this.forceHandleSH=!1,this.forceHandleSHFrameOff=-1,this.childYBorder=2*o,this.childXBorder=1.5*o,this.ySpacer=0,e==T_CONSOLE&&(i*=2,s*=5),this.width=i,this.height=s,this.oldHeight=s,this.minWidth=i,this.minHeight=s,this.radius=o,this.x=t,this.y=l,this.deletable=!0,this.copyable=!0,this.resizable=!0,this.mutable=!0,this.expandable=!0,this.startable=!0,this.viewX=t,this.viewY=l,this.deltaX=0,this.deltaY=0,this.hide=!1,this.shrink=!1,this.handleW=1.5*o,this.handleH=1.5*o,this.graphicUpdate=!0,this.specialLayer=null,this.id,this.colors=h,e==T_START&&(this.makeStartButtonOptions(),this.sbHighlight=!1),this.lineNumber=0,this.indexLabeldiv=createDiv(this.textLabel),this.indexLabeldiv.style("font-size",fontSizeString),this.indexLabeldiv.style("color",colorToHTMLRGB(this.colors[4])),this.indexLabeldiv.show(),this.yHeaderEnd=parseInt(this.indexLabeldiv.style("font-size"))+this.childYBorder,this.type==T_START?this.yHeaderEnd+=2*this.handleH:this.yHeaderEnd-=2*this.handleH,this.height+=this.yHeaderEnd,this.startHeight=this.height,this.startWidth=this.width,this.type==T_TURTLE&&(this.canvas=createGraphics(200,150),this.canvas.pixelDensity(1),this.canvas.background(255)),this.buildDivs(),this.resizeConsole(),this.updateAllDivPositions()}get size(){return jlog("Cell","size"),[this.width,this.height]}resetDims(e=!1){1==e&&(this.height=this.startHeight,this.width=this.startWidth),this.minWidth=this.width,this.minHeight=this.height}getDataSH(){jlog("Cell","getDataSH");const e=new Date;switch(this.handleSH){case"random":this.dataSH=random();break;case"year":this.dataSH=e.getFullYear();break;case"month#":this.dataSH=e.getMonth()+1;break;case"monthS":const t=["January","February","March","April","May","June","July","August","September","October","November","December"];this.dataSH=t[e.getMonth()];break;case"day#":this.dataSH=e.getDate();break;case"dayS":const l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];this.dataSH=l[e.getDay()];break;case"hour":this.dataSH=e.getHours();break;case"minute":this.dataSH=e.getMinutes();break;case"second":this.dataSH=e.getSeconds();break;case"millis":this.dataSH=e.getMilliseconds()}return this.dataSH}getDataSHForPrint(){jlog("Cell","getDataSHForPrint");let e=this.getDataSH();return"undefined"==String(e)&&(e=this.textLabel),e}disableDelete(){jlog("Cell","disableDelete"),this.deletable=!1}disableAllButMove(){jlog("Cell","disableAllButMove"),this.deletable=!1,this.copyable=!1,this.resizable=!1,this.mutable=!1,this.expandable=!1,this.startable=!1}updateHandleSH(e){jlog("Cell","updateHandleSH"),this.handleSH=e,this.type==T_LAYOUT_BLOCK&&this.indexLabeldiv.html(this.handleSH),this.type!=T_BLOCK&&this.type!=T_INPUT||(this.indexLabeldiv.html(this.textLabel+" "+e),this.indexLabeldiv.html(this.textLabel+" "+e),this.updateView(this.viewX-this.x,this.viewY-this.y),this.updateAllDivPositions(),this.refresh()),this.type==T_BLOCK&&this.input.value(e),this.type==T_VAR&&(this.input.selected(e),this.indexLabeldiv.html(this.textLabel+" "+e)),this.type==T_GOTO&&(this.input.selected(e),this.indexLabeldiv.html(this.textLabel+" "+e)),blockConfig[this.type]["input type"]==I_SELECT&&this.input.selected(e)}reStyle(){jlog("Cell","reStyle"),this.indexLabeldiv.style("font-size",fontSizeString),this.indexLabeldiv.style("color",colorToHTMLRGB(this.colors[4])),this.indexLabeldiv.show(),this.buildDivs()}resizeConsole(e=100,t=75){jlog("Cell","resizeConsole"),this.graphicUpdate=!0,this.type==T_CONSOLE&&(this.minWidth=max(e,this.minWidth),this.minHeight=max(t,this.minHeight),this.indexLabeldiv.size(this.width-3*this.childXBorder,this.height-this.childYBorder),this.indexLabeldiv.style("overflow","auto"))}buildDivs(){jlog("Cell","buildDivs"),this.graphicUpdate=!0;this.viewX,this.viewY;if(this.height=this.startHeight,this.width=this.startWidth,this.ySpacer=0,this.input&&this.input.remove(),blockConfig[this.type]["input type"]==I_TEXT&&(this.input=createInput(),this.input.input(selectChangedCallback)),blockConfig[this.type]["input type"]==I_TEXT_AREA&&(this.input=createElement("textarea"),this.input.input(selectChangedCallback)),blockConfig[this.type]["input type"]==I_SELECT&&(this.input=createSelect(),this.input.changed(selectChangedCallback),this.width=max(this.width,this.startWidth)),blockConfig[this.type]["input type"]!=I_NONE){this.input.style("font-size",fontSizeString),1==this.showHandleInput?this.input.style("background-color",colorToHTMLRGB(this.colors[1])):this.type==T_CONST?this.input.style("background-color",colorToHTMLRGB(color(255))):this.input.style("background-color",colorToHTMLRGB(this.colors[2])),this.input.style("border-color",colorToHTMLRGB(this.colors[1])),this.input.style("color",colorToHTMLRGB(this.colors[4])),this.input.style("border",0);let e=this.input.size().height,t=this.width;this.standardInputHeight=e,this.input.size(t,e),this.width=t+3*this.childXBorder,1==mobileDeviceDetected&&(this.width+=this.handleW),this.ySpacer+=this.input.height,this.minWidth=this.width}this.updateAllDivPositions()}updateAllDivPositions(){jlog("Cell","updateAllDivPositions");let e=this.viewX,t=this.viewY;this.updateDivPosition(this.indexLabeldiv,e+2*this.childXBorder,t),blockConfig[this.type]["input type"]!=I_NONE&&this.updateDivPosition(this.input,e+this.childXBorder,t+this.childYBorder+this.yHeaderEnd)}updateDataSH(e,t=!1){jlog("Cell","updateDataSH"),this.dataSH=e,blockConfig[this.type]["input type"]==I_TEXT&&1==t&&(this.input.value(e,e),0==showGUI&&(this.input.hide(),this.indexLabeldiv.hide())),blockConfig[this.type]["input type"]==I_SELECT&&1==t&&(this.input.selected(e),0==showGUI&&(this.input.hide(),this.indexLabeldiv.hide())),this.unpackDataSH()}updateView(e,t){jlog("Cell","updateView"),-1==this.parent&&(this.viewX=this.x+e,this.viewY=this.y+t)}draw(e=null){jlog("Cell","draw");let t=this.viewX,l=this.viewY;if(this.specialLayer){let e=t-(this.specialLayer.width-this.width)/2,i=l-(this.specialLayer.height-this.height)/2;image(this.specialLayer,int(e),int(i))}if(!1===this.hide){1==this.flash||!0===this.highlight?fill(this.colors[2]):fill(this.colors[0]),!0===this.underneath&&(blockConfig[this.type]["input type"]!=I_NONE&&this.input.hide(),this.indexLabeldiv.hide()),!1===this.underneath&&(blockConfig[this.type]["input type"]!=I_NONE&&(this.type==T_BLOCK?1==this.showHandleInput?this.input.show():this.input.hide():this.input.show()),this.indexLabeldiv.show(),0==showGUI&&(this.indexLabeldiv.hide(),blockConfig[this.type]["input type"]!=I_NONE&&this.input.hide())),stroke(this.colors[1]),rect(t,l,this.width,this.height,this.radius),1==blockConfig[this.type].handles.move&&(fill(this.colors[1]),rect(t,l,this.handleW,this.handleH)),1==blockConfig[this.type].handles.delete&&1==this.deletable&&1==this.startable&&(fill(this.colors[3]),stroke(this.colors[3]),rect(t+this.width-this.handleW,l,this.handleW,this.handleH),stroke(this.colors[1])),1==blockConfig[this.type].handles.expand&&1==this.expandable&&(fill(this.colors[1]),rect(t+this.width/2-this.handleW,l+this.height-this.handleH,this.handleW,this.handleH)),0==this.shrink&&(1==blockConfig[this.type].handles.resize&&1==this.resizable&&(fill(this.colors[1]),rect(t+this.width-this.handleW,l+this.height-this.handleH,this.handleW,this.handleH)),1==blockConfig[this.type].handles.copy&&1==this.copyable&&(fill(this.colors[1]),rect(t+this.width-this.handleW,l+this.height/2-this.handleH,this.handleW,this.handleH)),-1!=blockConfig[this.type].handles.mutate&&1==this.mutable&&(fill(this.colors[1]),rect(t,l+this.height-this.handleH,this.handleW,this.handleH)));for(let e=0;e<this.children.length;e++)this.children[e].draw();this.type==T_TURTLE&&image(this.canvas,t+this.handleW,l+3*this.yHeaderEnd)}else this.hideDivs();!0===this.shrink&&this.hideDivs(),this.type==T_START&&0==this.shrink&&image(this.sbGraphics[int(this.startForm)][int(this.sbHighlight)],t+this.width/2-1.5*this.handleW,l+this.yHeaderEnd-1.25*this.handleH*2)}toggleStartForm(e){jlog("Cell","toggleStartForm"),this.startForm=e,1==e?(this.textLabel=blockConfig[T_STOP]["block label"],this.indexLabeldiv.html(this.textLabel)):(this.textLabel=blockConfig[T_START]["block label"],this.indexLabeldiv.html(this.textLabel))}makeStartButtonOptions(){jlog("Cell","makeStartButtonOptions"),this.sbGraphics={},this.sbGraphics[0]={},this.sbGraphics[1]={},this.sbGraphics[0][0]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[0][1]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[1][0]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[1][1]=createGraphics(3*this.handleW,3*this.handleH),this.sbGraphics[0][0].stroke(this.colors[1]),this.sbGraphics[0][1].stroke(this.colors[1]),this.sbGraphics[1][0].stroke(this.colors[1]),this.sbGraphics[1][1].stroke(this.colors[1]),this.sbGraphics[0][0].fill(this.colors[0]),this.sbGraphics[0][1].fill(this.colors[2]),this.sbGraphics[1][0].fill(this.colors[0]),this.sbGraphics[1][1].fill(this.colors[2]),this.sbGraphics[0][0].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[0][1].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[1][0].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[1][1].rect(1,1,3*this.handleW-2,3*this.handleH-2),this.sbGraphics[0][0].fill(this.colors[2]),this.sbGraphics[0][1].fill(this.colors[0]),this.sbGraphics[1][0].fill(this.colors[2]),this.sbGraphics[1][1].fill(this.colors[0]),this.sbGraphics[0][0].triangle(.5*this.handleW,.5*this.handleH,.5*this.handleW,2.5*this.handleH,2.5*this.handleW,1.5*this.handleH),this.sbGraphics[0][1].triangle(.5*this.handleW,.5*this.handleH,.5*this.handleW,2.5*this.handleH,2.5*this.handleW,1.5*this.handleH),this.sbGraphics[1][0].rect(.5*this.handleW,.5*this.handleH,2*this.handleW,2*this.handleH),this.sbGraphics[1][1].rect(.5*this.handleW,.5*this.handleH,2*this.handleW,2*this.handleH)}updateDivPosition(e,t,l){jlog("Cell","updateDivPosition"),e.position(t,l)}moveC(e,t,l,i){jlog("Cell","moveC"),this.graphicUpdate=!0,this.viewX=e,this.viewY=t,this.x=this.viewX-l,this.y=this.viewY-i,this.refresh(l,i)}refresh(e,t){jlog("Cell","refresh"),this.graphicUpdate=!0;let l=this.viewX+this.childXBorder,i=this.viewY+2*this.childYBorder+this.ySpacer+this.yHeaderEnd;0==this.showHandleInput&&this.type==T_BLOCK&&(i-=this.standardInputHeight),this.type==T_TURTLE&&(l+=this.canvas.width+this.handleW,i=this.viewY+3*this.yHeaderEnd),this.updateAllDivPositions();for(let s=0;s<this.children.length;s++)-1!=blockConfig[this.type]["accept child"].indexOf(this.children[s].type)&&(this.children[s].moveC(l,i,e,t),i+=this.childYBorder+this.children[s].height)}resizeC(e,t){jlog("Cell","resize"),this.graphicUpdate=!0;let l=e-this.viewX,i=t-this.viewY;l>2*this.handleW&&(this.width=l),i>2*this.handleH&&(this.height=i),this.type==T_COMMENT?(1==mobileDeviceDetected?this.input.size(this.width-3*this.childXBorder-this.handleW,this.height-4*this.childYBorder):this.input.size(this.width-3*this.childXBorder,this.height-4*this.childYBorder),this.minHeight=this.height,this.minWidth=this.minWidth):this.width=max(this.minWidth,this.width),this.height=max(this.minHeight,this.height),blockConfig[this.type]["input type"]!=I_NONE&&blockConfig[this.type]["input type"]!=I_TEXT_AREA&&this.type!=T_CONSOLE&&(1==mobileDeviceDetected?this.input.size(this.width-3*this.childXBorder-this.handleW,this.standardInputHeight):this.input.size(this.width-3*this.childXBorder,this.standardInputHeight)),this.resizeConsole()}reshape(e=!1){if(jlog("Cell","reshape"),this.type==T_LAYOUT_BLOCK)return;this.graphicUpdate=!0;this.viewX,this.viewY;for(let e=0;e<this.children.length;e++)this.children[e].mode==M_IDLE&&this.children[e].reshape();let t=this.yHeaderEnd+this.childYBorder+this.ySpacer;for(let e=0;e<this.children.length;e++)this.children[e].width+2*this.childXBorder>this.width&&(this.width=this.children[e].width+2*this.childXBorder),0==this.children[e].hide&&(t+=this.children[e].height+this.childYBorder);if(t+=2*this.childYBorder,t>this.height&&(this.height=t,this.minHeight=this.height),this.height<this.indexLabeldiv.size().height&&(this.minHeight=this.indexLabeldiv.size().height+2*this.childYBorder),1==e&&(this.height=this.minHeight),!0===this.shrink&&(this.width=this.startWidth,this.height=3*this.yHeaderEnd,this.type==T_START?this.height=this.yHeaderEnd:this.height=3*this.yHeaderEnd,this.minHeight=this.height),this.width<this.indexLabeldiv.size().width+3*this.childXBorder&&this.type!=T_CONSOLE&&(this.width=this.indexLabeldiv.size().width+3*this.childXBorder),blockConfig[this.type]["input type"]!=I_NONE){this.input.size().height;1==mobileDeviceDetected?this.input.size(this.width-3*this.childXBorder-this.handleW):this.input.size(this.width-3*this.childXBorder)}this.refresh(0,0),this.type==T_TURTLE&&(this.height=this.canvas.height+this.yHeaderEnd+4*this.handleH,this.width=this.canvas.width+2*this.handleW,this.children[0]&&this.children[0].mode!=M_DELETE&&(this.width+=this.children[2].width+this.handleW))}markForDeletion(){jlog("Cell","markForDeletion");for(let e=0;e<this.children.length;e++)this.children[e].markForDeletion();this.mode=M_DELETE}cleanForDeletionSafe(){jlog("Cell","cleanForDeletionSafe");let e=-1;return this.mode==M_DELETE&&(this.indexLabeldiv.remove(),e=this.parent,this.removeParent(),blockConfig[this.type]["input type"]!=I_NONE&&(this.input.remove(),this.input.remove())),e}checkButtons(e,t){jlog("Cell","checkButtons");let l=this.viewX,i=this.viewY,s=!1;if(0==this.hide){let h=2;if(1!=zoomMode&&this.mode!=M_NEW||(h=this.handleW),1==blockConfig[this.type].handles.move&&e>l-h&&e<l+this.handleW+h&&t>i-h&&t<i+this.handleH+h&&(console.log("move button pressed"),this.mode=M_MOVE,s=!0),1==blockConfig[this.type].handles.delete&&e>l+this.width-this.handleW-h&&e<l+this.width+h&&t>i-h&&t<i+this.handleH+h&&(console.log("delete button pressed"),this.type==T_CONSOLE?(this.indexLabeldiv.html(this.textLabel),this.lineNumber=0):(1==this.deletable&&(this.mode=M_DELETE),s=!0)),1==blockConfig[this.type].handles.expand&&e>l+this.width/2-this.handleW&&e<l+this.width/2&&t>i+this.height-this.handleH&&t<i+this.height&&(console.log("expand || collapse button pressed"),1==this.mutable&&(this.mode=M_EXPAND_OR_COLLAPSE),s=!0),0==this.shrink){if(1==blockConfig[this.type].handles.resize&&e>l+this.width-this.handleW-h&&e<l+this.width+h&&t>i+this.height-this.handleH-h&&t<i+this.height+h&&(console.log("resize button pressed"),1==this.resizable&&(this.mode=M_RESIZE),s=!0),1==blockConfig[this.type].handles.copy){let o=l+this.width-this.handleW,n=i+this.height/2-this.handleH,c=o+this.handleW,a=n+this.handleH;o-h<e&&e<c+h&&n-h<t&&t<a+h&&(console.log("copy button pressed"),1==this.copyable&&(this.mode=M_COPY),s=!0)}if(-1!=blockConfig[this.type].handles.mutate&&l-h<e&&e<l+this.handleW+h&&i+this.height-this.handleH-h<t&&t<i+this.height+h&&(console.log("mutate button pressed"),1==this.mutable&&(this.mode=M_MUTATE),s=!0),this.type==T_START&&this.mode!=M_MOVE&&0==this.shrink){let h=l+this.width/2-1.5*this.handleW,o=h+3*this.handleW;if(e>h&&e<o){let e=i+this.yHeaderEnd-1.25*this.handleH*2,l=e+3*this.handleH;t>e&&t<l&&(1==this.startable&&(this.mode=M_START),s=!0)}}}}return s}clearConsole(){jlog("Cell","clearConsole"),this.type==T_CONSOLE&&(this.indexLabeldiv.html(this.textLabel),this.lineNumber=0)}updateSHs(){if(jlog("Cell","updateSHs"),0==this.forceHandleSH&&blockConfig[this.type]["input type"]!=I_NONE&&this.mode!=M_NEW){switch(this.type){case T_BLOCK:this.mode!=M_SELECTED&&this.updateHandleSH(this.input.value());break;case T_GOTO:case T_VAR:case T_GET:case T_RUN:case T_SET:case T_RANGE:case T_PUSH:case T_DELETE:case T_LEN:this.updateHandleSH(this.input.value());break;case T_OUTLET:let e=this.input.value();this.handleSH!=e&&(this.unsetData(),this.updateHandleSH(e));break;case T_INPUT:this.mode!=M_SELECTED&&0==this.showHandleInput&&this.updateDataSH(this.input.value());break;case T_COMMENT:this.dataSH=this.input.value();break;case T_CONST:this.updateDataSH(this.input.value())}this.unpackDataSH()}1==this.forceHandleSH&&(this.updateDataSH(this.handleSH,!0),-1==this.forceHandleSHFrameOff&&(this.forceHandleSHFrameOff=frameCount+5)),-1!=this.forceHandleSHFrameOff&&this.forceHandleSHFrameOff<frameCount&&(this.forceHandleSH=!1,this.forceHandleSHFrameOff=-1)}unpackDataSH(){jlog("Cell","unpackDataSH"),this.dataSHasType.string=this.dataSH,this.dataSHasType.number=parseFloat(this.dataSH),this.dataSHasType.isNumber=!isNaN(this.dataSHasType.number),"false"==this.dataSH?this.dataSHasType.bool=!1:this.dataSHasType.bool=!0,1!=/^\d+\.\d+$/.test(this.dataSH)&&1!=/^\d+$/.test(this.dataSH)||(this.dataSHasType.bool=Boolean(parseInt(this.dataSH)))}updateOptions(e){if(jlog("Cell","updateOptions"),blockConfig[this.type]["input type"]==I_SELECT){for(let t=0;t<this.inputOptions.length;t++)if(-1==e[this.type].indexOf(this.inputOptions[t])){this.inputOptions=[],this.input.remove(),this.buildDivs();break}for(let t=0;t<e[this.type].length;t++)this.input.option(e[this.type][t],e[this.type][t]),this.inputOptions.push(e[this.type][t]);-1!=e[this.type].indexOf(this.handleSH)&&this.input.selected(this.handleSH)}let t=new Set(this.inputOptions);this.inputOptions=Array.from(t)}forcefullyAddChildren(e,t){jlog("Cell","forcefullyAddChildren"),this.graphicUpdate=!0,this.childIndicies.push(e),this.children.push(t)}acceptsChild(e){return jlog("Cell","acceptsChild"),-1!=blockConfig[this.type]["accept child"].indexOf(e)}addChild(e,t,l=!1){return jlog("Cell","addChild"),this.graphicUpdate=!0,(1==l||1==this.acceptsChild(t.type)&&this.children.length<blockConfig[this.type]["max children"])&&-1==this.childIndicies.indexOf(e)&&(this.children.push(t),this.childIndicies.push(e)),!0}addParent(e,t){jlog("Cell","addParent"),this.parent=e,this.type==T_START&&(this.parent=-1)}removeParent(){jlog("Cell","removeParent"),this.parent=-1}clearChildren(){jlog("Cell","clearChildren"),this.childIndicies=[],this.children=[],this.minHeight=0,this.reshape(!0)}removeChild(e){if(jlog("Cell","removeChild"),this.graphicUpdate=!0,this.type!=T_VAR&&this.type!=T_INPUT){let t=this.childIndicies.indexOf(e);-1!=t&&(this.childIndicies.splice(t,1),this.children.splice(t,1))}return this.minHeight=0,this.reshape(!0),this.parent}expandOrCollapse(){jlog("Cell","expandOrCollapse"),this.type==T_TURTLE?(this.canvas.clear(),this.canvas.background(255),this.shrink=!1):!0===this.shrink?this.expandBlock():this.shrinkBlock(),this.graphicUpdate=!0,this.mode=M_IDLE}hideDivs(){jlog("Cell","hideDivs"),blockConfig[this.type]["input type"]!=I_NONE&&this.input.hide()}hideBlock(e=!0){jlog("Cell","hideBlock"),this.graphicUpdate=!0;for(let t=0;t<this.children.length;t++)1==e&&this.children[t].hideBlock();this.hide=!0,this.hideDivs(),this.indexLabeldiv.hide()}showDivs(){jlog("Cell","showDivs"),blockConfig[this.type]["input type"]!=I_NONE&&(this.type==T_BLOCK?1==this.showHandleInput?this.input.show():this.input.hide():this.input.show(),0==showGUI&&this.input.hide()),0==showGUI&&this.indexLabeldiv.hide()}showBlock(){jlog("Cell","showBlock"),this.graphicUpdate=!0;for(let e=0;e<this.children.length;e++)this.children[e].showBlock();this.hide=!1,this.showDivs(),this.indexLabeldiv.show()}shrinkBlock(){jlog("Cell","shrinkBlock"),this.graphicUpdate=!0,this.oldHeight=this.height;for(let e=0;e<this.children.length;e++)this.children[e].hideBlock(),this.children[e].shrinkBlock();this.shrink=!0,this.hideDivs()}expandBlock(){jlog("Cell","expandBlock"),this.graphicUpdate=!0;for(let e=0;e<this.children.length;e++)this.children[e].showBlock(),this.children[e].expandBlock();this.shrink=!1,this.showDivs(),this.minHeight=this.oldHeight,this.height=this.oldHeight,this.reshape()}selfDescribe(e=!1){jlog("Cell","selfDescribe"),console.log("TYPE",blockConfig[this.type]["block label"]),console.log("DATA",this.dataSH),console.log("DATAAS",this.dataSHasType),console.log("HANDLE",this.handleSH),console.log("CHILDREN",this.childIndicies),console.log("DIMS",this.width,this.height),console.log("PARENT",this.parent),console.log("XY",this.x,this.y),console.log("VIEW XY",this.viewX,this.viewY),console.log("\n")}unsetData(){jlog("Cell","unsetData"),this.dataSH=undefined}pushX(e){jlog("Cell","pushX"),this.viewX+=e,this.x+=e}inArea(e,t){jlog("Cell","inArea");let l=this.viewX,i=this.viewY,s=!1;if(!1===this.hide){let h=2;1!=zoomMode&&this.mode!=M_NEW||(h=this.handleW),e>l-h&&e<l+this.width+h&&t>i-h&&t<i+this.height+h&&(1==clickDebug&&this.selfDescribe(!1),s=!0)}return s}}class Cells{constructor(e,t,l,i,s){jlog("Cells","constructor"),this.cells=[],this.dWidth=80,this.dHeight=40,this.dRadius=5,this.activeIndex=-1,this.colors=e,this.highlights=t,this.lowlights=l,this.inverted=i,this.dualtone=s,this.varNames="abcdefghijklmnopqrstuvwxyz",this.varHandles=["unset"],this.map={},this.run=!1,this.viewXdelta=0,this.viewYdelta=0,this.cellsInView=[],this.oldMouse=!0,this.rebuildMenuFlag=!1,this.redrawFlag=!1,this.parentFlag=0,this.parentWidthRecord=[-1,0],this.partialUpdate=[],this.createMode=!1,this.presBackup,this.layoutArray}get length(){return jlog("Cells","length"),this.cells.length}removeCreateMode(){jlog("Cells","removeCreateMode"),this.quickClear(!0),this.cellsInView=[],this.cells=[],this.createMode=!1}addIDsForCreateMode(){for(let e=0;e<this.length;e++)this.cells[e].id=e}cleanForCreateMode(){jlog("Cells","cleanForCreateMode"),this.createMode=!0;let e=0;for(let t=0;t<this.length;t++)this.cells[t].type!=T_LAYOUT_BLOCK?(this.cells[t].removeParent(),this.cells[t].clearChildren(),this.cells[t].disableAllButMove()):e+=1,this.cellsInView.push(t);if(this.mapAndLink(),0==e)this.newLayoutBlock("A0",windowWidth/3,10);else for(let e=0;e<this.length;e++)this.cells[e].type==T_LAYOUT_BLOCK&&0!=this.cells[e].children.length&&this.cells[e].children[0].addParent(e,this.cells[e])}newLayoutBlock(e,t,l){let i=[color(0,0,0,0),color(0,0,0,255),color(255,255,255,255),color(0,0,0,255),color(0,0,0,255)],s=this.length;this.cellsInView.push(s),this.cells.push(new Cell(T_LAYOUT_BLOCK,t,l,2*this.dWidth,2.8*this.dHeight,i,this.dRadius)),this.cells[s].updateHandleSH(e)}getLayoutBlockNextName(e){let t="";if("Z"==e[0])t=getLayoutBlockBelowName(e);else{let l=e[0].charCodeAt(0);t=String.fromCharCode(l+1)+e.slice(1)}return t}getLetterAndNumber(e){return{letter:e[0],ascii:e[0].charCodeAt(0),number:parseInt(e.slice(1))}}getLayoutBlockBelowName(e){let t=this.getLetterAndNumber(e),l=String(t.number+1),i="A".charCodeAt(0);for(let e=0;e<this.length;e++)this.cells[e].type==T_LAYOUT_BLOCK&&this.getLetterAndNumber(this.cells[e].handleSH).number==l&&(i=this.getLetterAndNumber(this.cells[e].handleSH).ascii+1);return String.fromCharCode(i)+l}getLayoutArray(){let e=[],t=[],l=[],i="A-1";for(let s=0;s<this.length;s++)this.cells[s].type==T_LAYOUT_BLOCK&&(l=[],l.push(this.cells[s].input.value()),0!=this.cells[s].children.length&&l.push(this.cells[s].children[0].id),this.cells[s].handleSH==this.getLayoutBlockNextName(i)||(e.push(t),t=[]),t.push(l),i=this.cells[s].handleSH);return e.push(t),e=e.slice(1),e}tidy(e,t){jlog("Cells","tidy");let l=[];for(let e=0;e<this.length;e++)if(-1==this.cells[e].parent)this.cells[e].type!=T_START&&this.cells[e].type!=T_CONSOLE&&this.cells[e].type!=T_LAYOUT_BLOCK&&(this.cells[e].reshape(!0),l.push(this.cells[e]));else{let t=this.cells[this.cells[e].parent].type,i=this.cells[e].type;-1==blockConfig[t]["accept child"].indexOf(i)&&l.push(this.cells[e])}this.cells[1].resizeConsole(),l.sort((function(e,t){return e.width*e.height-t.width*t.height})),0==this.createMode&&l.unshift(this.cells[0],this.cells[1]);let i=e,s=t,h=0,o=[];for(let e=0;e<l.length;e++)(s+l[e].height>windowHeight||e<2&&0==this.createMode)&&(i+=h+3*l[e].childXBorder,s=t,h=0),o.push([i,s]),l[e].reshape(),l[e].width>h&&(h=l[e].width),s+=l[e].height+l[e].childYBorder;for(let e=0;e<l.length;e++)l[e].x=o[e][0],l[e].y=o[e][1],l[e].updateAllDivPositions();this.updateView(this.viewX,this.viewY,!1),this.mapAndLink(),this.rebuildMenuFlag=!0}saveCells(e=!1){jlog("Cells","saveCells");let t={};this.mapAndLink();for(let l=0;l<this.length;l++)t[l]={},0==e&&(t[l].x=int(this.cells[l].x),t[l].y=int(this.cells[l].y),t[l].tL=1==l?blockConfig[T_CONSOLE]["block label"]:this.cells[l].textLabel,t[l].L=this.cells[l].indexLabeldiv.html(),t[l].h=this.cells[l].hide,t[l].s=this.cells[l].shrink),t[l].t=this.cells[l].type,t[l].d=this.cells[l].dataSH,t[l].i=this.cells[l].handleSH,t[l].p=this.cells[l].parent,0!=this.cells[l].childIndicies.length&&(t[l].c=this.cells[l].childIndicies);return t}addCellWithInfo(e){jlog("Cells","addCellWithInfo");let t=e.t;t>this.colors.length&&(t=this.cells[e.p].type);let l=[this.colors[t],this.highlights[t],this.lowlights[t],this.inverted[t],this.dualtone[t]];t==T_START&&(l=[this.colors[t],this.highlights[t],this.colors[49],this.inverted[t],this.dualtone[t]]);let i=this.length;this.cells.push(new Cell(e.t,e.x,e.y,this.dWidth,this.dHeight,l,this.dRadius)),this.cells[i].hide=e.h,this.cells[i].shrink=e.s,this.cells[i].updateDataSH(e.d),this.cells[i].updateHandleSH(e.i),this.varHandles.push(e.i),this.cells[i].parent=e.p,e.t!=T_OUTLET&&e.t!=T_VAR&&e.t!=T_INPUT&&e.t!=T_INLET||(this.cells[i].textLabel=e.tL,this.cells[i].indexLabeldiv.html(e.L),this.cells[i].updateHandleSH(e.i),this.cells[i].updateDataSH(e.d)),blockConfig[this.cells[i].type]["input type"]==I_SELECT&&(this.cells[i].input.option(e.i),this.cells[i].input.selected(e.i)),blockConfig[this.cells[i].type]["input type"]!=I_TEXT&&blockConfig[this.cells[i].type]["input type"]!=I_TEXT_AREA||(this.cells[i].type==T_BLOCK?this.cells[i].input.value(e.i):this.cells[i].input.value(e.d)),this.cells[i].refresh(this.viewXdelta,this.viewYdelta),1!=this.cells[i].hide&&0!=showGUI||this.cells[i].hideBlock(),this.cells[i].updateAllDivPositions(),this.rebuildMenuFlag=!0}nudgeX(e){jlog("Cells","nudgeX");let t=0;for(let l=0;l<this.length;l++)this.cells[l].x<e&&(t=max(t,e-this.cells[l].x));for(let e=0;e<this.length;e++)this.cells[e].moveC(this.cells[e].x+t,this.cells[e].y,this.viewXdelta,this.viewYdelta)}putInAddyBar(e=!1){jlog("Cells","putInAddyBar");let t=getURL();-1!=t.indexOf("#")&&(t=t.slice(0,t.indexOf("#")));let l=JSON.stringify(this.saveCells(e));return 1==this.createMode&&(this.presBackup.layout=this.getLayoutArray(),l=JSON.stringify(this.presBackup)),t+"#"+encodeURIComponent(l)}makeFromAddyBar(e=getURL()){if(jlog("Cells","makeFromAddyBar"),-1==e.indexOf("#"))return!1;try{let t=e.slice(e.indexOf("#")+1);"#"==t[0]&&(t=t.slice(1));let l=decodeURIComponent(t),i=JSON.parse(l),s=Object.keys(i).indexOf("layout");for(key in-1!=s&&(cells.layoutArray=i.layout),Object.keys(i))key!=s&&this.addCellWithInfo(i[key]);for(key in Object.keys(i))key!=s&&this.linkChildren(key,i[key]);if(1==showGUI)for(let e=0;e<this.length;e++)this.cells[e].reshape(!0);else for(let e=0;e<this.length;e++)this.cells[e].hideBlock()}catch(e){return console.log("failed to load",e),!1}return!0}linkChildren(e,t){jlog("Cells","linkChildren");let l=parseInt(e);t.c||(t.c=[]);for(let e=0;e<t.c.length;e++)this.cells[l].forcefullyAddChildren(t.c[e],this.cells[t.c[e]],!0)}pushChild(e,t,l,i){jlog("Cells","pushChild");let s=[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],h=new Cell(e,l.viewX,l.viewY,this.dWidth,this.dHeight,s,this.dRadius);return h.updateDataSH(i),h.input.value(i,i),l.addChild(this.length,h),h.addParent(t,l),this.cells.push(h),this.rebuildMenuFlag=!0,l.reshape(),h}replaceWithType(e,t,l,i,s){jlog("Cells","replaceWithType");let h=[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],o=new Cell(e,l.viewX,l.viewY,this.dWidth,this.dHeight,h,this.dRadius);o.parent=l.parent;let n=t.childIndicies.indexOf(i);return t.children[n]=o,l.mode=M_DELETE,l.cleanForDeletionSafe(),l.mode=M_IDLE,this.cells[i]=o,this.mapAndLink(),this.cells[i].updateDataSH(s.dataSH,!0),this.cells[i].updateHandleSH(s.handleSH),o}addCell(e,t,l=17){jlog("Cells","addCell"),this.rebuildMenuFlag=!0,this.mapAndLink();let i=t,s=[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]];e==T_START&&(s=[this.colors[e],this.highlights[e],this.colors[49],this.inverted[e],this.dualtone[e]]),this.cells.push(new Cell(e,i,l,this.dWidth,this.dHeight,s,this.dRadius));let h=this.length-1;if(e==T_PRINT&&(s=[this.colors[T_VAR],this.highlights[T_VAR],this.lowlights[T_VAR],this.inverted[T_VAR],this.dualtone[T_VAR]],this.cells.push(new Cell(T_VAR,i,l,this.dWidth,this.dHeight,s,this.dRadius)),this.cells[h].addChild(h+1,this.cells[h+1]),this.cells[h+1].addParent(h,this.cells[h]),this.cells[h+1].input.option("unset","unset"),this.cells[h+1].input.selected("unset")),e==T_INPUT){let e=this.getID(4);this.cells[h].updateHandleSH(e),this.varHandles.push(e)}if(e==T_IF||e==T_WHILE||e==T_FOR){let t=2;e==T_FOR?(this.cells.push(new Cell(T_RANGE,i,l,this.dWidth,this.dHeight,[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],this.dRadius)),this.cells[h+1].updateHandleSH("unset")):this.cells.push(new Cell(T_CONDITION,i,l,this.dWidth,this.dHeight,[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],this.dRadius)),this.cells.push(new Cell(T_DO,i,l,this.dWidth,this.dHeight,[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],this.dRadius));for(let e=1;e<=t;e++)this.cells[h].addChild(h+e,this.cells[h+e],!0),this.cells[h+e].addParent(h,this.cells[h],!0);this.cells[h].refresh(this.viewXdelta,this.viewYdelta)}if(-1!=blockConfig[e]["accept child"].indexOf(T_INDEX)){this.cells.push(new Cell(T_INDEX,i,l,this.dWidth,this.dHeight,[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],this.dRadius));let t=this.length-1;this.cells[h].addChild(t,this.cells[t]),this.cells[t].addParent(h,this.cells[h])}if(-1!=blockConfig[e]["accept child"].indexOf(T_REF)){this.cells.push(new Cell(T_REF,i,l,this.dWidth,this.dHeight,[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],this.dRadius));let t=this.length-1;this.cells[h].addChild(t,this.cells[t]),this.cells[t].addParent(h,this.cells[h])}if(-1!=blockConfig[e]["accept child"].indexOf(T_OUTLET)&&(this.cells.push(new Cell(T_OUTLET,i,l,this.dWidth,this.dHeight,[this.colors[e],this.highlights[e],this.lowlights[e],this.inverted[e],this.dualtone[e]],this.dRadius)),this.cells[h].addChild(h+1,this.cells[h+1]),this.cells[h+1].addParent(h,this.cells[h]),this.cells[h+1].handleSH="unset",this.cells[h+1].indexLabeldiv.html(this.cells[h+1].textLabel),this.cells[h+1].updateDataSH("unset"),this.cells[h+1].input.option("unset","unset"),this.cells[h+1].input.selected("unset"),-1==this.varHandles.indexOf("unset")&&this.varHandles.push("unset")),e==T_BLOCK){let e=this.getID(2);this.cells[h].updateHandleSH(e),this.cells[h].input.value(e,e)}if(this.cells[h].reshape(),e!=T_START&&e!=T_CONSOLE&&(this.cells[h].mode=M_NEW,this.activeIndex=h),e==T_TURTLE){let e=this.length;for(let t=0;t<turtleVars.length;t++)this.cells.push(new Cell(T_INLET,i,l,this.dWidth,this.dHeight,s,this.dRadius)),this.cells[e+t].updateHandleSH(turtleVars[t]),this.cells[e+t].updateDataSH(0),this.cells[h].addChild(e+t,this.cells[e+t]),this.cells[e+t].addParent(h,this.cells[h])}for(let e=h;e<this.length;e++)this.cellsInView.push(e);0==showGUI&&this.cells[h].hideBlock()}quickClear(e=!1){jlog("Cells","quickClear");let t=0;1==e&&(t=0);for(let e=t;e<this.length;e++)this.cells[e].indexLabeldiv.remove(),this.cells[e].input&&this.cells[e].input.remove();0==e&&(this.cells[0].children=[],this.cells[0].resetDims(!0),this.cells[0].childIndicies=[],this.cells[1].reshape(!0),this.cells.splice(2))}getID(e){jlog("Cells","getID");let t="";for(let l=0;l<e;l++)t+=this.varNames[floor(random(0,this.varNames.length))];return-1!=this.varHandles.indexOf(t)&&(t=this.getID()),t}checkSelected(e,t){jlog("Cells","checkSelected");let l=!1;if(-1!=this.activeIndex&&this.cells[this.activeIndex].mode==M_NEW)return this.cells[this.activeIndex].mode=M_MOVE,!0;for(let i=0;i<this.cellsInView.length;i++){let s=this.cellsInView[i];if(!0===this.cells[s].inArea(e,t)){if(l=!0,this.cells[s].mode=M_SELECTED,!0===this.cells[s].checkButtons(e,t)){this.activeIndex=s;break}}else this.cells[s].mode=M_IDLE,this.activeIndex=-1}return l}pprint(e){jlog("Cells","pprint");for(let e=0;e<this.cells.length;e++)String(e)+"\t";for(let e=0;e<this.cells.length;e++)String(this.cells[e].mode)+"\t";for(let e=0;e<this.cells.length;e++)String(this.cells[e].childIndicies.length)+"\t";for(let e=0;e<this.cells.length;e++)if(this.cells[e].childIndicies.length>0){"Cell "+String(e)+"\t\t\t";for(let t=0;t<this.cells[e].childIndicies.length;t++)String(this.cells[e].childIndicies[t])+"\t";"\n"}}startStop(e,t,l){jlog("Cells","startStop"),this.run=!this.run,this.cells[this.activeIndex].mode=M_IDLE,this.cells[this.activeIndex].toggleStartForm(this.run)}stop(){jlog("Cells","stop"),this.run=!1,this.cells[0].toggleStartForm(!1)}doDelete(e,t,l){jlog("Cells","doDelete"),this.rebuildMenuFlag=!0;let i=[],s=!1,h=[];if(1==this.length)this.cells[0].cleanForDeletionSafe(),this.cells=[];else{this.cells[this.activeIndex].markForDeletion();let e=[];for(let t=0;t<this.length;t++){if(this.cells[t].mode!=M_DELETE)e.push(t);else{this.cells[t].handleSH&&(s=!0,this.cells[t].type!=T_INPUT&&this.cells[t].type!=T_BLOCK&&i.push(this.cells[t].handleSH),"unset"!=this.cells[t].handleSH&&(h.push(this.cells[t].handleSH),this.varHandles.splice(this.varHandles.indexOf(this.cells[t].handleSH),1)));let e=this.cellsInView.indexOf(t);-1!=e&&(this.cellsInView.splice(e,1),this.parentFlag+=1)}let l=this.cells[t].cleanForDeletionSafe();if(-1!=l&&this.cells[l]){let e=this.cells[l].removeChild(t);for(;-1!=e;)this.cells[e]&&(this.cells[e].minHeight=0,this.cells[e].reshape(!0),e=this.cells[e].parent)}}for(let t=0;t<this.length;t++)for(let l=0;l<this.cells[t].childIndicies.length;l++){let i=this.cells[t].childIndicies[l],s=t,h=e.indexOf(i),o=e.indexOf(s);this.cells[i].parent=o,this.cells[t].childIndicies[l]=h}let t=[];for(let l=0;l<e.length;l++)t.push(this.cells[e[l]]);this.cells=t}if(this.activeIndex=-1,!0===s){for(let e=0;e<this.length;e++)blockConfig[this.cells[e].type]["input type"]==I_SELECT&&(this.cells[e].input.remove(),this.cells[e].buildDivs());for(let e=0;e<this.length;e++)blockConfig[this.cells[e].type]["input type"]==I_SELECT&&(-1!=h.indexOf(this.cells[e].handleSH)&&-1==i.indexOf(this.cells[e].handleSH)?this.cells[e].input.option("unset"):(this.cells[e].input.option(this.cells[e].handleSH),this.cells[e].input.selected(this.cells[e].handleSH)))}}doCopy(e=!1,t=-1){jlog("Cells","doCopy");let l=this.cells[this.activeIndex].type,i=this.cells[this.activeIndex].x,s=this.cells[this.activeIndex].y,h=this.cells[this.activeIndex].colors,o=this.cells[this.activeIndex].handleSH,n=this.cells[this.activeIndex].dataSH,c=this.cells[this.activeIndex].inputOptions;this.cells[this.activeIndex].mode=M_IDLE;const a=this.activeIndex;this.activeIndex=this.length;let d=!0;l==T_BLOCK&&(d=!1,l=T_GOTO,h=[this.colors[l],this.highlights[l],this.lowlights[l],this.inverted[l],this.dualtone[l]]),l!=T_INPUT&&l!=T_RANGE||(d=!1,l=T_VAR,h=[this.colors[l],this.highlights[l],this.lowlights[l],this.inverted[l],this.dualtone[l]]),0==e&&l==T_OUTLET&&(d=!1,l=T_VAR,h=[this.colors[l],this.highlights[l],this.lowlights[l],this.inverted[l],this.dualtone[l]]),l==T_INLET&&(d=!1,l=T_VAR),this.cells.push(new Cell(l,i,s,this.dWidth,this.dHeight,h,this.dRadius));let r=this.activeIndex;if(this.cells[this.activeIndex].mode=M_NEW,this.cells[this.activeIndex].handleSH=o,this.cells[this.activeIndex].dataSH=n,-1!=t&&(this.cells[this.activeIndex].parent=t),blockConfig[l]["input type"]==I_SELECT){for(let e=0;e<c.length;e++)this.cells[this.activeIndex].inputOptions.push(c[e]);this.cells[r].input.selected(this.cells[r].handleSH)}if(blockConfig[l]["input type"]==I_TEXT&&this.cells[this.activeIndex].input.value(n,n),1==d){const t=this.length;for(let e=0;e<this.cells[a].childIndicies.length;e++)this.activeIndex=this.cells[a].childIndicies[e],this.doCopy(!0,r);this.activeIndex=r;for(let e=t;e<this.length;e++){this.cells[e].mode=M_IDLE;let t=this.cells[e].parent;this.cells[t].addChild(e,this.cells[e]),this.cells[e].addParent(t,this.cells[t])}if(this.cells[this.activeIndex].mode=M_NEW,1==e)for(let e=this.length-1;e!=r;e--)this.cells[e].minHeight=0,this.cells[e].reshape(!0);this.mapAndLink()}}doMove(e,t,l){jlog("Cells","doMove"),this.cells[this.activeIndex].moveC(e,t,this.viewXdelta,this.viewYdelta),-1!=this.cells[this.activeIndex].parent&&(this.cells[this.cells[this.activeIndex].parent].removeChild(this.activeIndex),this.cells[this.activeIndex].removeParent())}doParentDrop(e,t,l){jlog("Cells","doParentDrop");let i=[];if(this.cells[this.activeIndex].type!=T_START)for(let s=0;s<this.cellsInView.length;s++){let h=this.cellsInView[s];!0===this.cells[h].inArea(e,t)&&h!=this.activeIndex?this.cells[h].underneath=l||this.cells[this.activeIndex].mode==M_NEW:this.cells[h].underneath=!1,!0===this.cells[h].inArea(e,t)&&h!=this.activeIndex?this.cells[h].acceptsChild(this.cells[this.activeIndex].type)&&(this.cells[h].highlight=l||this.cells[this.activeIndex].mode==M_NEW,i.push(h)):this.cells[h].highlight=!1}if(!1===l&&this.cells[this.activeIndex].mode==M_MOVE){if(0!=i.length){let e=[];for(let t=0;t<i.length;t++){let l=1;for(parent=this.cells[i[t]].parent;-1!=parent;)l+=1,this.cells[parent].type==T_GOTO?parent=-1:parent=this.cells[parent].parent;e.push(l)}let t=i[e.indexOf(max(e))];-1!=this.cells[this.activeIndex].parent&&(this.cells[this.cells[this.activeIndex].parent].removeChild(this.activeIndex),this.cells[this.activeIndex].removeParent()),1==this.cells[t].addChild(this.activeIndex,this.cells[this.activeIndex])&&(this.parentFlag+=1,this.cells[this.activeIndex].addParent(t,this.cells[t]),this.cells[t].refresh(this.viewXdelta,this.viewYdelta),this.parentWidthRecord=[t,this.cells[t].width])}this.cells[this.activeIndex].mode=M_IDLE,this.activeIndex=-1}}clean(){jlog("Cells","clean");for(let e=0;e<this.length;e++)-1!=this.cells[e].parent&&console.log(this.cells[this.cells[e].parent].childIndicies.indexOf(e))}mapAndLink(){jlog("Cells","mapAndLink");let e={};e[T_GOTO]=[],e[T_PUSH]=[],e[T_DELETE]=[],e[T_GET]=[],e[T_RUN]=[],e[T_SET]=[],e[T_LEN]=[],e[T_VAR]=[],e[T_OUTLET]=[],e[T_RANGE]=[];let t={};for(let l=0;l<this.length;l++){if(this.cells[l].updateSHs(),this.cells[l].type!=T_WHILE&&this.cells[l].type!=T_IF&&this.cells[l].type!=T_FOR&&this.cells[l].type!=T_CONDITION&&this.cells[l].type!=T_RANGE||(this.cells[l].dataSH=B_UNSET),this.cells[l].type==T_CONST){let e;this.cells[l].handleSH=e}this.cells[l].type==T_INPUT&&(e[T_VAR].push(this.cells[l].handleSH),e[T_OUTLET].push(this.cells[l].handleSH),e[T_PUSH].push(this.cells[l].handleSH),e[T_DELETE].push(this.cells[l].handleSH),e[T_GET].push(this.cells[l].handleSH),e[T_SET].push(this.cells[l].handleSH),e[T_RANGE].push(this.cells[l].handleSH),e[T_LEN].push(this.cells[l].handleSH),0==this.run&&(t[this.cells[l].handleSH]=this.cells[l].getDataSH())),this.cells[l].type==T_BLOCK&&(e[T_GOTO].push(this.cells[l].handleSH),e[T_PUSH].push(this.cells[l].handleSH),e[T_DELETE].push(this.cells[l].handleSH),e[T_GET].push(this.cells[l].handleSH),e[T_RUN].push(this.cells[l].handleSH),e[T_SET].push(this.cells[l].handleSH),e[T_LEN].push(this.cells[l].handleSH)),this.cells[l].reshape()}e[T_VAR]=e[T_VAR].concat(["unset","random","year","month#","monthS","day#","dayS","hour","minute","second","millis"]),e[T_OUTLET].push("unset"),e[T_RANGE].push("unset"),e[T_GOTO].push("unset"),e[T_PUSH].push("unset"),e[T_DELETE].push("unset"),e[T_GET].push("unset"),e[T_RUN].push("unset"),e[T_SET].push("unset"),e[T_LEN].push("unset");for(let l=0;l<this.length;l++)0!=this.run&&-1==this.partialUpdate.indexOf(l)||(this.cells[l].updateOptions(e),this.cells[l].type==T_VAR&&(this.cells[l].dataSH=t[this.cells[l].handleSH]),this.cells[l].mode==M_DELETE&&this.cells[l].cleanForDeletionSafe())}doMutate(){jlog("Cells","doMutate"),this.rebuildMenuFlag=!0;let e=this.cells[this.activeIndex];e.mode=M_IDLE;let t=blockConfig[e.type].handles.mutate,l=e.dataSH,i=e.handleSH,s=e.parent,h=this.cells[e.parent],o=e.children,n=e.childIndicies;e.indexLabeldiv.remove(),blockConfig[e.type]["input type"]!=I_NONE&&(e.input.remove(),e.input.remove());let c=0;-1!=s&&(c=h.childIndicies.indexOf(this.activeIndex)),e.mode=M_IDLE;let a=[this.colors[t],this.highlights[t],this.lowlights[t],this.inverted[t],this.dualtone[t]];this.cells[this.activeIndex]=new Cell(t,e.x,e.y,this.dWidth,this.dHeight,a,this.dRadius),this.cells[this.activeIndex].dataSH=l,this.cells[this.activeIndex].handleSH=i,this.cells[this.activeIndex].children=o,this.cells[this.activeIndex].childIndicies=n,this.cells[this.activeIndex].parent=s,-1!=s&&(h.children[c]=this.cells[this.activeIndex]);for(let e=0;e<this.cells[this.activeIndex].children.length;e++)-1!=[T_CONDITION,T_ELSE,T_DO,T_OUTLET,T_INDEX,T_REF].indexOf(this.cells[this.activeIndex].children[e].type)&&(this.cells[this.activeIndex].children[e].colors=a,this.cells[this.activeIndex].children[e].reStyle());if(t==T_SQRT){for(let e=2;e<this.cells[this.activeIndex].children.length;e++)this.cells[this.activeIndex].children[e].hideBlock();this.cells[this.activeIndex].minHeight=0,this.cells[this.activeIndex].reshape()}else for(let e=2;e<this.cells[this.activeIndex].children.length;e++)this.cells[this.activeIndex].children[e].showBlock();if(t==T_INPUT){let e=this.getID(4);this.cells[this.activeIndex].updateHandleSH(e),this.cells[this.activeIndex].input.value(l,l),this.varHandles.push(e)}this.cells[this.activeIndex].mode=M_IDLE,this.cells[this.activeIndex].reshape(this.viewXdelta,this.viewYdelta),-1!=s&&h.reshape(this.viewXdelta,this.viewYdelta)}hideAll(e=[12345675435678366e10]){for(let t=0;t<this.length;t++)-1==e.indexOf(this.cells[t].type)&&this.cells[t].hideBlock(!1)}update(e,t,l){if(jlog("Cells","update"),this.parentFlag>0){if(this.reshapeAllInView(),-1!=this.parentWidthRecord[0]){let e=this.cells[this.parentWidthRecord[0]].width-this.parentWidthRecord[1];for(let t=0;t<this.length;t++)this.cells[t].x>this.cells[this.parentWidthRecord[0]].x&&this.cells[t].pushX(e);this.reshapeAllInView()}this.parentWidthRecord=[-1,0],this.parentFlag-=1}if(0==this.run){if(-1!=this.activeIndex)if(this.cells[this.activeIndex].mode==M_MUTATE&&this.doMutate(),this.cells[this.activeIndex].mode==M_NEW&&this.doMove(e,t,!0),this.cells[this.activeIndex].mode==M_START&&this.startStop(e,t,l),this.cells[this.activeIndex].mode==M_DELETE)this.doDelete(e,t,l),this.mapAndLink();else{if(!0===l&&this.cells[this.activeIndex].mode==M_MOVE&&this.doMove(e,t,l),!0===l&&this.cells[this.activeIndex].mode==M_RESIZE&&(this.parentFlag=2,this.cells[this.activeIndex].resizeC(e,t)),!0===l&&this.cells[this.activeIndex].mode==M_EXPAND_OR_COLLAPSE)if(this.cells[this.activeIndex].type==T_LAYOUT_BLOCK)this.newLayoutBlock(this.getLayoutBlockBelowName(this.cells[this.activeIndex].handleSH),this.cells[this.activeIndex].x,this.cells[this.activeIndex].y+this.cells[this.activeIndex].height+5),this.cells[this.activeIndex].mode=M_IDLE;else if(this.parentFlag=2,this.cells[this.activeIndex].expandOrCollapse(),1==this.cells[this.activeIndex].shrink){let e=this.cells[this.activeIndex].parent;for(;-1!=e;)this.cells[e].minHeight=0,this.cells[e].reshape(!0),e=this.cells[e].parent}!0===l&&this.cells[this.activeIndex].mode==M_COPY&&(this.cells[this.activeIndex].type==T_LAYOUT_BLOCK?(this.newLayoutBlock(this.getLayoutBlockNextName(this.cells[this.activeIndex].handleSH),this.cells[this.activeIndex].x+this.cells[this.activeIndex].width+5,this.cells[this.activeIndex].y),this.cells[this.activeIndex].mode=M_IDLE):this.doCopy()),1==this.redrawFlag&&this.doParentDrop(e,t,l)}this.oldMouse==l&&1!=selectChanged||(this.mapAndLink(),this.oldMouse=l,selectChanged=!1)}else this.cells[0].mode==M_START&&this.startStop(e,t,l)}reshapeAllInView(){jlog("Cells","reshapeAllInView");for(let e=0;e<this.cellsInView.length;e++)null!=this.cells[this.cellsInView[e]]&&this.cells[this.cellsInView[e]].reshape(this.viewX,this.viewY,!1)}hideAllDivs(){jlog("Cells","hideAllDivs");for(let e=0;e<this.length;e++)this.cells[e].indexLabeldiv.hide(),this.cells[e].hideDivs()}showAllDivs(){jlog("Cells","showAllDivs");for(let e=0;e<this.length;e++)0==this.cells[e].hide&&(this.cells[e].indexLabeldiv.show(),this.cells[e].showDivs())}updateView(e,t,l){jlog("Cells","updateView"),this.viewXdelta=e,this.viewYdelta=t,this.redrawFlag=!1;for(let e=0;e<this.length;e++){if(1==this.cells[e].graphicUpdate&&(this.cells[e].graphicUpdate=!1,this.redrawFlag=!0),-1==this.cells[e].parent)this.cells[e].updateView(this.viewXdelta,this.viewYdelta);else{let t=this.cells[this.cells[e].parent].type,l=this.cells[e].type;-1==blockConfig[t]["accept child"].indexOf(l)&&this.cells[e].updateView(this.viewXdelta,this.viewYdelta)}1==l&&-1!=this.cellsInView.indexOf(e)&&(this.cells[e].updateAllDivPositions(),this.cells[e].refresh())}}cellInView(e){jlog("Cells","cellInView");let t=!1,l=-1*e.width,i=windowWidth,s=-1*e.height,h=windowHeight;return l<e.viewX&&e.viewX<i&&s<e.viewY&&e.viewY<h&&(t=!0),t}draw(e=null){jlog("Cells","draw"),this.cellsInView=[];for(let e=0;e<this.length;e++)this.cellInView(this.cells[e]),1==this.cellInView(this.cells[e])&&(this.cells[e].draw(),this.cellsInView.push(e));-1!=this.activeIndex&&this.cells[this.activeIndex].draw()}addCellsForPres(e,t=0){jlog("PresentationHelper","addCells");for(let l=t;l<e.length;l++)this.addCellForPres(e[l])}addCellForPres(e){jlog("PresentationHelper","addCell"),-1!=presComponents.indexOf(e.type)&&this.cells.push(e)}}class Controller{constructor(){jlog("Controller","constructor"),this.script,this.envChanged=!1,this.index=0,this.stackTrace={},this.workingStack=[],this.terminate,this.run=!1,this.activeCell=null,this.running=!1,this.prevIndex=-1,this.varMap={},this.varRecord=[],this.weHaveATurtlePeople=!1,this.turtleIndex=-1,this.tBuffX=[],this.tChangeX=!1,this.tBuffY=[],this.tChangeY=!1,this.stackNotes=[],this.stackSizeRecord=[],this.objectWideFlashFlag=!0,this.tidyFlag=!1}step(e,t){jlog("Controller","step"),this.objectWideFlashFlag=e;try{if(this.index<this.script.length){switch(this.activeCell=this.script[this.index],1==e&&this.stackTrace.length>1&&(this.activeCell.flash=!0,this.script[this.stackTrace[this.stackTrace.length-2]].flash=!1),this.activeCell.type){case T_START:this.t_start(this.activeCell,this.index);break;case T_GOTO:this.t_goto(this.activeCell,this.index);break;case T_BLOCK:0==this.t_block(this.activeCell,this.index)&&this.moveByParent();break;case T_PRINT:this.t_print(this.activeCell,this.index),this.moveByParent();break;case T_ASSIGN:this.t_assign(this.activeCell,this.index),this.moveByParent();break;case T_ADD:case T_SUBTRACT:case T_MULT:case T_DIV:case T_MOD:case T_AVERAGE:case T_SQRT:case T_ROUND:case T_HYPOT:case T_SIN:case T_COS:this.t_math(this.activeCell,this.index),this.moveByParent();break;case T_COMMENT:case T_VAR:case T_CONST:case T_INPUT:this.addToStack(this.index),this.moveByParent();break;case T_EQUAL:case T_LESS:case T_GREATER:this.t_compare(this.activeCell,this.index),this.moveByParent();break;case T_NOT:this.t_not(this.activeCell,this.index),this.moveByParent();break;case T_IF:0==this.t_if(this.activeCell,this.index)&&this.moveByParent();break;case T_WHILE:0==this.t_while(this.activeCell,this.index)&&this.moveByParent();break;case T_FOR:0==this.t_for(this.activeCell,this.index)&&this.moveByParent();break;case T_ELSE:case T_DO:this.index=this.script[this.index].parent;break;case T_LEN:this.t_len(this.activeCell,this.index),this.moveByParent();break;case T_GET:this.t_arrayOp(this.activeCell,this.index),this.moveByParent();break;case T_RUN:let e=this.index;this.t_arrayOp(this.activeCell,this.index),e==this.index&&this.moveByParent();break;case T_SET:case T_PUSH:case T_DELETE:this.t_arrayOp(this.activeCell,this.index),this.moveByParent();break;default:this.script[1].indexLabeldiv.html("<br>Something is missing",!0),this.HCF()}1==this.run&&1==t&&this.step(e,t)}else{this.run=!1;for(let e=0;e<cells.length;e++)cells.cells[e].flash=!1;if(this.printStack(),1==this.envChanged){this.tidyFlag=!0,this.d_print("<small>Your environment was updated.</small><br>");let e=createButton("reset env");e.addClass("basic"),e.parent(cells.cells[1].indexLabeldiv),e.mousePressed(loadBackup),cells.cells[1].indexLabeldiv.html("<br>",!0),this.script[1].lineNumber+=1,this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber}}}catch(e){this.HCF(),this.script[1].indexLabeldiv.html("\n"+e,!0),console.log(e)}}updateVarMap(e,t){jlog("Controller","updateVarMap"),"turtleX"==e&&(this.tChangeX=!0),"turtleY"==e&&(this.tChangeY=!0);for(let l=0;l<this.varMap[e].length;l++)this.varMap[e][l].updateDataSH(t);this.updateTurtle()}moveByParent(){jlog("Controller","moveByParent"),this.workingStack.length>100&&(this.script[1].indexLabeldiv.html("\n uncomfortably deep stack, time to die",!0),this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber,this.run=!1);let e=this.workingStack.pop();if(this.addToStack(e,0),this.script[e].flash=!1,this.script[e].type==T_CONDITION&&this.script[this.script[e].parent].type==T_IF&&(e=this.workingStack.pop(),this.addToStack(e,0)),this.script[e].type==T_RANGE&&this.script[this.script[e].parent].type==T_FOR){this.script[e].dataSHasType.number<this.script[this.script[e].parent].dataSHasType.number&&(this.script[this.script[e].parent].updateDataSH(B_UNSET),e=this.workingStack.pop(),this.addToStack(e,0))}if(this.script[e].type==T_CONDITION&&this.script[this.script[e].parent].type==T_WHILE){let t=this.workingStack.indexOf(this.script[e].parent);this.workingStack=this.workingStack.slice(0,t+1),this.addNote("shrunk working stack"),this.script[e].getDataSH()==B_FALSE&&(e=this.workingStack.pop(),this.addToStack(e,0))}if(this.script[e].flash=!1,this.workingStack.length<1)this.index=this.terminate;else{let t=this.workingStack[this.workingStack.length-1],l=this.script[t],i=l.childIndicies.indexOf(e);-1==i||i==l.childIndicies.length-1?(this.addToStack(t,0),this.moveByParent()):this.index=l.childIndicies[i+1]}}findBlock(e){jlog("Controller","findBlock");let t=-1;for(let l=0;l<this.script.length;l++)if((this.script[l].type==T_BLOCK||this.script[l].type==T_INPUT)&&this.script[l].handleSH==e){t=l;break}return"unset"==e?-1:t}getValue(e,t){let l;jlog("Controller","getValue");let i=-1;return-1!=mathFunctions.indexOf(e.type)?(this.t_math(e,t),l=e.children[0].getDataSH(),i=V_NUMBER):-1!=boolFunctions.indexOf(e.type)&&e.type!=T_NOT?(this.t_compare(e,t),l=e.getDataSH(),i=V_BOOL):e.type==T_LEN?(this.t_len(e,t),l=e.getDataSH(),i=V_NUMBER):e.type==T_NOT?(this.t_not(e,t),l=e.getDataSH(),i=V_BOOL):e.type==T_GET?(this.t_arrayOp(e,t),l=e.getDataSH(),1==/^\d+\.\d+$/.test(l)||1==/^\d+$/.test(l)||1==/^\-+\d+$/.test(l)||1==/^\-+\d+\.+\d+$/.test(l)?i=V_NUMBER:"true"==l||"false"==l?(i=V_BOOL,l="true"==l):i=V_STRING):(l=e.getDataSH(),1==/^\d+\.\d+$/.test(l)||1==/^\d+$/.test(l)||1==/^\-+\d+$/.test(l)||1==/^\-+\d+\.+\d+$/.test(l)?i=V_NUMBER:"true"==l||"false"==l?(i=V_BOOL,l="true"==l):i=V_STRING),{type:i,data:l}}lookAtChildren(e,t,l=0){jlog("Controller","lookAtChildren");let i=!0,s=!0,h=!1,o=[],n=[];for(let t=l;t<e.children.length;t++)if(e.children[t].type!=T_COMMENT){let l=this.getValue(e.children[t],e.childIndicies[t]);o.push(l.data),l.type==V_NUMBER?(s=!1,n.push(!0)):l.type==V_STRING?(s=!1,i=!1,h=!0,n.push(!1)):l.type==V_BOOL&&(i=!1,n.push(!1))}let c={};return c.onlyNums=i,c.vals=o,c.isNumbers=n,c.onlyBools=s,c.containsString=h,c}evaluateCondition(e,t,l){jlog("Controller","evaluateCondition");let i=!0,s=0;if(1==e){for(let e=0;e<l.length;e++)s+=int(l[e]);i=s==l.length}if(1==t)for(let e=0;e<l.length;e++)0==l[e]&&(i=!1);return i}startStop(e){if(jlog("Controller","startStop"),1==e.run&&0==this.running){this.run=!0,this.running=!0,this.index=0,e.mapAndLink(),e.mapAndLink(),backupObject=JSON.stringify(e.saveCells()),this.envChanged=!1,this.script=e.cells,this.terminate=this.script.length+1,this.stackTrace={},this.stackTrace.index=[],this.stackTrace.dir=[],this.stackTrace.label=[],this.stackTrace.handle=[],this.workingStack=[0],this.varRecord=[],this.tBuffX=[],this.tBuffY=[],this.varMap={},this.varMap.outlet=[],this.weHaveATurtlePeople=!1,this.stackNotes=[],this.stackSizeRecord=[];for(let t=0;t<e.length;t++)0==showGUI&&e.cells[t].hideBlock(),this.script[t].type!=T_VAR&&this.script[t].type!=T_OUTLET&&this.script[t].type!=T_INPUT||(this.script[t].handleSH in this.varMap||(this.varMap[this.script[t].handleSH]=[]),this.varMap[this.script[t].handleSH].push(this.script[t])),this.script[t].type==T_TURTLE&&(this.weHaveATurtlePeople=!0,this.turtleIndex=t);for(key in this.varMap)-1==e.varHandles.indexOf(key)&&(e.varHandles.push(key),this.startStop(e))}0==e.run&&(1==this.run&&this.printStack(),this.run=!1,this.running=!1),0==this.run&&(e.stop(),this.running=!1)}update(e,t,l){this.startStop(e),1==this.run&&this.step(t,l)}HCF(){jlog("Controller","HCF"),this.index=this.terminate,this.run=!1}printStack(){jlog("Controller","printStack"),0==showGUI&&cells.hideAllDivs();let e={};for(let t=0;t<this.stackTrace.index.length;t++)e[t]={},e[t]["stack depth"]=this.stackSizeRecord[t],e[t]["block index"]=this.stackTrace.index[t],e[t].name=this.stackTrace.label[t],e[t].handle=this.stackTrace.handle[t],e[t]["data state"]=this.varRecord[t],e[t].dir=1==this.stackTrace.dir[t]?"in":"out",e[t]["stack notes"]="";for(let t=0;t<this.stackNotes.length;t++){let l=this.stackNotes[t];e[l[0]]["stack notes"]=l[1]}1==printStack&&console.table(e)}addNote(e){jlog("Controller","addNote"),this.stackNotes.push([this.stackTrace.index.length-1,e])}addToStack(e,t=1){jlog("Controller","addToStack"),this.stackSizeRecord.push(this.workingStack.length),this.stackTrace.index.push(e),this.stackTrace.dir.push(t),this.stackTrace.label.push(this.script[e].textLabel),this.stackTrace.handle.push(this.script[e].handleSH),1==t&&(this.workingStack.push(e),this.script[e].flash=this.objectWideFlashFlag);let l="";for(key in this.varMap)this.varMap[key].length>0?l+=String(key)+": "+this.varMap[key][0].getDataSH()+" | ":l+=String(key)+" ";this.varRecord.push(l)}updateTurtle(){if(jlog("Controller","updateTurtle"),1==this.weHaveATurtlePeople&&(1==this.tChangeX&&(this.tBuffX.push(parseFloat(this.varMap.turtleX[0].getDataSH())),this.tChangeX=!1),1==this.tChangeY&&(this.tBuffY.push(parseFloat(this.varMap.turtleY[0].getDataSH())),this.tChangeY=!1),1==this.varMap.turtleDraw[0].dataSHasType.bool)){for(this.updateVarMap("turtleDraw",0);this.tBuffX.length<this.tBuffY.length;)this.tBuffX.push(this.tBuffX[this.tBuffX.length-1]);for(;this.tBuffX.length>this.tBuffY.length;)this.tBuffY.push(this.tBuffY[this.tBuffY.length-1]);for(let e=0;e<this.tBuffX.length-1;e++){let t=this.tBuffX[e],l=this.tBuffX[e+1],i=this.tBuffY[e],s=this.tBuffY[e+1];this.script[this.turtleIndex].canvas.line(t,i,l,s)}this.tBuffX=[],this.tBuffY=[]}}t_start(e,t){jlog("Controller","t_start"),this.addToStack(t),0==e.children.length?(this.run=!1,this.index=this.terminate):this.index=e.childIndicies[0]}t_goto(e,t){jlog("Controller","t_goto"),this.addToStack(t);let l=e.handleSH;this.index=this.terminate;for(let e=0;e<this.script.length;e++)l==this.script[e].handleSH&&this.script[e].type==T_BLOCK&&(this.index=e)}t_block(e,t){jlog("Controller","t_block"),this.addToStack(t);let l=!1;return 0!=e.children.length&&(l=!0,this.index=e.childIndicies[0]),l}buildPrintString(e,t){if(jlog("Controller","buildPrintString"),(t+=1)>20)return"max depth";let l="";for(let i=0;i<e.children.length;i++){if(e.children[i].type==T_GET)if(this.t_arrayOp(e.children[i],e.childIndicies[i]),-1==String(e.children[i].dataSH).indexOf("object:"))l+=e.children[i].dataSH;else{let s=this.unpackGet(e.children[i]);this.script[s].type==T_BLOCK||this.script[s].type==T_GOTO?(l+="[",l+=this.buildPrintString(this.script[s],t),l+="]"):l+=this.script[s].getDataSHForPrint()}else if(e.children[i].type==T_GOTO||e.children[i].type==T_BLOCK){let s=this.findBlock(e.children[i].handleSH);l+="[",l+=-1==s?"unset":this.buildPrintString(this.script[s],t),l+="]"}else e.children[i].type!=T_COMMENT&&(l+=String(this.script[e.childIndicies[i]].getDataSHForPrint()));i<e.children.length-1&&(l+=", ")}return l}d_print(e,t=!1,l=""){if(jlog("Controller","d_print"),this.script||(this.script=cells.cells),1==t){let t=this.script[1].indexLabeldiv.html();-1!=t.indexOf(l)&&(t=t.slice(0,t.indexOf(l))),t+=l+e,this.script[1].indexLabeldiv.html(t)}else this.script[1].indexLabeldiv.html("<br>"+e+"<br>",!0),this.script[1].lineNumber+=1,this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber}t_print(e,t){jlog("Controller","t_print"),this.addToStack(t);let l=this.script[1].lineNumber+": ";0==this.script[1].lineNumber&&(l="<br>"+this.script[1].lineNumber+": ");let i=this.buildPrintString(e,0).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;");console.log(i);let s=l+i+"<br>";1==presentationMode?addToPresentation(i,"console"):(this.script[1].indexLabeldiv.html(s,!0),this.script[1].lineNumber+=1,this.script[1].indexLabeldiv.elt.scrollTop=1e3*this.script[1].lineNumber)}t_assign(e,t){if(jlog("Controller","t_assign"),this.addToStack(t),this.lookAtChildren(e,t),e.children.length>1){let t=e.children[0].getDataSH(),l=e.childIndicies;for(let e=1;e<l.length;e++){let i=this.script[l[e]].handleSH;this.updateVarMap(i,t)}}}t_math(e,t){let l;jlog("Controller","t_math"),this.addToStack(t);let i=this.lookAtChildren(e,t,1),s=i.onlyNums,h=i.vals;i.isNumbers;if(s){l=parseFloat(h[0]),e.type==T_HYPOT&&(l=l**2);for(let t=1;t<h.length;t++)switch(e.type){case T_ADD:l+=parseFloat(h[t]);break;case T_SUBTRACT:l-=parseFloat(h[t]);break;case T_MULT:l*=parseFloat(h[t]);break;case T_DIV:l/=parseFloat(h[t]);break;case T_MOD:l%=parseFloat(h[t]);break;case T_AVERAGE:l+=parseFloat(h[t]);break;case T_HYPOT:l+=parseFloat(h[t])**2}switch(e.type){case T_SQRT:l=sqrt(l);break;case T_SIN:l=sin(l);break;case T_COS:l=cos(l);break;case T_ROUND:l=round(l)}e.type==T_AVERAGE&&(l/=h.length),e.type==T_HYPOT&&(l=sqrt(l))}let o=e.children[0].handleSH;this.updateVarMap(o,l)}t_compare(e,t){jlog("Controller","t_compare"),this.addToStack(t);let l=this.lookAtChildren(e,t,0),i=l.onlyNums,s=l.vals,h=(l.isNumbers,!0);if(0==s.length&&(h=!1),1==i){let t=s[0];for(let l=1;l<s.length;l++){switch(e.type){case T_EQUAL:t!=s[l]&&(h=!1);break;case T_GREATER:t<=s[l]&&(h=!1);break;case T_LESS:t>=s[l]&&(h=!1)}t=s[l]}}else{let t=s[0];for(let l=1;l<s.length;l++){switch(e.type){case T_EQUAL:t!=s[l]&&(h=!1);break;case T_GREATER:case T_LESS:h=!1}t=s[l]}}e.dataSH=h}t_not(e,t){jlog("Controller","t_not"),this.addToStack(t);let l=this.lookAtChildren(e,t,0),i=l.onlyNums,s=l.vals,h=(l.containsString,l.isNumbers,l.onlyBools),o=this.evaluateCondition(h,i,s);o=!o,e.dataSH=o}t_if(e,t){jlog("Controller","t_if"),this.addToStack(t);let l=e.children[0];e.dataSH=B_UNSET,this.t_condition(l,e.childIndicies[0]);let i=!1;l.getDataSH()==B_TRUE&&(i=!0);let s=e.children[1],h=(e.children[2],!1);return 1==i?(e.dataSH=B_TRUE,this.addToStack(e.childIndicies[1]),0!=s.children.length&&(this.index=s.childIndicies[0],h=!0)):e.dataSH=B_FALSE,h}runChildren(e,t){jlog("Controller","runChildren");for(let l=0;l<e.length;l++)switch(e[l].type){case T_EQUAL:case T_LESS:case T_GREATER:this.t_compare(e[l],t[l]);break;case T_NOT:this.t_not(e[l],t[l])}}t_condition(e,t){jlog("Controller","t_condition"),this.addToStack(t),e.dataSH=B_UNSET;let l=this.lookAtChildren(e,t,0),i=this.evaluateCondition(l.onlyBools,l.onlyNums,l.vals);e.dataSH=1==i?B_TRUE:B_FALSE}t_for(e,t){jlog("Controller","t_for"),this.addToStack(t);let l=!1;if(e.children[0].children.length>0){this.addToStack(e.childIndicies[0]),e.children[0].children[0].type==T_LEN&&this.t_len(e.children[0].children[0],e.children[0].childIndicies[0]);let t=e.children[0].children[0].dataSHasType.number;e.children[0].updateDataSH(t),e.updateDataSH(e.dataSHasType.number+1),e.dataSH<=t&&(l=!0),this.updateVarMap(e.children[0].handleSH,e.dataSHasType.number-1)}return 1==l&&e.children[1].children.length>0&&(this.addToStack(e.childIndicies[1]),this.index=e.children[1].childIndicies[0]),l}t_while(e,t){jlog("Controller","t_while"),this.addToStack(t);let l=e.children[0];e.dataSH=B_UNSET,this.t_condition(l,e.childIndicies[0]);let i=!1;l.getDataSH()==B_TRUE&&(i=!0);let s=e.children[1],h=!1;return 1==i?(e.dataSH=B_TRUE,this.addToStack(e.childIndicies[1]),0!=s.children.length&&(this.index=s.childIndicies[0],h=!0)):(e.dataSH=B_FALSE,h=!1),h}t_len(e,t){jlog("Controller","t_len"),this.addToStack(t);let l=this.findBlock(e.handleSH);-1!=l&&(e.dataSH=-1,this.script[l].type==T_INPUT?e.updateDataSH(this.script[l].dataSHasType.string.length):e.updateDataSH(this.script[l].children.length))}unpackGet(e){if(jlog("Controller","unpackGet"),-1!=e.dataSH.indexOf("object:")){let t=parseInt(e.dataSH.slice("object:".length));return"undefined"==String(this.script[t].handleSH)?t:this.findBlock(this.script[t].handleSH)}return e.dataSH}t_arrayOp(e,t){if(jlog("Controller","t_arrayOp"),this.addToStack(t),0==e.children[0].children.length)return;let l=this.findBlock(e.handleSH);if(-1==l||e.children.length<1||"unset"==e.handleSH)return void e.updateDataSH(-1);this.tidyFlag=!0;let i=this.script[l].type,s=parseInt(e.children[0].children[0].dataSH);if(e.type==T_GET||e.type==T_RUN)if(this.tidyFlag=!1,i==T_INPUT){let t=String(this.script[l].dataSH),i=t[s%t.length];e.updateDataSH(i)}else{let t=this.script[l].children,i=t[s%t.length];for(;s<0;)s+=t.length;s%=t.length;let h=this.script[l].childIndicies[s];if(e.type==T_RUN&&(i.type==T_BLOCK||i.type==T_GOTO))return void(this.index=h);this.addToStack(h),"undefined"!=String(i.dataSH)?e.updateDataSH(i.dataSH):e.updateDataSH("object:"+this.script[l].childIndicies[s])}else if(e.type==T_PUSH){this.lookAtChildren(e.children[0],e.childIndicies[0],0),this.envChanged=!0;let t=0;if(e.children[0].children.length>0&&(t=e.children[0].children[0].getDataSH()),i==T_INPUT){this.script[l].updateDataSH(this.script[l].dataSHasType.string+String(t),!0);let e=this.script[l].handleSH;this.updateVarMap(e,this.script[l].getDataSH())}else{let i=T_CONST;e.children[0].children[0].type==T_GOTO&&(i=T_GOTO);let s=cells.pushChild(i,l,this.script[l],t);i==T_GOTO&&(s.updateHandleSH(e.children[0].children[0].handleSH),s.forceHandleSH=!0),this.script.push(s),this.terminate=this.script.length+1}}else if(e.type==T_SET){this.lookAtChildren(e.children[0],e.childIndicies[0],0),this.lookAtChildren(e.children[1],e.childIndicies[1],0),this.envChanged=!0;let t=String(e.children[1].children[0].getDataSH());if(i==T_INPUT){t=t[0];let e=this.script[l].dataSHasType.string;s%=e.length;let i=e.substring(0,s)+t+e.substring(s+1);this.script[l].updateDataSH(i,!0);let h=this.script[l].handleSH;this.updateVarMap(h,this.script[l].getDataSH())}else{let t=e.children[1].children[0].type;t==T_GET&&(t=T_CONST),s%=this.script[l].children.length;let i=this.script[l].children[s],h=this.script[l].childIndicies[s];cells.replaceWithType(t,this.script[l],i,h,e.children[1].children[0]),this.script=cells.cells}}else if(e.type==T_DELETE)if(this.envChanged=!0,i==T_INPUT){let e=this.script[l].dataSHasType.string;s%=e.length;let t=e.slice(0,s)+e.slice(s+1);this.script[l].updateDataSH(t,!0),this.updateVarMap(this.script[l].handleSH,this.script[l].getDataSH())}else{if(0==this.script[l].children.length)return;s%=this.script[l].children.length;let e=this.script[l].childIndicies[s];cells.cells[e].markForDeletion();let t=[];for(let e=0;e<cells.length;e++)cells.cells[e].mode==M_DELETE&&t.push(e);cells.activeIndex=e,cells.doDelete(),this.script=cells.cells,this.terminate-=t.length;for(let e=0;e<t.length;e++)for(let l=0;l<this.workingStack.length;l++)this.workingStack[l]>t[e]&&(this.workingStack[l]-=1)}}}function newCell(e,t=-1,l=-1){jlog("Main","newCell"),e=int(e);let i=0;0==mobileDeviceDetected?(i=cells.length,cells.addCell(e,t,l),pres.addCellsForPres(cells.cells,i)):1==mobileHAddon?(i=cells.length,cells.addCell(mobileHType,t,l),pres.addCellsForPres(cells.cells,pas),mobileHAddon=!1):(mobileHType=e,mobileHAddon=!0),myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv()}function setTidyFlag(){jlog("Main","tidy"),tidyFlag=3}function tidy(){if(jlog("Main","tidy"),0==cells.run){if(runMode==RM_NORMAL){let e=2*myDivs.menu.x+myDivs.menu.size().width;cells.tidy(round(e/(gridSize/2))*(gridSize/2),gridSize),1==zoomMode&&cells.update(mouseX,mouseY,mouseIsPressed)}if(runMode==RM_CREATE){let e=2*myDivs.presTools.y+myDivs.presTools.size().height;pres.tidy(myDivs.presTools.x/pixelDensity(),e),1==zoomMode&&pres.update(mouseX,mouseY,mouseIsPressed)}}}function colorSetup(){jlog("Main","colorSetup");let e,t,l=[],i=[],s=[],h=[],o=[];for(let e=0;e<c.length;e++)l.push(color("#"+c[e]));delete c;for(let n=0;n<l.length;n++)e=l[n].levels[0]+l[n].levels[1]+l[n].levels[2],t=(l[n].maxes.rgb[0]+l[n].maxes.rgb[1]+l[n].maxes.rgb[2])/2,i.push(color(l[n].maxes.rgb[0]-l[n].levels[0],l[n].maxes.rgb[1]-l[n].levels[1],l[n].maxes.rgb[2]-l[n].levels[2])),e>t?(h.push(lerpColor(l[n],color(0),.7)),o.push(lerpColor(l[n],color(255),.2)),s.push(color(0))):(h.push(lerpColor(l[n],color(255),.7)),o.push(lerpColor(l[n],color(0),.2)),s.push(color(255)));allColors.colors=l,allColors.icolors=i,allColors.dtcolors=s,allColors.highlights=h,allColors.lowlights=o}function saveCells(e=!1){jlog("Main","saveCells");let t=cells.saveCells();console.log(JSON.stringify(t));let l="demo"+String(demos.length)+".json";1==e&&(l="wip-demo.json"),save(t,l,!0),setTidyFlag()}function loadBackup(){jlog("Main","loadBackup");let e=cells.cells[1].indexLabeldiv.html(),t=cells.cells[1].lineNumber;cells.saveCells();clearCells(),cells.cells[0].indexLabeldiv.remove(),cells.cells[1].indexLabeldiv.remove(),cells.cells=[];let l=JSON.parse(backupObject);for(key in Object.keys(l))cells.addCellWithInfo(l[key]);for(key in Object.keys(l))cells.linkChildren(key,l[key]);for(let e=0;e<this.length;e++)this.cells[e].reshape(!0);cells.cells[1].indexLabeldiv.html(e),cells.cells[1].lineNumber=t,cells.cells[1].indexLabeldiv.elt.scrollTop=1e3*cells.cells[1].lineNumber,setTidyFlag()}function shareLink(){jlog("Main","shareLink"),myDivs.shareLink=createDiv(),myDivs.shareLink.style("background-color","DimGray"),myDivs.shareLink.style("padding","10px"),myDivs.shareLink.style("outline","1px solid black");myDivs.shareLink.size(200,null),myDivs.shareLink.style("overflow","auto"),myDivs.shareLink.position(windowWidth/2-100,40),myDivs.shareLink.show(),addButtonToDiv("share project",1,shareProject,myDivs.shareLink,"header"),addButtonToDiv("create presentation",1,createPresentation,myDivs.shareLink,"header"),addButtonToDiv("cancel",1,cancelShare,myDivs.shareLink),noClickZone=[0,windowWidth,0,windowHeight]}function cancelShare(){jlog("Main","cancelShare"),myDivs.shareLink.remove(),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight],doMouseDrag=!1}function createPresentation(){jlog("Main","createPresentation"),backupObject=JSON.stringify(cells.saveCells()),pres.presBackup=cells.saveCells(!0),cells.addIDsForCreateMode(),redrawCounter=2,0==pres.length&&pres.addCellsForPres(cells.cells),cancelShare(),presCreationMode=!0,runMode=RM_CREATE,cells.hideAll(presComponents),myDivs.presTools=createDiv(),myDivs.presTools.style("background-color","DimGray"),myDivs.presTools.style("padding","10px"),myDivs.presTools.style("outline","1px solid black"),myDivs.presTools.size(myDivs.menu.width,null),myDivs.presTools.style("overflow","auto"),myDivs.presTools.position(10,10),myDivs.presTools.show(),hideMenu=!0,myDivs.menu.hide(),addButtonToDiv("share presentation",1,sharePresentation,myDivs.presTools),addButtonToDiv("center",13,imlost,myDivs.presTools),addButtonToDiv("back",1,exitPresentationMode,myDivs.presTools),pres.cleanForCreateMode(),setTidyFlag()}function exitPresentationMode(){hideMenu=!1,presCreationMode=!1,showGUI=!0,pres.removeCreateMode(),loadBackup(),myDivs.menu.show(),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight],myDivs.presTools.remove(),runMode=RM_NORMAL,redrawCounter=4,cells.updateView(xPos,yPos,!0)}function sharePresentation(){let e=(shareLinkString=pres.putInAddyBar(!0)).replace("#","##");exitPresentationMode(),window.open(e),doMouseDrag=!1}function shareProject(){jlog("Main","shareProject"),shareLinkString=cells.putInAddyBar(),cancelShare(),window.open(shareLinkString)}function loadCells(e){jlog("Main","loadCells"),imlost(),xOff=0,yOff=0,xPos=0,yPos=0;for(let e=0;e<cells.length;e++)cells.cells[e].mode=M_DELETE,cells.cells[e].cleanForDeletionSafe();for(key in cells.cells[0].indexLabeldiv.remove(),cells.cells[1].indexLabeldiv.remove(),cells=new Cells(allColors.colors,allColors.highlights,allColors.lowlights,allColors.icolors,allColors.dtcolors),mobileSettings(),Object.keys(e))cells.addCellWithInfo(e[key]);for(key in Object.keys(e))cells.linkChildren(key,e[key]);let t=2*myDivs.menu.x+myDivs.menu.size().width;cells.nudgeX(t),setTidyFlag(),myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv(),cells.updateView(xPos,yPos,!0),setTidyFlag(),redrawCounter=4,pres.cells=[],pres.addCellsForPres(cells.cells)}function mobileSettings(){jlog("Main","mobileSettings"),1==zoomMode?(fontSizeString="10px",cells.dWidth=40,cells.dHeight=20,cells.dRadius=4):(cells.dWidth=80,cells.dHeight=40,cells.dRadius=5,fontSizeString="12px")}function showHideBlockMenu(){jlog("Main","showHideBlockMenu"),1==(showBlockMenu=!showBlockMenu)?(myDivs.blocks.main.show(),myDivs.demos.hide(),showDemoMenu=!1,myDivs.utils.hide(),showUtils=!1):(myDivs.blocks.main.hide(),restyleMenuDiv(),0!=submenu&&(myDivs.blocks[submenu].hide(),submenu=0))}function showHideDemoMenu(){jlog("Main","showHideDemoMenu"),1==(showDemoMenu=!showDemoMenu)?(myDivs.blocks.main.hide(),showBlockMenu=!1,myDivs.utils.hide(),showUtils=!1,myDivs.demos.show()):(myDivs.demos.hide(),restyleMenuDiv())}function clearCells(){jlog("Main","clearCells"),controller.d_print("Clearing..."),cells.quickClear(),createMenuDiv()}function toggleSpeedMode(){jlog("Main","toggleSpeedMode"),(speedMode+=1)>2&&(speedMode=0),slowMode=!1,fastMode=!1,2==speedMode&&(slowMode=!0),1==speedMode&&(fastMode=!0),speedButton.html("speed: "+String(speedMode+1))}function toggleFlash(){jlog("Main","toggleFlash"),flash=!flash,flashButton.html("flash: "+String(flash))}function showAll(){jlog("Main","showAll");for(let e=0;e<userBlocks.length;e++)cells.addCell(userBlocks[e],1.5*myDivs.menu.size().width),cells.cells[cells.activeIndex].mode=M_IDLE;setTidyFlag()}function drawGrid(){jlog("Main","drawGrid");for(let e=0;e<windowWidth;e+=bgGrid.width)for(let t=0;t<windowHeight;t+=bgGrid.height)image(bgGrid,e+xPos%20,t+yPos%20)}function mouseDrag(){jlog("Main","mouseDrag"),0==mouseIsPressed&&(doMouseDrag=!1),1==disableDrag&&(doMouseDrag=!1),1==doMouseDrag?(xOff=xStart-mouseX,yOff=yStart-mouseY,xPos-=.1*xOff,yPos-=.1*yOff):(xOff=0,yOff=0)}function imlost(){jlog("Main","imlost"),xPos=0,yPos=0}function togglezoomMode(){jlog("Main","togglezoomMode"),zoomMode=!zoomMode;let e=cells.cells[1].indexLabeldiv.html(),t=cells.cells[1].lineNumber;loadCells(cells.saveCells()),cells.cells[1].indexLabeldiv.html(e),cells.cells[1].lineNumber=t,cells.cells[1].indexLabeldiv.elt.scrollTop=1e3*cells.cells[1].lineNumber,myDivs.menu.html("");for(let e=0;e<cells.length;e++)cells.cells[e].resetDims();0==zoomMode?myDivs.menu.style("font-size","16px"):myDivs.menu.style("font-size","12px")}function newCellFromButtonClick(e){jlog("Main","newCellFromButtonClick"),type=e.srcElement.value,newCell(type,mouseX,mouseY)}function createAddBlockMenu(e,t){jlog("Main","createAddBlockMenu");for(let l=0;l<e.length;l++)addButtonToDiv("+ "+blockConfig[e[l]]["block label"],e[l],newCellFromButtonClick,t,"colorcoded")}function loadCellsFromButtonClick(e){jlog("Main","loadCellsFromButtonClick"),index=parseInt(e.srcElement.value),loadCells(demos[index])}function showBlocksubmenu(e){jlog("Main","showBlocksubmenu");let t=submenu;submenu=parseInt(e.srcElement.value);for(let e=1;e<=7;e++)myDivs.blocks[e].hide();t==submenu?submenu=0:myDivs.blocks[submenu].show(),restyleMenuDiv()}function addButtonToDiv(e,t,l,i,s="basic"){jlog("Main","addButtonToDiv");let h=createButton(e,String(t));if(h.addClass("basic"),"colorcoded"==s){let e=allColors.dtcolors[t].toString("#rrggbb"),l=allColors.colors[t].toString("#rrggbb");h.style("color",e),h.style("text-align","left"),h.style("background-image","linear-gradient("+l+", "+l+")"),h.style("border-color","DimGray")}else"dev"==s?(h.style("height","18px"),h.style("background-image","linear-gradient(DimGray, DimGray)"),h.style("border-color","DimGray"),h.style("box-shadow","rgba(255,255,255,.6) 0 0px 0 inset"),h.style("color","LightGray")):"header"==s?h.style("background-image","linear-gradient(#b7b8ba ,#a7a9ac)"):"demo"==s?h.style("text-align","left"):"eg"==s?(h.style("text-align","left"),h.style("background-image","linear-gradient(#d7d8da ,#c7c9cc)")):"big"==s&&(h.style("height","100%"),h.style("width","100%"));h.parent(i),0!=l&&h.mousePressed(l),"speedID"==s?speedButton=h:"flashID"==s&&(flashButton=h),i.html("<br>",!0)}function blocksMenu(){jlog("Main","blocksMenu"),addButtonToDiv("blocks menu",0,showHideBlockMenu,myDivs.menu,"header"),myDivs.blocks={},myDivs.blocks.main=createDiv();for(let e=1;e<=7;e++)myDivs.blocks[e]=createDiv();createAddBlockMenu(containers,myDivs.blocks[1]),createAddBlockMenu(handles,myDivs.blocks[2]),createAddBlockMenu(arrayTools,myDivs.blocks[7]),createAddBlockMenu(mathFunctions,myDivs.blocks[3]),createAddBlockMenu(boolFunctions,myDivs.blocks[4]),createAddBlockMenu(conditionals,myDivs.blocks[5]),createAddBlockMenu(utilities,myDivs.blocks[6]);for(let e=1;e<=7;e++)myDivs.blocks[e].hide();addButtonToDiv("data containers",1,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[1].parent(myDivs.blocks.main),addButtonToDiv("data references",2,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[2].parent(myDivs.blocks.main),addButtonToDiv("array tools",7,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[7].parent(myDivs.blocks.main),addButtonToDiv("math",3,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[3].parent(myDivs.blocks.main),addButtonToDiv("comparison",4,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[4].parent(myDivs.blocks.main),addButtonToDiv("conditionals",5,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[5].parent(myDivs.blocks.main),addButtonToDiv("utilities",6,showBlocksubmenu,myDivs.blocks.main),myDivs.blocks[6].parent(myDivs.blocks.main),addButtonToDiv("show all",6,showAll,myDivs.blocks.main),myDivs.blocks.main.parent(myDivs.menu),0==showBlockMenu?myDivs.blocks.main.hide():0!=submenu&&myDivs.blocks[submenu].show()}function demoMenu(){jlog("Main","demoMenu"),myDivs.menu.html("<br>",!0),addButtonToDiv("demo menu",6,showHideDemoMenu,myDivs.menu,"header"),myDivs.demos=createDiv(),addButtonToDiv("Hello, World!",0,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Turing bit flip",14,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Programmable TM",15,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Sleep Sort",7,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("Draw Polygons",8,loadCellsFromButtonClick,myDivs.demos,"demo"),addButtonToDiv("blocks",1,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("assigning",2,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("basic math",3,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("comparisons",4,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("if",5,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("if not",6,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("while and array get",9,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("array/string push",10,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("array/string set",11,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("string delete",12,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("array delete",13,loadCellsFromButtonClick,myDivs.demos,"eg"),addButtonToDiv("test all",13,testAll,myDivs.demos),myDivs.demos.parent(myDivs.menu),0==showDemoMenu?myDivs.demos.hide():myDivs.demos.show()}function showHideUtilMenu(){jlog("Main","showHideUtilMenu"),1==(showUtils=!showUtils)?(myDivs.utils.show(),myDivs.demos.hide(),showDemoMenu=!1,myDivs.blocks.main.hide(),showBlockMenu=!1):(myDivs.utils.hide(),restyleMenuDiv())}function utilitiesMenu(){jlog("Main","utilitiesMenu"),myDivs.menu.html("<br>",!0),addButtonToDiv("tools",13,showHideUtilMenu,myDivs.menu,"header"),myDivs.utils=createDiv(),addButtonToDiv("clear",13,clearCells,myDivs.utils),addButtonToDiv("tidy",13,setTidyFlag,myDivs.utils),addButtonToDiv("speed: "+String(speedMode+1),13,toggleSpeedMode,myDivs.utils,"speedID"),addButtonToDiv("flash: "+String(flash),13,toggleFlash,myDivs.utils,"flashID"),addButtonToDiv("origin",13,imlost,myDivs.utils),addButtonToDiv("share",13,shareLink,myDivs.utils),addButtonToDiv("refactor",13,refactor,myDivs.utils),addButtonToDiv(0==zoomMode?"zoom out":"zoom in",13,togglezoomMode,myDivs.utils),myDivs.utils.parent(myDivs.menu),1==showUtils?myDivs.utils.show():myDivs.utils.hide(),myDivs.menu.html("<br>",!0),addButtonToDiv("about",0,openAbout,myDivs.menu),myDivs.menu.html("<br>",!0),addButtonToDiv("version 0.000..01",13,showDevDiv,myDivs.menu,"dev")}function openAbout(){jlog("Main","openAbout"),window.open("https://b38tn1k.com/code/ux/2022/09/08/blocks-explained/")}function closeRefactorDiv(){jlog("Main","closeRefactorDiv"),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight];let e=String(JSON.stringify(cells.saveCells()));for(let t=0;t<myDivs.refactorInputs.length;t++)e=e.replaceAll(myDivs.refactorPriors[t],myDivs.refactorInputs[t].value());let t=cells.cells[1].indexLabeldiv.html(),l=cells.cells[1].lineNumber;cells.saveCells();clearCells(),cells.cells[0].indexLabeldiv.remove(),cells.cells[1].indexLabeldiv.remove(),cells.cells=[];let i=JSON.parse(e);for(key in Object.keys(i))cells.addCellWithInfo(i[key]);for(key in Object.keys(i))cells.linkChildren(key,i[key]);for(let e=0;e<this.length;e++)this.cells[e].reshape(!0);cells.cells[1].indexLabeldiv.html(t),cells.cells[1].lineNumber=l,cells.cells[1].indexLabeldiv.elt.scrollTop=1e3*cells.cells[1].lineNumber,myDivs.refactor.remove(),myDivs.refactorInputs=[],myDivs.refactorPriors=[]}function refactor(){jlog("Main","refactor"),jlog("Main","refactor"),myDivs.refactor=createDiv(),myDivs.refactor.style("background-color","DimGray"),myDivs.refactor.style("padding","10px"),myDivs.refactor.style("outline","1px solid black");myDivs.refactor.size(200,null),myDivs.refactor.style("overflow","auto"),myDivs.refactor.position(windowWidth/2-100,40),myDivs.refactor.show();let e=new Set;for(let t=0;t<cells.length;t++)cells.cells[t].handleSH&&-1==["turtleY","turtleX","turtleDraw","unset","random","year","month#","monthS","day#","dayS","hour","minute","second","millis"].indexOf(cells.cells[t].handleSH)&&e.add(cells.cells[t].handleSH);myDivs.refactorInputs=[],myDivs.refactorPriors=[];for(const t of e.keys()){let e=createInput(t);e.parent(myDivs.refactor),myDivs.refactorInputs.push(e),myDivs.refactorPriors.push(t)}addButtonToDiv("rename & close",1,closeRefactorDiv,myDivs.refactor,"header"),noClickZone=[0,windowWidth,0,windowHeight]}function restyleMenuDiv(){if(myDivs.menu.style("background-color","DimGray"),myDivs.menu.style("padding","10px"),myDivs.menu.style("outline","1px solid black"),myDivs.menu.size().height>windowHeight-50){let e=windowHeight-50;myDivs.menu.size(null,e)}else myDivs.menu.size(null,null);myDivs.menu.style("overflow","auto"),myDivs.menu.position(10,10)}function createMenuDiv(){if(jlog("Main","createMenuDiv"),myDivs.menu.remove(),1==showGUI){if(myDivs.menu=createDiv(),blocksMenu(),demoMenu(),utilitiesMenu(),0==zoomMode?myDivs.menu.style("font-size","16px"):myDivs.menu.style("font-size","12px"),myDivs.menu.style("background-color","DimGray"),myDivs.menu.style("padding","10px"),myDivs.menu.style("outline","1px solid black"),myDivs.menu.size().height>windowHeight-50){let e=windowHeight-50;myDivs.menu.size(null,e)}else myDivs.menu.size(null,null);myDivs.menu.style("overflow","auto"),myDivs.menu.position(10,10),noClickZone=[10,myDivs.menu.size().width+10,windowHeight-2*myDivs.menu.size().height,windowHeight],1==hideMenu?(myDivs.menu.hide(),noClickZone=[-1,-1,-1,-1]):myDivs.menu.show(),showDev=!showDev,showDevDiv()}}function toggleDevOptions(e){switch(jlog("Main","toggleDevOptions"),item=parseInt(e.srcElement.value),item){case 0:showFPS=!showFPS;break;case 1:clickDebug=!clickDebug;break;case 2:printStack=!printStack;break;case 3:doJLOGCountDown=50}}function showDevDiv(){0!=(showDev=!showDev)?(myDivs.devDiv&&myDivs.devDiv.remove(),myDivs.devDiv=createDiv(),myDivs.devDiv.style("font-size","12px"),myDivs.devDiv.style("background-color","DimGray"),myDivs.devDiv.style("padding","10px"),myDivs.devDiv.style("outline","1px solid black"),addButtonToDiv("save json",0,saveCells,myDivs.devDiv),addButtonToDiv("show FPS",0,toggleDevOptions,myDivs.devDiv),addButtonToDiv("click log",1,toggleDevOptions,myDivs.devDiv),addButtonToDiv("print stack",2,toggleDevOptions,myDivs.devDiv),addButtonToDiv("tmi log",3,toggleDevOptions,myDivs.devDiv),addButtonToDiv("free colors",3,whatsLeft,myDivs.devDiv),addButtonToDiv("clean",3,cells.clean,myDivs.devDiv),addButtonToDiv("load wip",demos.length-1,loadCellsFromButtonClick,myDivs.devDiv),myDivs.devDiv.position(windowWidth-(40+myDivs.devDiv.size().width),10)):myDivs.devDiv&&myDivs.devDiv.remove()}function setupScreen(){jlog("Main","setupScreen"),jlog("Main","setupScreen"),pixelDensity(1),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(zoomMode=!0,mobileDeviceDetected=!0),createCanvas(windowWidth,windowHeight),windowWidth/windowHeight<.625&&(zoomMode=!0);let e=gridSize**2;bgGrid=createGraphics(e,e);for(let t=gridSize/2;t<e;t+=gridSize)for(let l=gridSize/2;l<e;l+=gridSize)bgGrid.point(t,l);widthOnTwo=windowWidth/2,heightOnTwo=windowHeight/2,showDev=!showDev,showDevDiv()}function doLastBit(){jlog("Main","doLastBit");let e=!1,t=-1,l=getURL();if(-1!=l.indexOf("#tutorial"))tutorial=!0,tutorialstring=l.slice(l.indexOf("#tutorial"),l.length);else if(-1!=l.indexOf("#demo")){let e=l.split("demo");t=parseInt(e[e.length-1])}else e=cells.makeFromAddyBar();e=doTutorials(e),0==e&&(cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),-1!=t&&t<demos.length&&loadCells(demos[t]),setTidyFlag()),cells.length>1&&cells.cells[1].resizeConsole(),myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv(),createPresentationDiv()}function createPresentationDiv(){jlog("Main","createPresentationDiv"),presentationDivs.main=createDiv(),presentationDivs.main.style("font-size","16px"),presentationDivs.main.style("padding","10px"),presentationDivs.main.style("overflow","auto"),presentationDivs.main.position(10,10),1==presentationMode?(presentationDivs.main.show(),console.log(cells.layoutArray)):presentationDivs.main.hide(),presentationDivs.defaultItemsWrapper=createDiv(),presentationDivs.defaultItemsWrapper.style("font-size","16px"),presentationDivs.defaultItemsWrapper.style("border","1px solid black"),presentationDivs.defaultItemsWrapper.size(null,100),presentationDivs.defaultItemsWrapper.parent(presentationDivs.main),presentationDivs.startbutton=createDiv(),presentationDivs.startbutton.style("float","left"),presentationDivs.startbutton.size(100,null),presentationDivs.startbutton.style("padding","10px"),addButtonToDiv("run",3,runFromButton,presentationDivs.startbutton),presentationDivs.startbutton.parent(presentationDivs.defaultItemsWrapper),presentationDivs.console=createDiv("<strong>console:</strong><br>"),presentationDivs.console.size(200,presentationDivs.defaultItemsWrapper.size().height),presentationDivs.console.style("overflow","scroll"),presentationDivs.console.style("background-color","black"),presentationDivs.defaultItemsWrapper.style("border","1px solid black"),presentationDivs.console.parent(presentationDivs.defaultItemsWrapper)}function runFromButton(){cells.run=!cells.run,fastMode=1}function addToPresentation(e,t){jlog("Main","addToPresentation"),"console"==t&&(presentationDivs[t].html(" > "+e+"<br>",!0),presentationDivs.console.elt.scrollTop=1e3*presentationDivs.console.html().length)}function doTutorials(e){if(jlog("Main","doTutorials"),1==tutorial){let t=!0;try{t=window.self==window.top}catch(e){t=!0}if(1==t){let e=createDiv('<a href="https://b38tn1k.com/code/ux/2022/09/08/blocks-explained/"> back to tutorial </a>');e.style("font-size","16px"),textSize(16),e.position(windowWidth-textWidth(" back to tutorial "),windowHeight-40)}switch(tutorialstring){case"#tutorialBlank":break;case"#tutorialHello":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),loadCells(demos[0]),cells.cells[0].reshape(),cells.cells[0].refresh(),1==zoomMode?(tidyFlag=0,cells.cells[1].x=cells.cells[0].x,cells.cells[1].y=cells.cells[0].y+cells.cells[0].height+2*cells.cells[0].handleH):setTidyFlag(),cells.run=!0,e=!0;break;case"#tutorialHandles":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,cells.addCell(T_CONST,1.5*myDivs.menu.size().width),cells.cells[2].mode=M_IDLE,cells.cells[2].x=windowWidth/2-cells.cells[2].width/2,cells.cells[2].y=windowHeight/2-cells.cells[2].height/2,cells.cells[2].specialLayer=createGraphics(3*cells.cells[2].width,3*cells.cells[2].height);let t=parseInt(fontSizeString.slice(0,2));cells.cells[2].specialLayer.textSize(t);let l=cells.cells[2].specialLayer.width/2,i=cells.cells[2].specialLayer.height/2,s=cells.cells[2].width/2,h=cells.cells[2].height/2,o=2*t,n=int(l-s-o-cells.cells[2].specialLayer.textWidth("move")),c=int(i-h);cells.cells[2].specialLayer.text("move",n,c),n=int(l+s+o),c=int(i-h),cells.cells[2].specialLayer.text("delete",n,c),n=int(l+s+o),c=int(i),cells.cells[2].specialLayer.text("copy",n,c),n=int(l+s+o),c=int(i+h+t),cells.cells[2].specialLayer.text("resize",n,c),n=int(l-s-o-cells.cells[2].specialLayer.textWidth("mutate")),c=int(i+h+t),cells.cells[2].specialLayer.text("mutate",n,c),n=int(l),c=int(i+h+o),cells.cells[2].specialLayer.textAlign(CENTER,CENTER),cells.cells[2].specialLayer.text("expand/collapse",n,c),e=!0,hideMenu=!0,disableDrag=!0;break;case"#tutorialMove":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),hideMenu=!0,e=!0,disableDrag=!0,cells.addCell(T_COMMENT,.25*windowWidth),cells.addCell(T_BLOCK,.75*windowWidth),cells.addCell(T_CONST,.5*windowWidth),cells.cells[2].mode=M_IDLE,cells.cells[3].mode=M_IDLE,cells.cells[4].mode=M_IDLE,cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,cells.cells[2].x-=cells.cells[2].width/2,cells.cells[3].x-=cells.cells[3].width/2,cells.cells[4].x-=cells.cells[4].width/2,cells.cells[2].input.value("can't drop on me"),cells.cells[3].updateHandleSH("drop on me!"),cells.cells[4].input.value("drag me"),cells.cells[2].disableDelete(),cells.cells[3].disableDelete(),cells.cells[4].disableDelete();break;case"#tutorialMutate":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,hideMenu=!0,e=!0,disableDrag=!0,cells.addCell(T_ADD,.5*windowWidth),cells.cells[2].x-=cells.cells[2].width/2,cells.addCell(T_CONST,.5*windowWidth),cells.cells[4].input.value(1),cells.addCell(T_CONST,.5*windowWidth),cells.cells[5].input.value(2),cells.addCell(T_CONST,.5*windowWidth),cells.cells[6].input.value(3),cells.cells[2].addChild(4,cells.cells[4]),cells.cells[2].addChild(5,cells.cells[5]),cells.cells[2].addChild(6,cells.cells[6]),cells.cells[4].addParent(2,cells.cells[2]),cells.cells[5].addParent(2,cells.cells[2]),cells.cells[6].addParent(2,cells.cells[2]);for(let e=0;e<cells.length;e++)cells.cells[e].disableDelete(),cells.cells[e].mode=M_IDLE;break;case"#tutorialCopy":cells.addCell(T_START,1.5*myDivs.menu.size().width),cells.addCell(T_CONSOLE,windowWidth-2.5*cells.dWidth),cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,hideMenu=!0,e=!0,disableDrag=!0,cells.addCell(T_SUBTRACT,.7*windowWidth),cells.cells[2].x-=cells.cells[2].width/2,cells.addCell(T_CONST,.2*windowWidth),cells.cells[4].input.value(1),cells.addCell(T_CONST,.2*windowWidth),cells.cells[5].input.value(2),cells.addCell(T_CONST,.2*windowWidth),cells.cells[6].input.value(3),cells.cells[2].addChild(4,cells.cells[4]),cells.cells[2].addChild(5,cells.cells[5]),cells.cells[2].addChild(6,cells.cells[6]),cells.cells[4].addParent(2,cells.cells[2]),cells.cells[5].addParent(2,cells.cells[2]),cells.cells[6].addParent(2,cells.cells[2]),cells.addCell(T_INPUT,.2*windowWidth),cells.cells[7].updateHandleSH("Reference me!"),cells.cells[7].x-=.5*cells.cells[7].width,cells.addCell(T_CONST,.2*windowWidth),cells.cells[8].input.value("Copy me!"),cells.cells[8].x-=.5*cells.cells[8].width,cells.cells[8].y+=cells.cells[7].height+2*cells.cells[7].handleH,cells.addCell(T_BLOCK,.2*windowWidth),cells.cells[9].updateHandleSH("Reference me!"),cells.cells[9].x-=.5*cells.cells[9].width,cells.cells[9].y+=cells.cells[8].y+cells.cells[8].height+2*cells.cells[8].handleH,cells.addCell(T_CONST,.25*windowWidth),cells.cells[9].addChild(10,cells.cells[10]),cells.cells[10].addParent(9,cells.cells[9]),cells.cells[10].input.value("inside a block");for(let e=0;e<cells.length;e++)cells.cells[e].disableDelete(),cells.cells[e].mode=M_IDLE;break;case"#tutorialData":cells.addCell(T_START,10),cells.addCell(T_CONSOLE,10),hideMenu=!0,e=!0,cells.addCell(T_CONST,.5*windowWidth),cells.cells[cells.length-1].input.value("I am useless"),cells.addCell(T_INPUT,.5*windowWidth),cells.cells[cells.length-1].input.value("I am eternal"),cells.mapAndLink(),cells.addCell(T_PRINT,.5*windowWidth),cells.cells[0].addChild(cells.length-2,cells.cells[cells.length-2]);let a=cells.length;cells.addCell(T_BLOCK,.5*windowWidth),cells.addCell(T_GOTO,.5*windowWidth),cells.addCell(T_CONST,0),cells.addCell(T_CONST,0),cells.mapAndLink(),cells.cells[5].updateHandleSH(cells.cells[3].handleSH),cells.cells[7].updateHandleSH(cells.cells[6].handleSH),cells.cells[a].addChild(a+2,cells.cells[a+2]),cells.cells[a+2].addParent(a,cells.cells[a]),cells.cells[a].addChild(a+3,cells.cells[a+3]),cells.cells[a+3].addParent(a,cells.cells[a]),cells.cells[a+2].input.value("I'm ok"),cells.cells[a+3].input.value("me too");let d=cells.length;cells.addCell(T_PRINT,.5*windowWidth),cells.cells[0].addChild(cells.length-2,cells.cells[cells.length-2]),cells.cells[cells.length-2].addChild(a+1,cells.cells[cells.length-2]),cells.activeIndex=cells.length-1,cells.doDelete(),cells.mapAndLink(),cells.cells[d].addChild(a+1,cells.cells[a+1]),cells.cells[a+1].addParent(d,cells.cells[d]);for(let e=0;e<cells.length;e++)cells.cells[e].disableDelete(),cells.cells[e].mode=M_IDLE;cells.tidy(0,10)}}return e}function checkAnOrUpdateTutorial(){if(jlog("Main","checkAnOrUpdateTutorial"),1==tutorial)switch(tutorialstring){case"#tutorialBlank":break;case"#tutorialHello":demoIndex=0;break;case"#tutorialHandles":cells.length<3&&(cells.cells[0].x=2*windowWidth,cells.cells[1].x=2*windowWidth,cells.addCell(T_CONST,.5*windowWidth),cells.cells[2].mode=M_IDLE,cells.cells[2].x-=cells.cells[0].width/2),cells.cells[2].x=max(cells.cells[2].x,0),cells.cells[2].x=min(cells.cells[2].x,windowWidth-20),cells.cells[2].y=max(cells.cells[2].y,0),cells.cells[2].y=min(cells.cells[2].y,windowHeight-5),cells.cells[2].viewX=max(cells.cells[2].viewX,0),cells.cells[2].viewX=min(cells.cells[2].viewX,windowWidth-20),cells.cells[2].viewY=max(cells.cells[2].viewY,0),cells.cells[2].viewY=min(cells.cells[2].viewY,windowHeight-5),cells.cells[2].updateAllDivPositions();break;case"#tutorialMove":for(let e=2;e<5;e++)cells.cells[e].x=max(cells.cells[e].x,0),cells.cells[e].x=min(cells.cells[e].x,windowWidth-20),cells.cells[e].y=max(cells.cells[e].y,0),cells.cells[e].y=min(cells.cells[e].y,windowHeight-5),cells.cells[e].viewX=max(cells.cells[e].viewX,0),cells.cells[e].viewX=min(cells.cells[e].viewX,windowWidth-20),cells.cells[e].viewY=max(cells.cells[e].viewY,0),cells.cells[e].viewY=min(cells.cells[e].viewY,windowHeight-5),cells.cells[e].updateAllDivPositions();break;case"#tutorialMutate":for(let e=2;e<7;e++)cells.cells[e].x=max(cells.cells[e].x,0),cells.cells[e].x=min(cells.cells[e].x,windowWidth-20),cells.cells[e].y=max(cells.cells[e].y,0),cells.cells[e].y=min(cells.cells[e].y,windowHeight-5),cells.cells[e].viewX=max(cells.cells[e].viewX,0),cells.cells[e].viewX=min(cells.cells[e].viewX,windowWidth-20),cells.cells[e].viewY=max(cells.cells[e].viewY,0),cells.cells[e].viewY=min(cells.cells[e].viewY,windowHeight-5),cells.cells[e].updateAllDivPositions();break;case"#tutorialCopy":for(let e=2;e<11;e++)cells.cells[e].x=max(cells.cells[e].x,0),cells.cells[e].x=min(cells.cells[e].x,windowWidth-20),cells.cells[e].y=max(cells.cells[e].y,0),cells.cells[e].y=min(cells.cells[e].y,windowHeight-5),cells.cells[e].viewX=max(cells.cells[e].viewX,0),cells.cells[e].viewX=min(cells.cells[e].viewX,windowWidth-20),cells.cells[e].viewY=max(cells.cells[e].viewY,0),cells.cells[e].viewY=min(cells.cells[e].viewY,windowHeight-5),cells.cells[e].updateAllDivPositions();break;case"#tutorialData":millis()<1e4&&(cells.cells[5].updateHandleSH(cells.cells[3].handleSH),cells.cells[7].updateHandleSH(cells.cells[6].handleSH));for(let e=2;e<cells.length;e++)cells.cells[e].x=max(cells.cells[e].x,0),cells.cells[e].x=min(cells.cells[e].x,windowWidth-20),cells.cells[e].y=max(cells.cells[e].y,0),cells.cells[e].y=min(cells.cells[e].y,windowHeight-5),cells.cells[e].viewX=max(cells.cells[e].viewX,0),cells.cells[e].viewX=min(cells.cells[e].viewX,windowWidth-20),cells.cells[e].viewY=max(cells.cells[e].viewY,0),cells.cells[e].viewY=min(cells.cells[e].viewY,windowHeight-5),cells.cells[e].updateAllDivPositions()}}function testAll(){for(jlog("Main","testAll");1!=speedMode;)toggleSpeedMode();testTimer=TST_LOAD,currentTestIndex=-1,testPacer=millis()}function colorToHTMLRGB(e){return jlog("Main","colorToHTMLRGB"),"rgb("+e._getRed()+", "+e._getGreen()+", "+e._getBlue()+")"}function toggleInput(e,t){jlog("Main","toggleInput"),console.log("functionality removed to tools/refactor")}function jlog(e,t){-1==["length","tidy","startStop","stop","toggleStartForm","resizeConsole","updateView","moveC","updateAllDivPositions","updateDivPosition","reshape","refresh"].indexOf(t)&&1==(doJLOG=doJLOGCountDown>0)&&(console.debug("frame: "+frameCount,e,t),logCounter+=1,doJLOGCountDown-=1,100==logCounter&&console.clear())}function whatsLeft(){jlog("Main","whatsLeft");for(let e=0;e<55;e++)-1==everyone.indexOf(e)&&console.log("FREE:",e)}function deviceTurned(){jlog("Main","deviceTurned"),setupScreen()}function windowResized(){jlog("Main","windowResized"),setupScreen(),cells.updateView(xPos,yPos,doMouseDrag),redrawCounter=2}function inClickableZone(){let e=!0;return mouseX>noClickZone[0]&&mouseX<noClickZone[1]&&mouseY>noClickZone[2]&&mouseY<noClickZone[3]&&(e=!1),e}function mousePressed(){frameRate(100),jlog("Main","mousePressed"),1==mobileDeviceDetected&&1==mobileHAddon?newCell(mobileHType,mouseX,mouseY):(!0===inClickableZone()?runMode==RM_NORMAL?doMouseDrag=!cells.checkSelected(mouseX,mouseY):runMode==RM_CREATE&&(doMouseDrag=!pres.checkSelected(mouseX,mouseY)):doMouseDrag=!1,1==doMouseDrag&&(xStart=mouseX,yStart=mouseY))}function preload(){jlog("Main","preload"),c=loadStrings("assets/nintendo-entertainment-system.hex"),demos.push(loadJSON("assets/helloworld.json")),demos.push(loadJSON("assets/demo1.json")),demos.push(loadJSON("assets/demo2.json")),demos.push(loadJSON("assets/demo3.json")),demos.push(loadJSON("assets/demo4.json")),demos.push(loadJSON("assets/demo5.json")),demos.push(loadJSON("assets/demo6.json")),demos.push(loadJSON("assets/demo7.json")),demos.push(loadJSON("assets/demo8.json")),demos.push(loadJSON("assets/demo9.json")),demos.push(loadJSON("assets/demo10.json")),demos.push(loadJSON("assets/demo11.json")),demos.push(loadJSON("assets/demo12.json")),demos.push(loadJSON("assets/demo13.json")),demos.push(loadJSON("assets/demo14.json")),demos.push(loadJSON("assets/demo15.json")),demos.push(loadJSON("assets/wip-demo.json"))}function setup(){jlog("Main","setup"),-1!=getURL().indexOf("##")&&(showGUI=!1,presentationMode=!0,runMode=RM_PRESENT),pixelDensity(1),mainDiv=document.getElementById("main"),myDivs.devDiv=createDiv(),colorSetup(),setupScreen(),cells=new Cells(allColors.colors,allColors.highlights,allColors.lowlights,allColors.icolors,allColors.dtcolors),pres=new Cells(allColors.colors,allColors.highlights,allColors.lowlights,allColors.icolors,allColors.dtcolors),mobileSettings(),controller=new Controller,myDivs.menu=createDiv(),createMenuDiv(),xOff=0,yOff=0,xPos=0,yPos=0,showDev=!showDev,showDevDiv(),doLastBit(),1==autoStart&&(cells.run=!0,fastMode=1),pres.addCellsForPres(cells.cells),pres.createMode=!0}function draw(){if(notIdle=focused||cells.redrawFlag||cells.run||controller.tidyFlag||testTimer!=TST_OFF||tidyFlag>0||frameCount<100,fpsSetValue=1==notIdle?30:5,0!=redrawCounter&&clear(),runMode==RM_NORMAL){if(1==showFPS&&controller.d_print(frameRate().toFixed(2),!0,"<br>FPS: "),0!=tutorial||0==scrollX&&0==scrollY||(window.scrollTo(0,0),cells.updateView(xPos,yPos,!1),cells.rebuildMenuFlag=!0),1==notIdle&&(mouseDrag(),cells.updateView(xPos,yPos,doMouseDrag)),0!=redrawCounter&&(drawGrid(),cells.draw(),redrawCounter-=1),1!=cells.redrawFlag&&1!=cells.run||(redrawCounter=2),1==notIdle&&cells.update(mouseX,mouseY,mouseIsPressed),0!=redrawCounter&&controller.update(cells,flash,fastMode),1==controller.tidyFlag&&(setTidyFlag(),controller.tidyFlag=!1),1==cells.run&&1==slowMode?frameRate(5):0!=redrawCounter?frameRate(100):frameRate(fpsSetValue),tidyFlag>0&&(tidy(),cells.updateView(xPos,yPos,!0),tidyFlag-=1),1==cells.rebuildMenuFlag&&(myDivs.menu.remove(),myDivs.menu=createDiv(),createMenuDiv(),cells.rebuildMenuFlag=!1),testTimer!=TST_OFF){let e=millis()-testPacer>testPaceSettings[testTimer];if(0==cells.run&&1==e)switch(testTimer){case TST_LOAD:(currentTestIndex+=1)==demos.length-1?1==testLoop?currentTestIndex=0:testTimer=TST_OFF:(testPacer=millis(),loadCells(demos[currentTestIndex]),setTidyFlag(),testTimer=TST_TIDY);break;case TST_TIDY:testPacer=millis(),testTimer=TST_RUN;break;case TST_RUN:testPacer=millis(),cells.run=!0,testTimer=TST_PAUSE;break;case TST_PAUSE:testPacer=millis(),testTimer=TST_LOAD}}checkAnOrUpdateTutorial()}else runMode==RM_CREATE?(0!=redrawCounter&&(redrawCounter-=1,drawGrid(),pres.draw()),1==notIdle&&(mouseDrag(),pres.update(mouseX,mouseY,mouseIsPressed),pres.updateView(xPos,yPos,doMouseDrag)),tidyFlag>0&&(tidy(),noClickZone=[10,myDivs.presTools.size().width+10,10,pixelDensity*myDivs.presTools.size().height+10],pres.updateView(xPos,yPos,!0),tidyFlag-=1),1==pres.redrawFlag&&(redrawCounter=2)):runMode==RM_PRESENT&&controller.update(cells,flash,fastMode)}
