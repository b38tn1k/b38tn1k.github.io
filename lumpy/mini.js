var colors=["#0f0","#ff0","#0ff","#f0f","#fff","#f00","#00f","#0f0"];function rcol(){return colors[int(random(colors.length))]}function rcolsub(e){return e[int(random(e.length))]}function coin(){return random(1)>.5}function randint(e){return random(e)}var shootNow=!1;function keyPressed(){showtext=!1,"i"==key&&saveImage()," "==key&&(shootNow=!0),"c"==key&&(rearCannon=!rearCannon)}function saveImage(){var e=year()+nf(month(),2)+nf(day(),2)+"-"+nf(hour(),2)+nf(minute(),2)+nf(second(),2);save(e+".png")}let gameMap=[];var mapHeight,mapWidth=200,pixelSize=5;function newMap(){mapWidth=width/pixelSize,mapHeight=height/pixelSize+2;for(var e=0;e<mapWidth;e++){gameMap[e]=[];for(var i=0;i<mapHeight;i++){let t=noise(.03*e,.03*i);gameMap[e][i]=t}}drawMap(newColor=!0),placePlayer()}let bg,fg,mapCanvas=null,obstacle=.55;function shuffleColors(){for(bg=rcol(),fg=rcol();fg==bg;)fg=rcol()}function drawMap(e=!1){1==e?shuffleColors():mapCanvas.remove(),noStroke(),(mapCanvas=createGraphics(window.innerWidth,window.innerHeight)).background(bg),mapCanvas.fill(fg),mapCanvas.stroke(fg);for(var i=0;i<mapWidth;i++)for(var t=0;t<mapHeight;t++)gameMap[i][t]>obstacle&&mapCanvas.square(i*pixelSize,t*pixelSize,pixelSize)}var showtext=!0;let my_sprite,spriteWidth=8,spriteHeight=5;function makeSprite(){my_sprite=null,my_sprite=genSprite(spriteWidth,spriteHeight)}function genSprite(e,i){let t=createGraphics((e+2)*pixelSize,2*i*pixelSize);t.background=bg;let a=rcol();for(;a==bg;)a=rcol();t.fill(a),t.stroke(a);let r=i,n=e;for(var s=new Array,h=0,o=0;o<r;o++){s[o]=new Array;for(var l=0;l<n;l++)s[o][l]=random(2),s[o][l]=s[o][l]+sin(radians(90*o/r)),s[o][l]=s[o][l]+sin(radians(l/n*180)),s[o][l]>h&&(h=s[o][l])}var p=0,m=0;for(o=0;o<r;o++)for(l=0;l<n;l++)s[o][l]=s[o][l]/h,p+=s[o][l],m++;var c=p/m,y=0,d=0;for(o=0;o<r;o++){for(l=0;l<n;l++)s[o][l]>c&&t.rect(y,d,pixelSize,pixelSize),d+=pixelSize;d=0,y+=pixelSize}var f=int(r)-1;for(o=0;o<r;o++){for(l=0;l<n;l++)s[f-o][l]>c&&t.rect(y,d,pixelSize,pixelSize),d+=pixelSize;d=0,y+=pixelSize}return t}let playerX=10,playerY=10;function placePlayer(){for(playerX=int(random(10,mapWidth-10)),playerY=int(random(10,mapHeight-10));gameMap[playerX][playerY]>obstacle;)playerX=int(random(10,mapWidth-10)),playerY=int(random(10,mapHeight-10))}var canvas;let tc;function setup(){for(canvas=createCanvas(window.innerWidth,window.innerHeight),smooth(8),pixelDensity(2),background(rcol()),newMap(),makeSprite(),makeFrenemies(),tc=rcol();tc==bg||tc==fg;)tc=rcol()}function mouseClicked(){}class Frenemy{constructor(){for(this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10)),this.alive=!0;gameMap[this.x][this.y]>obstacle;)this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10));this.counter=0,this.sprite=genSprite(5,3),this.xrand=int(random(-2,2)),this.yrand=int(random(-2,2))}clean(){this.sprite.remove(),this.sprite=null}checkShot(e,i){e>this.x&&e<this.x+5&&i>this.y&&i<this.y+6&&(this.alive=!1)}checkTouch(e,i){return e>this.x-spriteWidth&&e<this.x+spriteWidth&&i>this.y-spriteHeight&&i<this.y+spriteHeight&&(this.alive=!1,!0)}update(){this.counter%int(random(3,5))==0&&(this.xrand=int(random(-2,2)),this.yrand=int(random(-2,2))),this.counter++;let e=this.x,i=this.y;this.x+=this.xrand,this.y+=this.yrand,this.x<0&&(this.x=0),this.x>mapWidth-spriteWidth&&(this.x=mapWidth-spriteWidth),this.y<0&&(this.y=0),this.y>mapHeight-1.5*spriteHeight&&(this.y=mapHeight-1.5*spriteHeight),(gameMap[this.x][this.y]>obstacle||gameMap[this.x+5][this.y+6]>obstacle||gameMap[this.x+5][this.y]>obstacle||gameMap[this.x][this.y+6]>obstacle||gameMap[this.x+2][this.y+3]>obstacle||gameMap[this.x+2][this.y]>obstacle)&&(this.x=e,this.y=i)}draw(){image(this.sprite,this.x*pixelSize,this.y*pixelSize)}}class Bullet{constructor(e,i,t){for(this.x=e,this.y=i,this.direction=t,this.alive=!0,this.health=5,this.col=rcol();this.col==bg;)this.col=rcol()}update(){this.y=this.y+this.direction[0],this.y=this.y-this.direction[1],this.x=this.x+this.direction[2],this.x=this.x-this.direction[3],(this.x<0||this.y<0||this.x>=mapWidth||this.y>=mapHeight)&&(this.alive=!1),0==this.health&&(this.alive=!1),1==this.alive&&gameMap[this.x][this.y]>obstacle&&(gameMap[this.x][this.y]=0,this.health--,0==this.health&&this.x>2&&this.x<mapWidth-2&&this.y>2&&this.y<mapHeight-2&&(gameMap[this.x+1][this.y-1]=0,gameMap[this.x-1][this.y-1]=0,gameMap[this.x-1][this.y+1]=0,gameMap[this.x-1][this.y]=0,gameMap[this.x][this.y-1]=0,gameMap[this.x+1][this.y+1]=0,gameMap[this.x][this.y+1]=0,gameMap[this.x+1][this.y]=0),drawMap())}draw(){fill(this.col),stroke(this.col),square(this.x*pixelSize,this.y*pixelSize,pixelSize)}}function makeFrenemies(){frenemies=[];for(var e=0;e<frenemyCount;e++)frenemies.push(new Frenemy)}let bullets=[],frenemies=[],frenemyCount=10,direction=[1,0,0,0],rearCannon=!0;function draw(){clear(),frameRate(10);let e=playerX,i=playerY;(keyIsDown(UP_ARROW)||keyIsDown(87))&&(playerY--,direction=1==rearCannon?[1,0,0,0]:[0,1,0,0]),(keyIsDown(DOWN_ARROW)||keyIsDown(83))&&(playerY++,direction=1==rearCannon?[0,1,0,0]:[1,0,0,0]),(keyIsDown(LEFT_ARROW)||keyIsDown(65))&&(playerX--,direction=1==rearCannon?[0,0,1,0]:[0,0,0,1]),(keyIsDown(RIGHT_ARROW)||keyIsDown(68))&&(playerX++,direction=1==rearCannon?[0,0,0,1]:[0,0,1,0]),keyIsDown(82)&&(my_sprite.remove(),makeSprite());let t=playerX+spriteWidth/2+1,a=playerY+spriteHeight-1;if(gameMap[t][a]>obstacle&&(playerX=e,playerY=i),keyIsDown(16)&&(gameMap[t][a]=1,drawMap()),keyIsDown(32)&&1==shootNow&&(bullets.push(new Bullet(t,a,direction)),shootNow=!1),playerX<0&&(playerX=0),playerX>mapWidth-spriteWidth&&(playerX=mapWidth-spriteWidth),playerY<0&&(playerY=0),playerY>mapHeight-1.5*spriteHeight&&(playerY=mapHeight-1.5*spriteHeight),bullets.length>0){for(var r=0;r<bullets.length;r++){for(var n=0;n<frenemyCount;n++)frenemies[n].checkShot(bullets[r].x,bullets[r].y);bullets[r].update()}let e=[];for(r=0;r<bullets.length;r++)1==bullets[r].alive&&e.push(bullets[r]);bullets=[];for(r=0;r<e.length;r++)bullets[r]=e[r]}for(r=0;r<frenemyCount;r++)0==frenemies[r].alive&&(frenemies[r].clean(),frenemies[r]=new Frenemy),frenemies[r].update(),1==frenemies[r].checkTouch(t,a)&&(my_sprite.remove(),makeSprite());image(mapCanvas,0,0),image(my_sprite,playerX*pixelSize,playerY*pixelSize);for(r=0;r<frenemyCount;r++)frenemies[r].draw();if(bullets.length>0)for(r=0;r<bullets.length;r++)bullets[r].draw();if(1==showtext){fill(tc);let e="WASD to move\n\nLEFT SHIFT to build\n\nSPACE to shoot\n\nC to switch cannon direction\n\nR for a new sprite\n\nRefresh to see this again...\n\nPress any key";textSize(30),text(e,50,50)}}function touchStarted(){}function touchMoved(){return!1}function touchEnded(){}function deviceTurned(){canvas=null,canvas=createCanvas(window.innerWidth,window.innerHeight)}window.onresize=function(){width=window.innerWidth,height=window.innerHeight,mapCanvas.remove(),my_sprite.remove();for(var e=0;e<frenemyCount;e++)frenemies[e].clean();canvas=null,canvas=createCanvas(window.innerWidth,window.innerHeight),newMap(),makeSprite(),placePlayer(),makeFrenemies()};
