let mapHeight,bg,fg,my_sprite,canvas,tc,herd,colors=["#0f0","#ff0","#0ff","#f0f","#fff","#f00","#00f","#0f0"],gameMap=[],mapWidth=200,pixelSize=5,shootNow=!1,mapCanvas=null,obstacle=.55,showtext=!0,spriteWidth=8,spriteHeight=5,playerX=10,playerY=10,bullets=[],frenemies=[],frenemyCount=10,direction=[1,0,0,0],rearCannon=!0;function rcol(){return colors[int(random(colors.length))]}function rcolsub(e){return e[int(random(e.length))]}function coin(){return random(1)>.5}function randint(e){return random(e)}function keyPressed(){if("h"==key){for(tc=rcol();tc==bg||tc==fg;)tc=rcol();showtext=!0}else showtext=!1;"i"==key&&saveImage()," "==key&&(shootNow=!0),"c"==key&&(rearCannon=!rearCannon)}function saveImage(){var e=year()+nf(month(),2)+nf(day(),2)+"-"+nf(hour(),2)+nf(minute(),2)+nf(second(),2);save(e+".png")}function newMap(){mapWidth=width/pixelSize,mapHeight=height/pixelSize+2;for(var e=0;e<mapWidth;e++){gameMap[e]=[];for(var t=0;t<mapHeight;t++){let i=noise(.03*e,.03*t);gameMap[e][t]=i}}drawMap(newColor=!0),placePlayer()}function shuffleColors(){for(bg=rcol(),fg=rcol();fg==bg;)fg=rcol()}function drawMap(e=!1){1==e?shuffleColors():mapCanvas.remove(),noStroke(),(mapCanvas=createGraphics(window.innerWidth,window.innerHeight)).background(bg),mapCanvas.fill(fg),mapCanvas.stroke(fg);for(var t=0;t<mapWidth;t++)for(var i=0;i<mapHeight;i++)gameMap[t][i]>obstacle&&mapCanvas.square(t*pixelSize,i*pixelSize,pixelSize)}function makeSprite(){my_sprite=null;let e=rcol();for(;e==bg;)e=rcol();my_sprite=genSprite(spriteWidth,spriteHeight,e)}function genSprite(e,t,i){let r=createGraphics((e+2)*pixelSize,2*t*pixelSize);r.background=bg,r.fill(i),r.stroke(i);let a=t,s=e;for(var h=new Array,n=0,o=0;o<a;o++){h[o]=new Array;for(var l=0;l<s;l++)h[o][l]=random(2),h[o][l]=h[o][l]+sin(radians(90*o/a)),h[o][l]=h[o][l]+sin(radians(l/s*180)),h[o][l]>n&&(n=h[o][l])}var p=0,c=0;for(o=0;o<a;o++)for(l=0;l<s;l++)h[o][l]=h[o][l]/n,p+=h[o][l],c++;var d=p/c,m=0,y=0;for(o=0;o<a;o++){for(l=0;l<s;l++)h[o][l]>d&&r.rect(m,y,pixelSize,pixelSize),y+=pixelSize;y=0,m+=pixelSize}var g=int(a)-1;for(o=0;o<a;o++){for(l=0;l<s;l++)h[g-o][l]>d&&r.rect(m,y,pixelSize,pixelSize),y+=pixelSize;y=0,m+=pixelSize}return r}function placePlayer(){for(playerX=int(random(10,mapWidth-10)),playerY=int(random(10,mapHeight-10));gameMap[playerX][playerY]>obstacle;)playerX=int(random(10,mapWidth-10)),playerY=int(random(10,mapHeight-10))}function deviceTurned(){canvas=null,canvas=createCanvas(window.innerWidth,window.innerHeight)}function setup(){for(canvas=createCanvas(window.innerWidth,window.innerHeight),smooth(8),pixelDensity(2),background(rcol()),newMap(),makeSprite(),herd=new Herd(10),frenemies=herd.herd,tc=rcol();tc==bg||tc==fg;)tc=rcol()}function draw(){clear(),frameRate(10);let e=playerX,t=playerY;(keyIsDown(UP_ARROW)||keyIsDown(87))&&(playerY--,direction=1==rearCannon?[1,0,0,0]:[0,1,0,0]),(keyIsDown(DOWN_ARROW)||keyIsDown(83))&&(playerY++,direction=1==rearCannon?[0,1,0,0]:[1,0,0,0]),(keyIsDown(LEFT_ARROW)||keyIsDown(65))&&(playerX--,direction=1==rearCannon?[0,0,1,0]:[0,0,0,1]),(keyIsDown(RIGHT_ARROW)||keyIsDown(68))&&(playerX++,direction=1==rearCannon?[0,0,0,1]:[0,0,1,0]),keyIsDown(82)&&(my_sprite.remove(),makeSprite());let i=playerX+spriteWidth/2+1,r=playerY+spriteHeight-1;if(gameMap[i][r]>obstacle&&(playerX=e,playerY=t),keyIsDown(16)&&(gameMap[i][r]=1,drawMap()),keyIsDown(32)&&1==shootNow&&(bullets.push(new Bullet(i,r,direction)),shootNow=!1),playerX<0&&(playerX=0),playerX>mapWidth-spriteWidth&&(playerX=mapWidth-spriteWidth),playerY<0&&(playerY=0),playerY>mapHeight-1.5*spriteHeight&&(playerY=mapHeight-1.5*spriteHeight),bullets.length>0){for(var a=0;a<bullets.length;a++)herd.checkShot(bullets[a].x,bullets[a].y),bullets[a].update();let e=[];for(a=0;a<bullets.length;a++)1==bullets[a].alive&&e.push(bullets[a]);bullets=[];for(a=0;a<e.length;a++)bullets[a]=e[a]}if(herd.update(i,r),image(mapCanvas,0,0),image(my_sprite,playerX*pixelSize,playerY*pixelSize),herd.draw(),bullets.length>0)for(a=0;a<bullets.length;a++)bullets[a].draw();if(1==showtext){fill(tc);let e="[WASD] to move\n[LEFT SHIFT] to build\n[SPACE] to shoot\n[C] to switch cannon direction\n[R] for a new sprite\n[H] to see this again\nPress any key to play",t="YOU ARE THE BIG ONE\nYOU FLOAT IN LUMPY SPACE WITH THE LITTLE ONES\nWHEN A LITTLE ONE DIES,\nTHE TWO OLDEST HAVE A BABY\nSOMETIMES THEY MUTATE";textSize(50),text(t,50,50),textSize(20),text(e,50,350)}}window.onresize=function(){width=window.innerWidth,height=window.innerHeight,mapCanvas.remove(),my_sprite.remove();for(var e=0;e<frenemyCount;e++)frenemies[e].clean();canvas=null,canvas=createCanvas(window.innerWidth,window.innerHeight),newMap(),makeSprite(),placePlayer(),herd=new Herd(10),frenemies=herd.herd};class Frenemy{constructor(){for(this.color=rcol();this.color==bg;)this.color=rcol();for(this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10)),this.alive=!0;gameMap[this.x][this.y]>obstacle;)this.x=int(random(10,mapWidth-10)),this.y=int(random(10,mapHeight-10));this.counter=0,this.sprite=genSprite(5,3,this.color),this.xrand=int(random(-2,2)),this.yrand=int(random(-2,2)),this.builder=random(),this.escaper=random(),this.seeker=random()}inherit(e,t,i,r){this.sprite.remove(),this.color=r,this.sprite=genSprite(5,3,this.color)}clean(){this.sprite.remove(),this.sprite=null}checkShot(e,t){e>this.x&&e<this.x+5&&t>this.y&&t<this.y+6&&(this.alive=!1)}checkTouch(e,t){return e>this.x-spriteWidth&&e<this.x+spriteWidth&&t>this.y-spriteHeight&&t<this.y+spriteHeight&&(this.alive=!1,!0)}randomWalk(){this.counter%int(random(3,5))==0&&(this.xrand=int(random(-2,2)),this.yrand=int(random(-2,2))),this.counter++,this.x+=this.xrand,this.y+=this.yrand}update(){let e=this.x,t=this.y;this.randomWalk(),this.x<0&&(this.x=0),this.x>mapWidth-spriteWidth&&(this.x=mapWidth-spriteWidth),this.y<0&&(this.y=0),this.y>mapHeight-1.5*spriteHeight&&(this.y=mapHeight-1.5*spriteHeight),(gameMap[this.x][this.y]>obstacle||gameMap[this.x+5][this.y+6]>obstacle||gameMap[this.x+5][this.y]>obstacle||gameMap[this.x][this.y+6]>obstacle||gameMap[this.x+2][this.y+3]>obstacle||gameMap[this.x+2][this.y]>obstacle)&&(this.x=e,this.y=t)}draw(){image(this.sprite,this.x*pixelSize,this.y*pixelSize)}}class Bullet{constructor(e,t,i){for(this.x=e,this.y=t,this.direction=i,this.alive=!0,this.health=5,this.col=rcol(),this.counter=0;this.col==bg;)this.col=rcol()}update(){this.counter++,this.y=this.y+this.direction[0],this.y=this.y-this.direction[1],this.x=this.x+this.direction[2],this.x=this.x-this.direction[3],(this.x<0||this.y<0||this.x>=mapWidth||this.y>=mapHeight)&&(this.alive=!1),0==this.health&&(this.alive=!1),1==this.alive&&gameMap[this.x][this.y]>obstacle&&(gameMap[this.x][this.y]=0,this.health--,0==this.health&&this.x>2&&this.x<mapWidth-2&&this.y>2&&this.y<mapHeight-2&&(gameMap[this.x+1][this.y-1]=0,gameMap[this.x-1][this.y-1]=0,gameMap[this.x-1][this.y+1]=0,gameMap[this.x-1][this.y]=0,gameMap[this.x][this.y-1]=0,gameMap[this.x+1][this.y+1]=0,gameMap[this.x][this.y+1]=0,gameMap[this.x+1][this.y]=0),drawMap())}draw(){fill(this.col),stroke(this.col),square(this.x*pixelSize,this.y*pixelSize,pixelSize)}}class Herd{constructor(e){this.mutation_liklihood=.3,this.count=e,this.herd=[];for(var t=0;t<e;t++)this.herd.push(new Frenemy)}checkShot(e,t){for(var i=0;i<this.count;i++)this.herd[i].checkShot(e,t)}update(e,t){for(var i=0;i<this.count;i++){if(0==this.herd[i].alive){this.herd[i].clean(),this.herd[i]=new Frenemy;let e=this.herd[0],t=this.herd[1];for(var r=0;r<this.count;r++)this.herd[r].counter>e.counter?e=this.herd[r]:this.herd[r].counter>t.counter&&(t=this.herd[r]);let a=lerpColor(color(e.color),color(t.color),.5);random()>this.mutation_liklihood&&(a=lerpColor(color(a),color(rcol()),.5)),this.herd[i].inherit(0,0,0,a)}this.herd[i].update(),1==this.herd[i].checkTouch(e,t)&&(my_sprite.remove(),makeSprite())}}draw(){for(var e=0;e<this.count;e++)this.herd[e].draw()}}
